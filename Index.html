<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåü</text></svg>">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Enable full‚Äëscreen mode on iOS devices and use a translucent status bar.  Adding these meta tags improves
       the experience when the app is saved to the home screen on iPhones and iPads. -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Mila ‚Äì Universo de Sue√±os</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lato&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body class="overflow-x-hidden overflow-y-auto text-gray-100 stars">
  <!-- SPLASH SCREEN -->
  <div id="splash-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center gap-6 bg-[#0c0a18]">
    <h1 id="splash-greeting" class="text-4xl sm:text-6xl font-cinzel text-white opacity-0 transition-opacity duration-1000">Para Mila</h1>
    <h2 id="splash-welcome" class="text-2xl sm:text-4xl font-cinzel text-yellow-300 opacity-0 transition-opacity duration-1000 delay-500">Un universo de sue√±os, forjado con amor.</h2>
    <button id="splash-start-btn" class="gemini-btn text-gray-900 font-bold py-2 px-6 rounded-lg opacity-0 transition-opacity duration-700 delay-[1100ms]">Comenzar</button>
  </div>

  <div id="app-container" class="opacity-0 transition-opacity duration-500 relative">
    <!-- VISTA PRINCIPAL -->
    <main id="main-view" class="view-container relative z-10 px-4 min-h-screen">
      <h1 class="text-[34px] sm:text-6xl text-center font-cinzel text-white mb-4 glow">Mapa de Sue√±os</h1>
      <section id="cosmos" class="relative w-full min-h-[70vh]"></section>
      <button id="add-dream-btn" class="fixed right-4 sm:right-8 bg-yellow-300 text-gray-900 rounded-full w-14 h-14 sm:w-16 sm:h-16 flex items-center justify-center text-3xl sm:text-4xl shadow-lg hover:bg-yellow-400 transition-transform hover:scale-110 z-30" style="bottom: calc(var(--footer-height) + 1rem);">+</button>
      <!-- Genio m√°gico: bot√≥n de deseos en el cosmos -->
      <button id="cosmos-wish-btn" class="absolute left-1/2 bottom-20 transform -translate-x-1/2 bg-transparent text-5xl z-40 transition-transform duration-300 hover:scale-110" title="Pedir un deseo">üßû‚Äç‚ôÇÔ∏è</button>
    </main>

    <!-- PERFIL DE LUZ -->
    <div id="perfil-de-luz-view" class="view-container hidden p-4 w-full">
      <h2 class="text-3xl font-cinzel text-center mb-6">Or√°culo del Perfil de Luz</h2>
      <div class="max-w-3xl mx-auto">
        <div class="mb-4 flex gap-4">
          <select id="profile-select" class="w-full bg-gray-700 p-2 rounded text-white"></select>
          <button id="add-profile-btn" class="bg-green-500 text-white px-4 py-2 rounded text-sm hover:bg-green-600">Nuevo</button>
        </div>
        <div id="profile-form-container" class="mb-4 bg-gray-800/50 p-4 rounded-lg"></div>
        <div class="flex border-b border-gray-700 mb-4 overflow-x-auto">
          <button data-tab="numerology" class="tab-btn active p-2 flex-shrink-0">Numerolog√≠a</button>
          <button data-tab="humandesign" class="tab-btn p-2 flex-shrink-0">Dise√±o Humano</button>
          <button data-tab="compatibility" class="tab-btn p-2 flex-shrink-0">Compatibilidad</button>
          <button data-tab="message" class="tab-btn p-2 flex-shrink-0">Mensaje de Luz</button>
        </div>
        <div id="numerology-tab-content" class="tab-content"></div>
        <div id="humandesign-tab-content" class="tab-content hidden p-4 bg-gray-800/50 rounded-lg"></div>
        <div id="compatibility-tab-content" class="tab-content hidden p-4 bg-gray-800/50 rounded-lg"></div>
        <div id="message-tab-content" class="tab-content hidden p-4 bg-gray-800/50 rounded-lg"></div>
      </div>
    </div>

    <!-- DIARIO -->
    <div id="journal-view" class="view-container hidden p-4 w-full">
      <h2 class="text-3xl font-cinzel text-center mb-6">Diario de Sue√±os</h2>
      <div class="max-w-2xl mx-auto">
        <div class="flex border-b border-gray-700 mb-4">
          <button data-tab="gratitude" class="tab-btn active p-2">Gratitud</button>
          <button data-tab="dreams" class="tab-btn p-2">Sue√±os Nocturnos</button>
        </div>
        <div id="gratitude-tab-content" class="tab-content">
          <!-- Gamificaci√≥n: muestra el contador de racha de gratitud -->
          <div id="streak-display" class="text-sm text-yellow-200/80 mb-3"></div>
          <textarea id="journal-entry" class="w-full bg-gray-700 p-2 rounded h-24 mb-3" placeholder="Escribe aqu√≠ por lo que est√°s agradecida..."></textarea>
          <button id="save-journal-entry" class="bg-yellow-300 text-gray-900 px-4 py-2 rounded mb-4">Guardar Gratitud</button>
          <h3 class="text-xl font-cinzel text-yellow-200 mb-2">Entradas Anteriores</h3>
          <ul id="journal-list" class="space-y-2 text-yellow-200"></ul>
        </div>
        <div id="dreams-tab-content" class="tab-content hidden">
          <textarea id="dream-journal-entry" class="w-full bg-gray-700 p-2 rounded h-24 mb-3" placeholder="Describe tu sue√±o aqu√≠..."></textarea>
          <button id="interpret-dream-btn" class="gemini-btn text-gray-900 font-bold py-2 px-4 rounded-lg text-sm mb-4">‚ú® Interpretar S√≠mbolos</button>
          <div id="dream-interpretation-result" class="mt-4 text-sm p-4 bg-gray-900/50 rounded hidden"></div>
        </div>
      </div>
    </div>

    <!-- BIBLIOTECA -->
    <div id="library-view" class="view-container hidden p-4 w-full">
      <div class="max-w-2xl mx-auto">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-3xl font-playfair">Biblioteca de Luz</h2>
          <button id="add-book-btn" class="bg-green-500 text-white px-4 py-2 rounded text-sm hover:bg-green-600">A√±adir Libro</button>
        </div>
        <div class="mb-4">
          <h3 class="text-xl font-playfair text-yellow-200 mb-2">Buscar Nuevos Libros</h3>
          <div class="flex gap-2">
            <input type="text" id="book-search-input" class="w-full bg-gray-700 p-2 rounded" placeholder="Ej: El Kybalion...">
            <button id="book-search-btn" class="gemini-btn text-gray-900 font-bold py-2 px-4 rounded-lg text-sm">Buscar</button>
          </div>
          <div id="book-search-results" class="mt-4 space-y-2"></div>
        </div>
        <ul id="book-list" class="space-y-2 text-yellow-200"></ul>
        <input type="file" id="add-book-input" class="hidden" accept=".pdf" />
      </div>
    </div>

    <!-- CICLOS -->
    <div id="cycles-view" class="view-container hidden p-4 w-full">
      <h2 class="text-3xl font-cinzel text-center mb-6">Portal de Ciclos</h2>
      <div class="max-w-2xl mx-auto">
        <textarea id="cycle-description" class="w-full bg-gray-700 p-2 rounded h-24 mb-3" placeholder="Describe el ciclo que deseas cerrar o transformar..."></textarea>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <button id="hooponopono-btn" class="bg-pink-500 text-white font-bold py-2 px-4 rounded-lg">Santuario de Ho'oponopono</button>
          <button id="quantum-btn" class="bg-purple-500 text-white font-bold py-2 px-4 rounded-lg">Visualizaci√≥n Cu√°ntica</button>
        </div>
        <div id="cycle-healing-result" class="mt-4 text-sm p-4 bg-gray-900/50 rounded hidden"></div>
      </div>
    </div>

    <!-- ABUNDANCIA (BILLETERA DE LUZ) -->
    <div id="abundance-view" class="view-container hidden p-4 w-full">
      <h2 class="text-3xl font-playfair text-center mb-6">Portal de Abundancia</h2>
      <p class="text-center text-yellow-200/80 max-w-2xl mx-auto mb-6 text-sm">Recuerda: la abundancia es tu estado natural. El dinero es solo una forma de energ√≠a, un puente para materializar tus sue√±os. Manifiesta desde el sentimiento de merecimiento y gratitud.</p>
      
      <div class="max-w-2xl mx-auto">
        <!-- TABS -->
        <div class="flex border-b border-gray-700 mb-4 justify-center">
          <button data-tab="billetera" class="tab-btn active p-3">Billetera de Luz</button>
          <button data-tab="cheque" class="tab-btn p-3">Cheque C√≥smico</button>
          <button data-tab="galeria-abundancia" class="tab-btn p-3">Galer√≠a de Visi√≥n</button>
        </div>

        <!-- CONTENT: BILLETERA -->
        <div id="billetera-tab-content" class="tab-content space-y-8">
          <!-- Wallet Card -->
          <div class="wallet-card p-6 rounded-2xl shadow-2xl space-y-4">
              <div class="flex justify-between items-center">
                  <span class="font-playfair text-yellow-200">Balance Total</span>
                  <span class="text-2xl light-coin-icon">‚ú®</span>
              </div>
              <div class="text-4xl font-bold tracking-wider" id="wallet-balance">0.00 LC</div>
              <div class="text-xs text-yellow-200/70">LC = Moneda de Luz</div>
          </div>
          <!-- Request Form -->
          <div class="bg-gray-800/50 p-6 rounded-lg">
              <h3 class="text-xl font-playfair text-center text-yellow-200 mb-4">Solicitar al Universo</h3>
              <div class="space-y-4">
                  <div>
                      <label for="abundance-amount" class="block text-yellow-200 text-sm font-bold mb-2">Monto (LC):</label>
                      <input type="number" id="abundance-amount" class="shadow appearance-none border rounded w-full py-2 px-3 bg-gray-700 text-white" placeholder="Ej: 5000">
                  </div>
                  <div>
                      <label for="abundance-purpose" class="block text-yellow-200 text-sm font-bold mb-2">Intenci√≥n / Prop√≥sito:</label>
                      <input type="text" id="abundance-purpose" class="shadow appearance-none border rounded w-full py-2 px-3 bg-gray-700 text-white" placeholder="Ej: Para nuestro viaje so√±ado">
                  </div>
                  <div class="text-center pt-2">
                      <button id="request-abundance-btn" class="gemini-btn text-gray-900 font-bold py-3 px-8 rounded-lg w-full">Enviar Pedido C√≥smico</button>
                  </div>
              </div>
          </div>
          <!-- Transaction History -->
          <div>
              <h3 class="text-xl font-playfair text-yellow-200 mb-2">Bandeja de Entrada C√≥smica</h3>
              <div id="transaction-history" class="bg-gray-800/50 p-4 rounded-lg max-h-96 overflow-y-auto space-y-4">
                  <!-- Transactions will be rendered here -->
              </div>
          </div>
        </div>

        <!-- CONTENT: CHEQUE COSMICO -->
        <div id="cheque-tab-content" class="tab-content hidden p-4 bg-gray-800/50 rounded-lg">
            <div id="cosmic-check" class="bg-gradient-to-br from-gray-900 to-blue-900/50 border-2 border-yellow-400 p-6 rounded-lg shadow-2xl relative overflow-hidden font-serif">
                <div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-10"></div>
                <div class="flex justify-between items-center border-b-2 border-yellow-400 pb-2 mb-4">
                    <h3 class="font-playfair text-2xl text-yellow-300">Banco del Universo</h3>
                    <span class="text-xs text-yellow-300">Fecha: <span id="cheque-date"></span></span>
                </div>
                <div class="flex items-end gap-4 mb-4">
                    <span class="text-yellow-200">P√°guese a la orden de:</span>
                    <input id="cheque-payee" type="text" class="flex-grow bg-transparent border-b border-dashed border-yellow-300 text-white text-lg focus:outline-none" value="El portador de esta consciencia">
                </div>
                <div class="flex items-center gap-4 mb-6">
                    <span class="text-yellow-200">La suma de:</span>
                    <input id="cheque-amount" type="text" class="flex-grow bg-transparent border-b border-dashed border-yellow-300 text-white text-2xl focus:outline-none" placeholder="Escribe el monto en n√∫meros...">
                    <span class="text-yellow-200">$</span>
                </div>
                <div class="mb-8">
                    <label class="text-yellow-200 text-sm">En letras:</label>
                    <p id="cheque-amount-text" class="text-white italic h-6 border-b border-dashed border-yellow-300"></p>
                </div>
                <div class="flex justify-between items-end">
                    <div>
                        <label class="text-yellow-200 text-sm">Intenci√≥n:</label>
                        <input id="cheque-memo" type="text" class="w-full bg-transparent border-b border-dashed border-yellow-300 text-white focus:outline-none" placeholder="Para mi m√°s alto bien...">
                    </div>
                    <div class="text-center">
                        <input id="cheque-signature" type="text" class="w-48 bg-transparent border-b-2 border-yellow-400 text-white text-2xl font-playfair text-center focus:outline-none" placeholder="Tu Firma">
                        <label class="text-yellow-200 text-xs block">Firma de Aceptaci√≥n</label>
                    </div>
                </div>
            </div>
            <div class="text-center mt-6">
                <button id="submit-cosmic-check" class="gemini-btn text-gray-900 font-bold py-3 px-8 rounded-lg">Sellar y Enviar al Cosmos</button>
            </div>
        </div>
        
        <!-- CONTENT: GALERIA DE ABUNDANCIA -->
        <div id="galeria-abundancia-tab-content" class="tab-content hidden p-4 bg-gray-800/50 rounded-lg">
            <h3 class="text-xl font-playfair text-center text-yellow-200 mb-4">Crea la Visi√≥n de tu Abundancia</h3>
            <div class="flex gap-2 mb-4">
                <input id="abundance-gallery-prompt" type="text" class="w-full bg-gray-700 p-2 rounded" placeholder="Describe tu deseo materializado...">
                <button id="generate-abundance-image-btn" class="gemini-btn text-gray-900 font-bold py-2 px-4 rounded-lg text-sm whitespace-nowrap">‚ú® Crear Visi√≥n</button>
            </div>
            <div id="abundance-gallery-grid" class="gallery-grid mt-4">
                <!-- Abundance images will be rendered here -->
            </div>
        </div>

      </div>
    </div>

    <!-- AJUSTES -->
    <div id="ajustes-view" class="view-container hidden p-4 w-full">
      <h2 class="text-3xl font-cinzel text-center mb-6">Ajustes</h2>
      <div class="max-w-2xl mx-auto space-y-6">
        <div>
          <h3 class="text-xl font-cinzel text-yellow-200 mb-2">Mensajes Subliminales</h3>
          <div class="flex items-center mb-2">
            <input type="checkbox" id="subliminal-toggle" class="form-checkbox h-5 w-5 text-yellow-300 bg-gray-800 border-gray-600 rounded focus:ring-yellow-400" />
            <label for="subliminal-toggle" class="ml-2">Mostrar mensajes subliminales</label>
          </div>
          <textarea id="subliminal-messages-editor" class="w-full bg-gray-700 p-2 rounded h-40"></textarea>
          <button id="save-subliminal-btn" class="bg-yellow-300 text-gray-900 px-4 py-2 rounded mt-2">Guardar Mensajes</button>
        </div>
        <div>
            <h3 class="text-xl font-cinzel text-yellow-200 mb-2">Duraci√≥n del Slideshow</h3>
            <div class="flex items-center gap-4">
                <input type="range" id="slideshow-duration" min="2" max="15" value="5" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                <span id="slideshow-duration-label" class="text-yellow-200 font-bold">5s</span>
            </div>
        </div>
        <div>
          <h3 class="text-xl font-cinzel text-yellow-200 mb-2">M√∫sica C√≥smica</h3>
          <ul id="audio-list" class="space-y-2 text-yellow-200"></ul>
          <div class="flex items-center gap-3 mt-2">
            <button id="add-audio-btn" class="bg-green-500 text-white px-4 py-2 rounded text-sm hover:bg-green-600">A√±adir Canci√≥n</button>
            <input type="file" id="add-audio-input" class="hidden" accept=".mp3">
          </div>
        </div>
        <div>
          <h3 class="text-xl font-cinzel text-yellow-200 mb-2">Sincronizaci√≥n Universal</h3>
          <div class="flex flex-wrap gap-4">
            <button id="export-data-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg">Exportar Universo</button>
            <button id="import-data-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg">Importar Universo</button>
            <button id="restore-backup-btn" class="bg-yellow-500 text-gray-900 font-bold py-2 px-4 rounded-lg">Restaurar Backup</button>
            <input type="file" id="import-file-input" class="hidden" accept=".milaverse,application/json">
          </div>
          <p id="last-backup-info" class="text-xs text-gray-500 mt-2">√öltimo auto-backup: Nunca</p>
        </div>
        <div class="text-center text-xs text-gray-500 pt-8">
          <p>Hecho con amor y c√≥digo por Miguelangel para el ser de luz m√°s incre√≠ble del universo.</p>
        </div>
      </div>
    </div>

    <!-- MODAL DETALLE SUE√ëO -->
    <div id="dream-view" class="view-container hidden fixed inset-0 bg-gray-900/90 backdrop-blur-sm z-50 overflow-y-auto p-4 pt-6 w-full">
      <div class="max-w-4xl mx-auto pb-32">
        <div class="flex justify-between items-center mb-4">
          <div class="flex items-center gap-2">
            <h2 id="dream-view-title" class="text-3xl sm:text-5xl font-cinzel text-white glow"></h2>
            <!-- Bot√≥n de edici√≥n de nombre con icono de l√°piz -->
            <button id="edit-dream-name-btn" type="button" class="text-yellow-300 hover:text-white p-1" title="Editar nombre del sue√±o">
              <!-- √çcono de l√°piz -->
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 11l6.536-6.536a1.5 1.5 0 012.121 0l2.879 2.879a1.5 1.5 0 010 2.121L14 16l-5 1 1-5z"></path></svg>
            </button>
          </div>
          <button id="close-dream-view-btn" class="text-gray-400 hover:text-white">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
          </button>
        </div>
        
        <div class="mb-6 bg-gray-800/50 p-4 rounded-lg">
          <h3 class="text-lg font-cinzel text-yellow-200 mb-2">Paso 1: La Galer√≠a Visual</h3>
          <div id="dream-media-gallery" class="gallery-grid mt-4"></div>
          <input type="file" id="upload-media-input" class="hidden" accept="image/*,video/*" multiple>
          <div class="flex gap-2 mt-4">
            <button id="select-media-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg text-sm">A√±adir a Galer√≠a</button>
            <button id="paste-media-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Pegar Imagen</button>
            <button id="download-gallery-zip-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Descargar todo (.zip)</button>
          </div>
        </div>

        <div class="mb-6 bg-gray-800/50 p-4 rounded-lg">
          <h3 class="text-lg font-cinzel text-yellow-200 mb-2">Paso 2: Asistente Co-creativo de Atuendos</h3>
          
          <!-- INSTRUCTIONS -->
          <div id="co-creator-instruction" class="relative text-xs text-gray-400 mb-4 p-3 bg-gray-900/50 rounded-lg border-l-2 border-yellow-400">
            <p><strong>1. Describe tu idea.</strong> <strong>2. Ref√≠nala con IA.</strong> <strong>3. Construye el prompt</strong> combinando todo. <strong>4. Genera.</strong></p>
            <button onclick="this.parentElement.style.display='none'" class="absolute top-2 right-2 text-red-400">[x]</button>
          </div>

          <!-- SELECTIONS -->
          <!-- Primera fila de selecciones: Personajes, Estilo de Ropa y Estilo Art√≠stico -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
              <label class="block text-sm mb-2 font-bold text-yellow-100">Personajes</label>
              <div id="image-character-selection" class="flex flex-wrap gap-2"></div>
            </div>
            <div>
              <label class="block text-sm mb-2 font-bold text-yellow-100">Estilo de Ropa</label>
              <div id="clothing-style-selection" class="flex flex-wrap gap-2">
                <button data-style="Formal" class="style-btn bg-gray-700 hover:bg-yellow-700/50 text-white text-sm py-1 px-3 rounded-full transition-colors">Formal</button>
                <button data-style="Casual" class="style-btn bg-gray-700 hover:bg-yellow-700/50 text-white text-sm py-1 px-3 rounded-full transition-colors">Casual</button>
                <button data-style="Old money" class="style-btn bg-gray-700 hover:bg-yellow-700/50 text-white text-sm py-1 px-3 rounded-full transition-colors">Old money</button>
                <button data-style="Deportivo" class="style-btn bg-gray-700 hover:bg-yellow-700/50 text-white text-sm py-1 px-3 rounded-full transition-colors">Deportivo</button>
              </div>
            </div>
            <div>
              <label class="block text-sm mb-2 font-bold text-yellow-100">Estilo Art√≠stico</label>
              <div id="art-style-selection" class="flex flex-wrap gap-2">
                <button data-style="Cinematic, Photorealistic, High Detail, 8k" class="art-style-btn bg-gray-700 hover:bg-yellow-700/50 text-white text-sm py-1 px-3 rounded-full transition-colors">Cinem√°tico</button>
                <button data-style="Anime" class="art-style-btn bg-gray-700 hover:bg-yellow-700/50 text-white text-sm py-1 px-3 rounded-full transition-colors">Anime</button>
                  <button data-style="Collage" class="art-style-btn bg-gray-700 hover:bg-yellow-700/50 text-white text-sm py-1 px-3 rounded-full transition-colors">Collage</button>
                <button data-style="Pixar" class="art-style-btn bg-gray-700 hover:bg-yellow-700/50 text-white text-sm py-1 px-3 rounded-full transition-colors">Pixar</button>
              </div>
            </div>
          </div>

          <!-- Segunda fila de selecciones: Paleta de Colores y Emoci√≥n -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm mb-2 font-bold text-yellow-100">Paleta de Colores</label>
              <div id="color-selection" class="flex flex-wrap gap-2">
                <button data-color="Vibrante" class="color-style-btn bg-gray-700 hover:bg-yellow-700/50 text-white text-sm py-1 px-3 rounded-full transition-colors">Vibrante</button>
                <button data-color="Pastel" class="color-style-btn bg-gray-700 hover:bg-yellow-700/50 text-white text-sm py-1 px-3 rounded-full transition-colors">Pastel</button>
                <button data-color="Oscuro" class="color-style-btn bg-gray-700 hover:bg-yellow-700/50 text-white text-sm py-1 px-3 rounded-full transition-colors">Oscuro</button>
                <button data-color="Luminoso" class="color-style-btn bg-gray-700 hover:bg-yellow-700/50 text-white text-sm py-1 px-3 rounded-full transition-colors">Luminoso</button>
              </div>
            </div>
            <div>
              <label class="block text-sm mb-2 font-bold text-yellow-100">Emoci√≥n</label>
              <div id="emotion-selection" class="flex flex-wrap gap-2">
                <button data-emotion="Amor" class="emotion-style-btn bg-gray-700 hover:bg-yellow-700/50 text-white text-sm py-1 px-3 rounded-full transition-colors">Amor</button>
                <button data-emotion="Paz" class="emotion-style-btn bg-gray-700 hover:bg-yellow-700/50 text-white text-sm py-1 px-3 rounded-full transition-colors">Paz</button>
                <button data-emotion="Felicidad" class="emotion-style-btn bg-gray-700 hover:bg-yellow-700/50 text-white text-sm py-1 px-3 rounded-full transition-colors">Felicidad</button>
                <button data-emotion="Aventura" class="emotion-style-btn bg-gray-700 hover:bg-yellow-700/50 text-white text-sm py-1 px-3 rounded-full transition-colors">Aventura</button>
              </div>
            </div>
          </div>

          <!-- SCENE DESCRIPTION & REFINE -->
          <div class="mb-4">
            <label class="block text-sm mb-1 font-bold text-yellow-100">Describe la escena o idea base:</label>
            <textarea id="dream-scene-description" class="w-full bg-gray-700 p-2 rounded" rows="2" placeholder="Ej: en una noche estrellada..."></textarea>
            <button id="refine-description-btn" class="gemini-btn text-gray-900 font-bold py-2 px-4 rounded-lg text-sm w-full mt-2">‚ú® Refinar Descripci√≥n con IA</button>
          </div>
          
          <!-- PROMPT VARIATIONS -->
          <div id="prompt-variations-container" class="mt-4 border-t border-yellow-500/20 pt-4 hidden">
            <h4 class="block text-sm mb-2 font-bold text-yellow-100">Elige tu Intenci√≥n Favorita</h4>
            <p class="text-xs text-gray-400 mb-2">Selecciona una de las 6 intenciones generadas por la IA. Ser√° traducida a ingl√©s para la generaci√≥n.</p>
            <div id="prompt-variations-grid" class="grid grid-cols-2 md:grid-cols-3 gap-2"></div>
            <button id="generate-from-variation-btn" class="gemini-btn text-gray-900 font-bold py-2 px-4 rounded-lg text-sm w-full mt-4 hidden">‚ú® Generar Imagen con Intenci√≥n Seleccionada</button>
          </div>

          <!-- FINAL PROMPT CONSTRUCTION -->
          <div id="final-prompt-container" class="mt-4 border-t border-yellow-500/20 pt-4">
             <label class="block text-sm mb-1 font-bold text-yellow-100">Prompt Final para la IA:</label>
             <p class="text-xs text-gray-400 mb-2">Este es el prompt completo que se usar√°. Incluye las descripciones f√≠sicas de los perfiles. Puedes editarlo manualmente.</p>
             <textarea id="final-prompt-for-ia" class="bg-gray-900 p-2 rounded w-full mt-2 h-32" placeholder="El prompt combinado final aparecer√° aqu√≠..."></textarea>
             <div class="flex gap-2 mt-2">
                <button id="translate-prompt-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg text-sm w-1/2">Traducir a Ingl√©s (Opcional)</button>
                <button id="generate-image-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg text-sm w-1/2">‚ú® Generar Imagen</button>
             </div>
          </div>
        </div>

        <div class="mb-6 bg-gray-800/50 p-4 rounded-lg text-center">
            <h3 class="text-lg font-cinzel text-yellow-200 mb-2">Paso 3: Manifestaci√≥n</h3>
            <button id="create-vision-board-btn" class="bg-gray-600 text-gray-400 font-bold py-3 px-6 rounded-lg cursor-not-allowed" disabled onclick="showNotification('Funci√≥n disponible pr√≥ximamente.', 'info')">Pr√≥ximamente: Mapa Visual</button>
        </div>

        <div class="mb-4">
          <h3 class="text-lg font-cinzel text-yellow-200 mb-2">Paso 4: Plan de Acci√≥n</h3>
          <ul id="dream-view-steps" class="space-y-2"></ul>
          <div class="mt-2 flex gap-2">
            <input id="new-step-input" type="text" class="bg-gray-700 p-2 rounded w-full" placeholder="A√±adir nuevo paso...">
            <button id="gemini-steps-btn" class="gemini-btn text-gray-900 font-bold py-2 px-4 rounded-lg text-sm transition-transform hover:scale-105 whitespace-nowrap">‚ú® Inspiraci√≥n M√°gica</button>
          </div>
          <div id="fulfill-dream-container" class="mt-6 text-center hidden">
            <button id="fulfill-dream-btn" class="bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold py-3 px-6 rounded-lg text-lg transition-transform hover:scale-105">¬°Manifestar Sue√±o!</button>
          </div>
        </div>

        <!-- M√≥dulo de Manifestaci√≥n S.P.E.C. -->
        <div class="mb-6 bg-gray-800/50 p-4 rounded-lg">
          <h3 class="text-lg font-cinzel text-yellow-200 mb-2">Manifestaci√≥n S.P.E.C.</h3>
          <div id="spec-module" class="space-y-4"></div>
        </div>
      </div>
    </div>
  </div>

    <!-- BARRA INFERIOR -->
    <div id="bottom-bar-container" class="fixed bottom-0 left-0 right-0 z-40 flex flex-col">
      <footer id="player-footer" class="bg-gray-900 bg-opacity-80 backdrop-blur-sm p-2 rounded-t-lg" style="position: fixed; bottom: calc(56px + var(--safe-inset-bottom)); left: 0; right: 0; touch-action: none;">
        <div class="max-w-4xl mx-auto flex items-center justify-between gap-4">
          <div id="current-song" class="text-yellow-300 text-sm truncate w-1/4"></div>
          <div class="flex items-center justify-center flex-grow gap-2">
            <button id="prev-btn" class="text-yellow-300 hover:text-white p-2">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M8.445 14.832A1 1 0 0010 14.03V5.97a1 1 0 00-1.555-.832L4.21 9.168a1 1 0 000 1.664l4.234 4.03zM15.555 14.832a1 1 0 001.555-.832V5.97a1 1 0 00-1.555-.832l-4.234 4.03a1 1 0 000 1.664l4.234 4.03z"></path></svg>
            </button>
            <audio id="global-audio-player" class="hidden"></audio>
            <button id="play-pause-btn" class="text-yellow-300 hover:text-white p-2">
              <svg id="play-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M4.52 16.89A1 1 0 013 15.97V4.03a1 1 0 011.52-.86l10.02 5.97a1 1 0 010 1.72l-10.02 5.97z"></path></svg>
              <svg id="pause-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M5 16h3V4H5v12zm7 0h3V4h-3v12z"></path></svg>
            </button>
            <button id="next-btn" class="text-yellow-300 hover:text-white p-2">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M11.555 5.168A1 1 0 0010 5.97v8.06a1 1 0 001.555.832l4.234-4.03a1 1 0 000-1.664l-4.234-4.03zM4.445 5.168A1 1 0 003 5.97v8.06a1 1 0 001.555.832l4.234-4.03a1 1 0 000 1.664L4.445 5.168z"></path></svg>
            </button>
          </div>
          <div class="w-1/3 flex justify-end items-center gap-2">
            <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.5" class="w-24 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
            <!-- Ocultamos el bot√≥n de bucle/lamparita en el reproductor -->
            <button id="loop-btn" class="text-yellow-300 hover:text-white p-2 hidden"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 00-1 1v2.101a7.002 7.002 0 0011.601 2.966a1 1 0 10-1.201-1.602A5.002 5.002 0 014 7.101V5a1 1 0 00-1-1H2a1 1 0 00-1 1v5a1 1 0 001 1h5a1 1 0 001-1V9a1 1 0 00-1-1H4.899A7.002 7.002 0 0016 9.899a1 1 0 101.602-1.201A9.002 9.002 0 012 12V4a1 1 0 00-1-1H0a1 1 0 00-1 1v.101a1 1 0 001 1h1V2a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg></button>
            <button id="quick-add-music-btn" class="text-yellow-300 hover:text-white p-2 ml-2">+</button>
          </div>
        </div>
        <div class="max-w-4xl mx-auto px-2 mt-1">
            <div id="progress-bar-container" class="w-full h-2 bg-gray-600 rounded-full cursor-pointer">
                <div id="progress-bar" class="h-full bg-yellow-400 rounded-full"></div>
            </div>
        </div>
      </footer>
      <nav id="main-nav-bar" class="bg-gray-900 bg-opacity-80 backdrop-blur-sm flex flex-row justify-around items-center text-yellow-300 p-2" style="padding-bottom: var(--safe-inset-bottom);">
        <button data-view="main" class="nav-btn flex flex-col items-center space-y-1"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg><span class="text-xs">Mapa</span></button>
        <button data-view="perfil-de-luz" class="nav-btn flex flex-col items-center space-y-1"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg><span class="text-xs">Perfil</span></button>
        <button data-view="abundance" class="nav-btn flex flex-col items-center space-y-1"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1m0-1H8.501M12 18v-1m0-1H8.501M12 6a9 9 0 100 12 9 9 0 000-12z"></path></svg><span class="text-xs">Abundancia</span></button>
        <button data-view="cycles" class="nav-btn flex flex-col items-center space-y-1"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg><span class="text-xs">Ciclos</span></button>
        <button data-view="journal" class="nav-btn flex flex-col items-center space-y-1"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13.5M12 6.253c-1.018 0-1.986.426-2.672 1.122L3 12l2.328 4.625c.686.696 1.654 1.122 2.672 1.122h4.995c1.018 0 1.986-.426 2.672-1.122L21 12l-2.328-4.625c-.686-.696-1.654-1.122-2.672-1.122H12z"></path></svg><span class="text-xs">Diario</span></button>
        <button data-view="library" class="nav-btn flex flex-col items-center space-y-1"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg><span class="text-xs">Biblioteca</span></button>
        <button data-view="ajustes" class="nav-btn flex flex-col items-center space-y-1"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg><span class="text-xs">Ajustes</span></button>
      </nav>
    </div>

    <!-- MODALES Y OVERLAYS -->
    <div id="dream-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden">
      <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
        <h3 class="text-2xl font-cinzel text-yellow-300 mb-4">Crear Nuevo Sue√±o</h3>
        <form id="dream-form">
          <div class="mb-4">
            <label class="block text-yellow-200 text-sm font-bold mb-2">Nombre:</label>
            <input type="text" name="name" class="shadow appearance-none border rounded w-full py-2 px-3 bg-gray-700 text-white" required>
            <!-- Sugerencias de nombre: se mostrar√° s√≥lo cuando el sue√±o actual no tenga nombre asignado -->
            <div id="dream-name-suggestions" class="mt-2 flex flex-wrap gap-2"></div>
          </div>
          <div class="mb-4"><label class="block text-yellow-200 text-sm font-bold mb-2">Color:</label><input type="color" name="color" value="#facc15" class="w-full h-10 p-1 bg-gray-700 border border-gray-600 rounded cursor-pointer"></div>
          <div class="mb-4"><label class="block text-yellow-200 text-sm font-bold mb-2">Tama√±o:</label><input type="range" name="size" min="40" max="120" value="80" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"></div>
          <div class="flex items-center justify-end space-x-4">
            <button id="cancel-dream-modal" type="button" class="text-gray-400 hover:text-white">Cancelar</button>
            <button type="submit" class="bg-yellow-300 hover:bg-yellow-400 text-gray-900 font-bold py-2 px-4 rounded">Guardar</button>
          </div>
        </form>
      </div>
    </div>

    <div id="book-viewer-modal" class="fixed inset-0 bg-black bg-opacity-90 z-[70] hidden p-4"></div>
    <div id="celebration-modal" class="fixed inset-0 z-[90] pointer-events-none hidden"></div>
    <div id="message-notification" class="fixed top-[-100px] left-1/2 -translate-x-1/2 bg-purple-500 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transition-all duration-500 z-[101]"></div>
    <div id="subliminal-container" class="fixed text-white pointer-events-none opacity-0 text-lg"></div>

    <div id="instructions-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[80] hidden p-4">
      <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md text-yellow-100 space-y-4">
        <h3 class="text-2xl font-cinzel text-yellow-300 mb-4 text-center">¬°Bienvenida a tu Universo!</h3>
        <p>Este es tu espacio sagrado para so√±ar y manifestar.</p>
        <ul class="list-disc list-inside space-y-2">
          <li>Cada <strong class="text-white">Planeta</strong> es un gran sue√±o. ¬°Haz clic en ellos para ver tus planes!</li>
          <li>Usa el bot√≥n <strong class="text-white">+</strong> para a√±adir nuevos sue√±os al cosmos.</li>
          <li>Descubre tu energ√≠a en el <strong class="text-white">Perfil de Luz</strong>.</li>
          <li>Pide <strong class="text-white">"Inspiraci√≥n M√°gica"</strong> para que un asistente te gu√≠e.</li>
        </ul>
        <div class="p-3 my-2 bg-yellow-900/50 border border-yellow-500 rounded-lg text-yellow-100 text-sm">
          <strong class="font-cinzel text-yellow-300">Un regalo de inicio:</strong>
          <p class="mt-1">Miguelo te ha preparado un archivo especial llamado <code>universo-inicial.milaverse</code> con libros, m√∫sica e im√°genes para comenzar. Cuando termines este tutorial, ve a <strong>Ajustes > Sincronizaci√≥n Universal</strong> y pulsa <strong>"Importar Universo"</strong> para cargarlo.</p>
        </div>
        <p class="text-center pt-2">¬°Cree en la magia y en ti!</p>
        <div class="flex justify-center mt-4">
          <button id="close-instructions-btn" class="bg-yellow-300 text-gray-900 font-bold py-2 px-6 rounded">Comenzar Viaje</button>
        </div>
      </div>
    </div>

    <!-- FALLBACK MODAL FOR IMAGE GENERATION -->
    <div id="fallback-modal" class="fixed inset-0 bg-black bg-opacity-70 flex-col items-center justify-center z-[80] hidden p-4">
      <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg text-center">
        <h3 class="text-2xl font-cinzel text-yellow-300 mb-4">El Asistente no Pudo Generar la Imagen</h3>
        <p class="text-yellow-100 mb-4">A veces el canal con el asistente se interrumpe. ¬°Pero no te preocupes! Aqu√≠ tienes tu prompt profesional, listo para usar en otras herramientas.</p>
        <div class="bg-gray-900 p-3 rounded-lg mb-4">
            <p class="text-left text-sm text-gray-400 mb-2">Copia este prompt completo y detallado:</p>
            <textarea id="fallback-prompt" class="w-full bg-gray-700 p-2 rounded text-white text-sm" rows="5" readonly></textarea>
        </div>
        <p class="text-yellow-100 mb-2">Prueba con alguna de estas herramientas gratuitas (se recomienda Whisk):</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
            <a href="https://labs.google/fx/es-419/tools/whisk" target="_blank" class="block w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Google FX (Whisk)</a>
            <a href="https://www.leonardo.ai/" target="_blank" class="block w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Leonardo.Ai</a>
            <a href="https://playgroundai.com/" target="_blank" class="block w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Playground AI</a>
            <a href="https://seaart.ai/" target="_blank" class="block w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">SeaArt.ai</a>
        </div>
        <button id="close-fallback-modal" class="mt-6 text-gray-400 hover:text-white bg-gray-700 px-4 py-2 rounded-lg">Cerrar Ventana</button>
      </div>
    </div>

    <!-- TEXT VIEWER MODAL -->
    <div id="text-viewer-modal" class="fixed inset-0 bg-black bg-opacity-70 flex-col items-center justify-center z-[80] hidden p-4">
      <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg text-center">
        <h3 id="text-viewer-title" class="text-2xl font-cinzel text-yellow-300 mb-4"></h3>
        <div id="text-viewer-content" class="text-left bg-gray-900 p-3 rounded-lg mb-4 text-yellow-100 max-h-[50vh] overflow-y-auto">
        </div>
        <button id="close-text-viewer-modal" class="mt-6 text-gray-400 hover:text-white bg-gray-700 px-4 py-2 rounded-lg">Cerrar</button>
      </div>
    </div>

    <!-- AYUDA IA: Bot√≥n flotante y panel lateral -->
    <!-- Bot√≥n de ayuda guIA reubicado a la izquierda -->
    <button id="help-ai-button" class="fixed z-50 left-4 bottom-[calc(180px+var(--safe-inset-bottom))] bg-yellow-400 text-gray-900 w-12 h-12 rounded-full shadow-lg flex items-center justify-center text-xl">?</button>
    <aside id="help-ai-panel" class="fixed top-0 right-0 h-full w-full sm:w-[360px] bg-gray-900/90 backdrop-blur-lg p-4 z-50 hidden">
      <!-- Encabezado de la guIA con bot√≥n de cierre -->
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-cinzel text-xl text-yellow-300 normal-case">guIA</h3>
        <!-- Bot√≥n de cierre corregido -->
        <button id="help-ai-close" class="text-yellow-300 hover:text-yellow-400 text-2xl font-bold leading-none">√ó</button>
      </div>
      <div id="help-ai-thread" class="space-y-3 max-h-[65vh] overflow-y-auto pr-2"></div>
      <div class="mt-3">
        <input id="help-ai-input" class="w-full bg-gray-800 p-2 rounded text-sm mb-2" placeholder="Preg√∫ntame c√≥mo hacer algo...">
        <button id="help-ai-send" class="gemini-btn text-gray-900 font-bold py-2 px-4 rounded-lg w-full text-sm">Preguntar</button>
      </div>
    </aside>

    <!-- Modal de tutorial externo para generaci√≥n con foto y prompt -->
    <div id="external-tutorial-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-[90] p-4">
      <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-3xl text-yellow-100">
        <h3 class="font-cinzel text-xl text-yellow-300 mb-4 text-center">Generar fuera (f√°cil y r√°pido)</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <p class="text-xs mb-2">1) Copia esta imagen y p√©gala en el editor.</p>
            <img id="ext-tutorial-img" class="rounded-lg w-full h-48 object-cover border border-gray-700" src="" alt="Imagen de referencia">
            <div class="flex gap-2 mt-2">
              <button id="copy-image-btn" class="gemini-btn text-gray-900 font-bold py-1 px-3 rounded text-xs flex-1">Copiar imagen</button>
              <button id="upload-result-btn" class="bg-purple-600 text-white font-bold py-1 px-3 rounded text-xs flex-1 hidden">Subir resultado</button>
            </div>
          </div>
          <div>
            <p class="text-xs mb-2">2) Copia este prompt:</p>
            <textarea id="ext-tutorial-prompt" class="w-full h-40 bg-gray-900 p-2 rounded text-sm text-white" readonly></textarea>
            <button id="copy-prompt-btn" class="gemini-btn text-gray-900 font-bold py-1 px-3 rounded text-xs w-full mt-2">Copiar prompt</button>
            <div class="mt-4 text-xs">
              <p class="mb-1">3) ¬øD√≥nde pegarlo?</p>
              <a id="open-gemini" class="block w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-lg text-center text-sm mb-1" href="#" target="_blank">Abrir Gemini (Recomendado)</a>
              <p class="text-xs italic mb-1">Suele respetar mejor los rostros con <span class="italic">google banana</span>.</p>
              <p class="text-xs">Opcionales: <a href="https://www.leonardo.ai/" target="_blank" class="underline text-blue-400">Leonardo</a>, <a href="https://playgroundai.com/" target="_blank" class="underline text-blue-400">Playground</a>, <a href="https://seaart.ai/" target="_blank" class="underline text-blue-400">SeaArt</a></p>
            </div>
          </div>
        </div>
        <div class="text-right mt-4">
          <button id="close-external-tutorial" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Cerrar</button>
        </div>
      </div>
    </div>

    <div id="context-menu" class="fixed bg-gray-900/80 backdrop-blur-sm rounded-lg shadow-lg z-50 hidden flex-col text-sm">
      <button data-action="edit" class="px-4 py-2 text-left hover:bg-gray-700 rounded-t-lg">Editar</button>
      <button data-action="delete" class="px-4 py-2 text-left text-red-400 hover:bg-gray-700 rounded-b-lg">Eliminar</button>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex-col items-center justify-center z-[80] hidden p-4">
      <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
        <p id="confirm-message" class="mb-4">¬øEst√°s seguro?</p>
        <div class="flex justify-center gap-4">
          <button id="confirm-cancel" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded">Cancelar</button>
          <button id="confirm-ok" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded">Confirmar</button>
        </div>
      </div>
    </div>

    <!-- Modal para mensaje de la l√°mpara m√°gica en el cosmos -->
    <div id="cosmos-wish-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-[90] p-4">
      <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md text-center text-yellow-100">
        <p class="mb-4">No atraemos lo que deseamos sino lo que somos. ¬øQu√© quieres ser para atraer lo que deseas?</p>
        <!-- A√±adimos un contenedor con dos botones: Continuar y Cerrar -->
        <div class="flex flex-col items-center gap-3">
          <button id="wish-continue-btn" onclick="openAffirmationFromWish()" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">
            Continuar
          </button>
          <button id="close-wish-modal" class="bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold py-2 px-4 rounded">
            Cerrar
          </button>
        </div>
      </div>
    </div>

    <div id="vision-board-editor" class="fixed inset-0 z-[95] hidden flex-col">
        <!-- Main Toolbar -->
        <div class="flex-shrink-0 bg-gray-800 p-2 flex justify-between items-center shadow-lg">
            <div class="flex items-center gap-2">
                <button id="vb-add-text-btn" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">A√±adir Texto</button>
                <button id="vb-add-sticker-btn" class="bg-purple-500 text-white px-3 py-1 rounded text-sm hover:bg-purple-600">A√±adir Sticker</button>
            </div>
            <h3 class="font-cinzel text-yellow-200">Editor del Mapa de Sue√±os Visual</h3>
            <div class="flex items-center gap-2">
                <button id="vb-download-btn" class="bg-yellow-500 text-gray-900 px-3 py-1 rounded text-sm hover:bg-yellow-400">Descargar</button>
                <button id="vb-close-btn" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">Cerrar</button>
            </div>
        </div>
        <!-- Contextual Toolbar -->
        <div id="vb-context-toolbar" class="absolute top-16 left-1/2 -translate-x-1/2 z-[96] bg-gray-900/80 backdrop-blur-sm p-2 rounded-lg shadow-xl flex items-center gap-2 hidden">
             <input id="vb-edit-prompt" type="text" class="bg-gray-700 p-2 rounded w-64 text-sm" placeholder="Edita la imagen con un prompt..."/>
             <button id="vb-edit-btn" class="gemini-btn text-gray-900 font-bold py-2 px-4 rounded-lg text-sm">Editar con IA</button>
        </div>

        <div class="flex-grow flex overflow-hidden">
            <!-- Side Palette -->
            <div id="vb-palette" class="w-56 bg-gray-900/70 p-2 overflow-y-auto flex-shrink-0 flex flex-col">
                <h4 class="font-cinzel text-center text-yellow-300 mb-2">Galer√≠a</h4>
                <div id="vb-image-palette" class="flex-grow space-y-2"></div>
                <h4 class="font-cinzel text-center text-yellow-300 my-2">Stickers</h4>
                <div id="vb-sticker-palette" class="grid grid-cols-3 gap-2"></div>
            </div>
            <!-- Canvas Area -->
            <div class="flex-grow p-4 overflow-auto" id="vb-canvas-container">
                <div id="vision-board-canvas" class="relative w-[1920px] h-[1080px] bg-gray-700 scale-50 origin-top-left">
                    <!-- Vision board items go here -->
                </div>
            </div>
        </div>
        <!-- Onboarding Tutorial -->
        <div id="vb-tutorial" class="absolute inset-0 bg-black/80 z-[97] flex-col items-center justify-center p-8 text-center hidden">
            <h2 class="text-3xl font-cinzel text-yellow-300 mb-4">¬°Bienvenida al Editor de Mapas!</h2>
            <p class="mb-2">Arrastra im√°genes y stickers desde la paleta de la izquierda hacia el lienzo.</p>
            <p class="mb-2">Usa los botones de arriba para a√±adir texto o descargar tu creaci√≥n.</p>
            <p class="mb-6">¬°Selecciona un elemento para ver m√°s opciones!</p>
            <button id="vb-close-tutorial" class="bg-yellow-300 text-gray-900 font-bold py-2 px-6 rounded">¬°Entendido!</button>
        </div>
    </div>

    <!-- MEDIA VIEWER MODAL -->
    <div id="media-viewer-modal" class="fixed inset-0 bg-black bg-opacity-90 z-[100] hidden flex-col items-center justify-center p-4">
      <div class="absolute top-4 right-4 flex gap-2 z-10">
        <button id="viewer-fullscreen-btn" class="text-white bg-black/50 rounded-full p-2 hover:bg-gray-700 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1v4m0 0h-4m4 0l-5-5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 0h-4m4 0l-5 5"></path></svg>
        </button>
        <button id="close-media-viewer-btn" class="text-white bg-black/50 rounded-full p-2 hover:bg-gray-700 transition-colors">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>

      <div class="relative w-full h-full flex flex-col items-center justify-center">
        <div class="relative w-full flex-grow flex items-center justify-center cursor-zoom-in" id="viewer-content-area">
            <img id="viewer-img" class="max-w-full max-h-full object-contain hidden opacity-0">
            <video id="viewer-video" class="max-w-full max-h-full object-contain hidden opacity-0" muted></video>
            <div id="viewer-particles" class="absolute inset-0 pointer-events-none hidden"></div>
        </div>
        <div id="viewer-edit-controls" class="flex-shrink-0 p-4 w-full max-w-3xl flex gap-2 items-center">
            <input id="viewer-edit-prompt" type="text" class="bg-gray-700 p-2 rounded w-full text-sm" placeholder="Edita la imagen con un prompt... (ej: 'a√±ade un efecto de acuarela')"/>
            <button id="viewer-edit-btn" class="gemini-btn text-gray-900 font-bold py-2 px-4 rounded-lg text-sm whitespace-nowrap">Editar con IA</button>
        </div>
      </div>

      <div class="absolute bottom-24 left-0 right-0 flex justify-center items-center gap-4">
        <button id="viewer-prev-btn" class="text-white bg-black/50 rounded-full p-3 hover:bg-gray-700 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        </button>
        <button id="viewer-loop-btn" class="text-white bg-black/50 rounded-full p-3 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 4l16 16"></path></svg>
        </button>
        <button id="viewer-shuffle-btn" class="text-white bg-black/50 rounded-full p-3 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
        </button>
        <button id="viewer-next-btn" class="text-white bg-black/50 rounded-full p-3 hover:bg-gray-700 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        </button>
      </div>
    </div>


  <script>
    // =================================================================================
    // --- APP INITIALIZATION & CORE LOGIC ---
    // =================================================================================
    
    // --- Entry Point ---
    window.addEventListener('load', main);
    window.addEventListener('unhandledrejection', e => console.error('[UNHANDLEDREJECTION]', e.reason));

    // --- IndexedDB Database Wrapper ---
    const DB_NAME = "MilaUniversoDeSue√±os_v5";
    const DB_VERSION = 1;
    const STORES = ["dreams", "profiles", "settings", "journalEntries", "books", "audio", "conversations", "abundanceTransactions"];
    // API key to use with the Gemini endpoints.  This can be injected into requests if needed
    // to authenticate calls to the language and image generation services.  The key is stored
    // here so the rest of the code can access it easily when constructing API requests.
    const GEMINI_API_KEY = 'AIzaSyC0d7Sw_32UJeQer_OAjgX_GuEOaoWt0yg';
    let db;

    function getDB() {
      if (db) return Promise.resolve(db);
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onupgradeneeded = e => {
          const dbInstance = e.target.result;
          STORES.forEach(name => {
            if (!dbInstance.objectStoreNames.contains(name)) {
              const store = dbInstance.createObjectStore(name, { keyPath: "id", autoIncrement: true });
              if (name === 'profiles') store.createIndex('nickname', 'nickname', { unique: true });
              if (name === 'conversations') store.createIndex('profileId', 'profileId', { unique: false });
            }
          });
        };
        request.onsuccess = e => { db = e.target.result; resolve(db); };
        request.onerror = e => { console.error("DB error:", e.target.error); reject(e.target.error); };
      });
    }
    async function get(storeName, id) { const db = await getDB(); return new Promise((resolve, reject) => { const req = db.transaction(storeName, "readonly").objectStore(storeName).get(id); req.onsuccess = () => resolve(req.result); req.onerror = () => reject(req.error); }); }
    async function getAll(storeName) { const db = await getDB(); return new Promise((resolve, reject) => { const req = db.transaction(storeName, "readonly").objectStore(storeName).getAll(); req.onsuccess = () => resolve(req.result); req.onerror = () => reject(req.error); }); }
    async function add(storeName, item) { const db = await getDB(); return new Promise((resolve, reject) => { const req = db.transaction(storeName, "readwrite").objectStore(storeName).add(item); req.onsuccess = (e) => resolve(e.target.result); req.onerror = () => reject(req.error); }); }
    async function update(storeName, item) { const db = await getDB(); return new Promise((resolve, reject) => { const tx = db.transaction(storeName, "readwrite"); tx.objectStore(storeName).put(item); tx.oncomplete = () => resolve(); tx.onerror = e => reject(e.target.error); }); }
    async function remove(storeName, id) { const db = await getDB(); return new Promise((resolve, reject) => { const tx = db.transaction(storeName, "readwrite"); tx.objectStore(storeName).delete(id); tx.oncomplete = () => resolve(); tx.onerror = e => reject(e.target.error); }); }
    async function clearStore(storeName) { const db = await getDB(); return new Promise((resolve, reject) => { const tx = db.transaction(storeName, "readwrite"); tx.objectStore(storeName).clear(); tx.oncomplete = () => resolve(); tx.onerror = e => reject(e.target.error); }); }
    async function getByIndex(storeName, indexName, key) { const db = await getDB(); return new Promise((resolve, reject) => { const req = db.transaction(storeName, "readonly").objectStore(storeName).index(indexName).getAll(key); req.onsuccess = () => resolve(req.result); req.onerror = () => reject(req.error); }); }


    // --- Application State ---
    let dreams = [], profiles = [], settings = {}, journalEntries = [], books = [], audioFiles = [], conversations = [], abundanceTransactions = [];
    let currentDream = null, currentProfile = null, currentSongIndex = 0, currentConversation = [];
    const VIEWS = {}, NAV_BUTTONS = {};
    const VIEW_IDS = { 
      main: "main-view", 
      dream: "dream-view", 
      'perfil-de-luz': "perfil-de-luz-view", 
      journal: "journal-view", 
      library: "library-view",
      ajustes: "ajustes-view",
      cycles: "cycles-view",
      abundance: "abundance-view"
    };
    const VIEW_ORDER = ['main', 'perfil-de-luz', 'abundance', 'cycles', 'journal', 'library', 'ajustes'];
    let currentViewIndex = 0;
    let touchStartX = 0;
    let touchEndX = 0;

    // Nombres sugeridos para sue√±os predeterminados sin nombre.  Estos valores se muestran cuando se edita un sue√±o vac√≠o.
    const DEFAULT_NAME_SUGGESTIONS = [
      "La casa de mis sue√±os",
      "Nuestro Viaje"
    ];

    let audioPlayer, currentSongEl, loopBtn, volumeSlider;
    let isLooping = false;

    // --- Main Application Flow ---
    async function main() {
      await initSplashScreen();
      await getDB();

      [dreams, profiles, settings, journalEntries, books, audioFiles, conversations, abundanceTransactions] = await Promise.all([
        getAll('dreams'),
        getAll('profiles'),
        get('settings', 1).then(s => s || { id: 1, slideshowDuration: 5 }),
        getAll('journalEntries'),
        getAll('books'),
        getAll('audio'),
        getAll('conversations'),
        getAll('abundanceTransactions')
      ]);

      await setupInitialData();
      
      initUI();
      initSwipeNavigation();
      initMediaViewer();
      initAudioPlayer();
      initSubliminalMessages();
      initJournal();
      initLibrary();
      initSettings();
      initProfiles();
      initCycles();
      initAbundance();
      renderCosmos();
      startShootingStars();
      checkFirstVisit();
      
      initAutoBackup();
    }

    // --- Splash Screen Logic ---
    async function initSplashScreen() {
      const greeting = document.getElementById('splash-greeting');
      const welcome  = document.getElementById('splash-welcome');
      const startBtn = document.getElementById('splash-start-btn');
      const splash   = document.getElementById('splash-screen');
      const appContainer = document.getElementById('app-container');

      setTimeout(() => greeting.style.opacity = 1, 100);
      setTimeout(() => welcome.style.opacity = 1, 600);
      setTimeout(() => startBtn.style.opacity = 1, 900);

      return new Promise(resolve => {
        let done = false;
        const finish = () => {
          if (done) return; done = true;
          splash.classList.add('fade-out');
          appContainer.style.opacity = 1;
          splash.addEventListener('animationend', () => { splash.remove(); resolve(); }, { once: true });
        };

        startBtn.addEventListener('click', async () => {
          window.__shouldAutoplayOnInit = true;
          await unlockAudioAndMedia();
          finish();
        }, { once: true });
      });
    }

    // --- Initial Data Seeding ---
    async function setupInitialData() {
      if (profiles.length === 0) {
        const defaultProfiles = [
          { fullName: "Emily Gricell Dimas Vicent", nickname: "Mila", birthDate: "1992-12-06", birthTime: "20:30", iaDescription: "Una mujer venezolana de unos 30 a√±os, alta (1.73 m), esbelta y con una figura elegante. Su piel es de tono c√°lido, sus ojos almendrados, sus labios son carnosos y tiene una sonrisa hermosa y magn√©tica. Lleva el cabello largo y negro con flequillo, y a veces lo peina con una cinta negra como toque distintivo. Su estilo es refinado y elegante, inspirado en la moda 'old money', vistiendo blusas de seda, pantalones palazzo de pierna ancha o vestidos discretos pero sofisticados. Tiene un aura cautivadora y una conexi√≥n natural con los animales, irradiando dulzura y una energ√≠a magn√©tica.", photos: [], avatarBlob: null },
          { fullName: "Miguelangel Pulido Perez", nickname: "Miguelo", birthDate: "1994-05-19", birthTime: "14:05", iaDescription: "Un hombre venezolano de unos 30 a√±os, alto (1.80 m), delgado y con un porte elegante. Tiene la piel morena clara, el pelo corto y rizado con ra√≠ces oscuras y puntas rubio platino, y lleva solo perilla (sin bigote). Su estilo diario es casual y relajado, con camisetas o camisas oversize sin logos, pero cuando se viste de etiqueta encarna el look 'old money' con camisas de lino, blazers discretos y pantalones de vestir a medida. Su presencia transmite confianza, frescura y una mezcla de encanto moderno y cl√°sico.", photos: [], avatarBlob: null }
        ];
        for (const p of defaultProfiles) await add('profiles', p);
        profiles = await getAll('profiles');
      }
      if (dreams.length === 0) {
        // Sue√±os predeterminados sin nombre para que Mila pueda personalizarlos.  Se incluyen propiedades spec para el m√≥dulo S.P.E.C.
        const defaultDreams = [
          {
            name: "",
            color: "#FFFFFF",
            size: 80,
            position: { x: 70, y: 30 },
            steps: [],
            completed: false,
            spec: {
              select: { notes: '', images: [] },
              project: { notes: '', images: [] },
              expect: { notes: '', images: [] },
              collect: { notes: '', images: [] }
            }
          },
          {
            name: "",
            color: "#87CEEB",
            size: 95,
            position: { x: 25, y: 55 },
            steps: [],
            completed: false,
            spec: {
              select: { notes: '', images: [] },
              project: { notes: '', images: [] },
              expect: { notes: '', images: [] },
              collect: { notes: '', images: [] }
            }
          }
        ];
        for (const d of defaultDreams) await add('dreams', d);
        dreams = await getAll('dreams');
      }

      // Asegurar que los sue√±os existentes tengan nombres en blanco si eran los predeterminados y a√±adir la estructura spec
      for (const d of dreams) {
        if (d.name === 'Nuestro Viaje a Europa' || d.name === 'Nuestra Casa') {
          d.name = '';
        }
        if (!d.spec) {
          d.spec = {
            select: { notes: '', images: [] },
            project: { notes: '', images: [] },
            expect: { notes: '', images: [] },
            collect: { notes: '', images: [] }
          };
        }
        await update('dreams', d);
      }

      // Inicializar la estructura de gamificaci√≥n si no existe en ajustes
      if (!settings.gamification) {
        settings.gamification = {
          streak: 0,
          lastGratitudeDate: null,
          achievements: []
        };
        await update('settings', settings);
      }
      
    }

    // =================================================================================
    // --- UI & VIEW MANAGEMENT ---
    // =================================================================================

    function initUI() {
      for (const key in VIEW_IDS) VIEWS[key] = document.getElementById(VIEW_IDS[key]);
      document.querySelectorAll('.nav-btn').forEach(btn => {
        const viewKey = btn.dataset.view;
        NAV_BUTTONS[viewKey] = btn;
        btn.addEventListener('click', () => showView(viewKey));
      });
      
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const tabId = e.target.dataset.tab;
          const tabContainer = e.target.parentElement;
          const contentContainer = tabContainer.closest('.view-container, .max-w-3xl, .max-w-2xl');
          tabContainer.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
          e.target.classList.add('active');
          contentContainer.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
          document.getElementById(`${tabId}-tab-content`).classList.remove('hidden');
        });
      });

      document.getElementById('add-dream-btn').addEventListener('click', () => showDreamModal());
      document.getElementById('cancel-dream-modal').addEventListener('click', () => document.getElementById('dream-modal').classList.add('hidden'));
      document.getElementById('dream-form').addEventListener('submit', handleAddOrUpdateDream);
      document.getElementById('close-dream-view-btn').addEventListener('click', () => showView('main'));
      document.getElementById('new-step-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAddStep(); });
      document.getElementById('gemini-steps-btn').addEventListener('click', generateDreamStepsWithGemini);
      document.getElementById('fulfill-dream-btn').addEventListener('click', fulfillCurrentDream);
      document.getElementById('close-instructions-btn').addEventListener('click', async () => {
        document.getElementById('instructions-modal').classList.add('hidden');
        settings.firstVisitDone = true;
        await update('settings', settings);
      });
      document.getElementById('quick-add-music-btn').addEventListener('click', () => showView('ajustes'));
      document.getElementById('close-fallback-modal').addEventListener('click', () => {
        const modal = document.getElementById('fallback-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      });

      // Permitir editar el nombre del sue√±o desde la vista del sue√±o con un bot√≥n de l√°piz
      const editNameBtn = document.getElementById('edit-dream-name-btn');
      if (editNameBtn) {
        editNameBtn.addEventListener('click', async () => {
          if (!currentDream) return;
          const nuevoNombre = prompt('Introduce un nuevo nombre para el sue√±o:', currentDream.name || '');
          if (nuevoNombre !== null) {
            currentDream.name = nuevoNombre.trim();
            await update('dreams', currentDream);
            // Actualiza el t√≠tulo en la vista y en el cosmos
            const titleEl = document.getElementById('dream-view-title');
            if (titleEl) titleEl.textContent = currentDream.name && currentDream.name.trim() !== '' ? currentDream.name : 'Sue√±o sin nombre';
            renderCosmos();
          }
        });
      }

      // Ayuda IA: abrir/cerrar panel y enviar preguntas
      const helpBtn = document.getElementById('help-ai-button');
      if (helpBtn) helpBtn.addEventListener('click', () => toggleHelpPanel());
      const helpCloseBtn = document.getElementById('help-ai-close');
      if (helpCloseBtn) helpCloseBtn.addEventListener('click', () => toggleHelpPanel());
      const helpSendBtn = document.getElementById('help-ai-send');
      if (helpSendBtn) helpSendBtn.addEventListener('click', () => handleHelpAISend());
      const helpInput = document.getElementById('help-ai-input');
      if (helpInput) helpInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); handleHelpAISend(); }
      });

      // Tutorial externo: copiar prompt, copiar imagen y cerrar
      const closeExt = document.getElementById('close-external-tutorial');
      if (closeExt) closeExt.addEventListener('click', () => closeExternalTutorial());
      const copyPromptBtn = document.getElementById('copy-prompt-btn');
      if (copyPromptBtn) copyPromptBtn.addEventListener('click', () => {
        const t = document.getElementById('ext-tutorial-prompt');
        if (t) navigator.clipboard.writeText(t.value).then(() => showNotification('Prompt copiado al portapapeles.'));
      });
      const copyImageBtn = document.getElementById('copy-image-btn');
      if (copyImageBtn) copyImageBtn.addEventListener('click', () => {
        if (lastTutorialImageBlob) copyBlobToClipboard(lastTutorialImageBlob);
        else showNotification('No hay imagen para copiar.', 'err');
      });

    // L√°mpara m√°gica: abrir y cerrar modal de mensaje
    const cosmosWishBtn = document.getElementById('cosmos-wish-btn');
    if (cosmosWishBtn) cosmosWishBtn.addEventListener('click', () => {
      const modal = document.getElementById('cosmos-wish-modal');
      if (modal) modal.classList.remove('hidden');
    });
    const closeWishModalBtn = document.getElementById('close-wish-modal');
    if (closeWishModalBtn) closeWishModalBtn.addEventListener('click', () => {
      const modal = document.getElementById('cosmos-wish-modal');
      if (modal) modal.classList.add('hidden');
    });


      showView('main');
    }

    function showView(viewKey) {
      if (!VIEW_IDS[viewKey]) return;

      Object.values(VIEWS).forEach(v => v.classList.add('hidden'));
      VIEWS[viewKey].classList.remove('hidden');
      
      requestAnimationFrame(() => {
          VIEWS[viewKey].style.opacity = 1;
          VIEWS[viewKey].style.transform = 'translateY(0)';
      });
      
      Object.values(NAV_BUTTONS).forEach(b => b.classList.remove('active'));
      if (NAV_BUTTONS[viewKey]) NAV_BUTTONS[viewKey].classList.add('active');

      currentViewIndex = VIEW_ORDER.indexOf(viewKey);
    }

    function initSwipeNavigation() {
        const appContainer = document.getElementById('app-container');
        appContainer.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });

        appContainer.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleViewSwipe(e);
        }, { passive: true });
    }

    function handleViewSwipe(e) {
        if (e.target.closest('textarea, input, #cosmos, #player-footer, .gallery-grid, .tab-content')) {
            return;
        }
        if (document.querySelector('#dream-view:not(.hidden), #dream-modal:not(.hidden), #media-viewer-modal:not(.hidden)')) {
            return;
        }

        const swipeThreshold = 100;
        if (touchEndX < touchStartX - swipeThreshold) {
            const nextIndex = (currentViewIndex + 1) % VIEW_ORDER.length;
            showView(VIEW_ORDER[nextIndex]);
        }
        if (touchEndX > touchStartX + swipeThreshold) {
            const prevIndex = (currentViewIndex - 1 + VIEW_ORDER.length) % VIEW_ORDER.length;
            showView(VIEW_ORDER[prevIndex]);
        }
    }

    function checkFirstVisit() {
      get('settings', 1).then(s => {
        if (!s || !s.firstVisitDone) {
          document.getElementById('instructions-modal').classList.remove('hidden');
        }
      });
    }

    function showNotification(message, type = 'ok') {
        const notification = document.getElementById('message-notification');
        notification.textContent = message;
        notification.className = 'fixed top-[-100px] left-1/2 -translate-x-1/2 bg-purple-500 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transition-all duration-500 z-[101]';
        if (type === 'err') notification.classList.replace('bg-purple-500', 'bg-red-500');
        
        notification.style.top = '20px';
        notification.style.opacity = '1';
        
        clearTimeout(notification._t);
        notification._t = setTimeout(() => {
            notification.style.top = '-100px';
            notification.style.opacity = '0';
        }, 4000);
    }
    
    function startShootingStars() {
      setInterval(() => {
        const star = document.createElement('div');
        star.className = 'shooting-star';
        star.style.top = `${Math.random() * 100}%`;
        star.style.left = `${Math.random() * 100}%`;
        document.body.appendChild(star);
        setTimeout(() => star.remove(), 3000);
      }, 5000);
    }

    // =================================================================================
    // --- COSMOS & DREAMS ---
    // =================================================================================

    function renderCosmos() {
      const cosmosEl = document.getElementById('cosmos');
      cosmosEl.innerHTML = '';
      dreams.forEach(dream => {
        const el = document.createElement('div');
        el.className = dream.completed ? 'sun' : 'planet';
        el.style.background = dream.completed
          ? `radial-gradient(circle at center, ${dream.color || '#fef08a'}, #facc15)`
          : `radial-gradient(circle at 30% 30%, ${dream.color || '#facc15'}, #333)`;
        el.style.width  = `${dream.size}px`;
        el.style.height = `${dream.size}px`;
        el.style.top  = `${dream.position.y}%`;
        el.style.left = `${dream.position.x}%`;
        el.dataset.id = dream.id;
        el.title = dream.name;
        makeDraggable(el, dream.id);
        cosmosEl.appendChild(el);
      });
    }

    function showDreamModal(dream = null) {
      const modal = document.getElementById('dream-modal');
      const form = document.getElementById('dream-form');
      form.reset();
      form.dataset.id = dream ? dream.id : '';
      // Rellenar campos si se est√° editando un sue√±o
      if (dream) {
        form.elements.name.value = dream.name || '';
        form.elements.color.value = dream.color;
        form.elements.size.value = dream.size;
      }
      // Mostrar sugerencias de nombre si el sue√±o actual no tiene nombre
      const suggestionsContainer = document.getElementById('dream-name-suggestions');
      suggestionsContainer.innerHTML = '';
      if (dream && (!dream.name || dream.name.trim() === '')) {
        DEFAULT_NAME_SUGGESTIONS.forEach(sugg => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'text-xs bg-gray-700 hover:bg-yellow-600 text-white py-1 px-2 rounded';
          btn.textContent = sugg;
          btn.addEventListener('click', () => { form.elements.name.value = sugg; });
          suggestionsContainer.appendChild(btn);
        });
        suggestionsContainer.classList.remove('hidden');
      } else {
        suggestionsContainer.classList.add('hidden');
      }
      modal.classList.remove('hidden');
    }

    async function handleAddOrUpdateDream(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const id = e.target.dataset.id ? parseInt(e.target.dataset.id) : null;

      if (id) {
        const dream = dreams.find(d => d.id === id);
        dream.name  = formData.get('name');
        dream.color = formData.get('color');
        dream.size  = parseInt(formData.get('size'));
        await update('dreams', dream);
        showNotification("Sue√±o actualizado.");
      } else {
        const newDream = {
          name: formData.get('name'),
          color: formData.get('color'),
          size: parseInt(formData.get('size')),
          position: { x: Math.random() * 80 + 10, y: Math.random() * 70 + 15 },
          steps: [], completed: false, images: [], visionBoardData: []
        };
        if (!newDream.name) { showNotification("El sue√±o debe tener un nombre."); return; }
        const newId = await add('dreams', newDream);
        newDream.id = newId;
        dreams.push(newDream);
        showNotification("¬°Sue√±o a√±adido al cosmos!");
      }
      renderCosmos();
      document.getElementById('dream-modal').classList.add('hidden');
    }

    function handleDreamClick(id) {
      currentDream = dreams.find(d => d.id === id);
      if (currentDream) {
        renderDreamView();
        showView('dream');
      }
    }

    function renderDreamView() {
      if (!currentDream) return;
      // Si el sue√±o no tiene nombre, mostrar un marcador gen√©rico
      document.getElementById('dream-view-title').textContent = currentDream.name && currentDream.name.trim() !== '' ? currentDream.name : 'Sue√±o sin nombre';
      renderImagePortalForDream();
      renderSteps();
      renderSpecModule();
    }

    function renderSteps() {
      const stepsEl = document.getElementById('dream-view-steps');
      stepsEl.innerHTML = '';
      const steps = currentDream.steps || [];
      steps.forEach((step, index) => {
        const li = document.createElement('li');
        li.className = `flex items-center justify-between p-2 rounded ${step.completed ? 'bg-green-900/50' : 'bg-gray-700/50'}`;
        li.innerHTML = `<span class="${step.completed ? 'line-through' : ''}">${step.text}</span><input type="checkbox" ${step.completed ? 'checked' : ''} class="form-checkbox h-5 w-5 text-yellow-300 bg-gray-800 border-gray-600 rounded focus:ring-yellow-400">`;
        li.querySelector('input').onchange = () => toggleStep(index);
        stepsEl.appendChild(li);
      });
      const allStepsCompleted = steps.length > 0 && steps.every(s => s.completed);
      document.getElementById('fulfill-dream-container').classList.toggle('hidden', !allStepsCompleted);
    }

    async function handleAddStep() {
      const input = document.getElementById('new-step-input');
      if (!input.value.trim()) return;
      currentDream.steps = [...(currentDream.steps || []), { text: input.value, completed: false }];
      await update('dreams', currentDream);
      input.value = '';
      renderSteps();
    }

    async function toggleStep(index) {
      currentDream.steps[index].completed = !currentDream.steps[index].completed;
      await update('dreams', currentDream);
      renderSteps();
    }

    async function fulfillCurrentDream() {
      if (!currentDream) return;
      currentDream.completed = true;
      await update('dreams', currentDream);
      
      const planetEl = document.querySelector(`#cosmos .planet[data-id="${currentDream.id}"]`);
      showCelebration();

      if (planetEl) {
        planetEl.classList.remove('planet');
        planetEl.classList.add('sun');
        planetEl.style.background = `radial-gradient(circle at center, ${currentDream.color || '#fef08a'}, #facc15)`;
      }

      setTimeout(() => { 
        showView('main');
      }, 4000);
    }

    // =================================================================================
    // --- M√ìDULO S.P.E.C. Y GAMIFICACI√ìN ---
    // =================================================================================

    /**
     * Renderiza el m√≥dulo S.P.E.C. dentro de la vista del sue√±o actual.  Cada etapa
     * (Seleccionar, Proyectar, Esperar, Coleccionar) ofrece un textarea para
     * registrar notas y un bot√≥n para guardarlas.  La estructura de datos se
     * almacena en currentDream.spec.
     */
    function renderSpecModule() {
      if (!currentDream) return;
      const container = document.getElementById('spec-module');
      if (!container) return;
      // Asegura que exista la estructura spec
      if (!currentDream.spec) {
        currentDream.spec = {
          select: { notes: '', images: [] },
          project: { notes: '', images: [] },
          expect: { notes: '', images: [] },
          collect: { notes: '', images: [] }
        };
      }
      container.innerHTML = '';
      const stages = ['select', 'project', 'expect', 'collect'];
      const titles = {
        select: 'Seleccionar',
        project: 'Proyectar',
        expect: 'Esperar',
        collect: 'Coleccionar'
      };
      stages.forEach(stage => {
        const stageData = currentDream.spec[stage] || { notes: '', images: [] };
        const wrapper = document.createElement('div');
        wrapper.className = 'bg-gray-900/50 p-3 rounded space-y-2';
        // T√≠tulo
        const h4 = document.createElement('h4');
        h4.className = 'font-cinzel text-yellow-200';
        h4.textContent = titles[stage];
        wrapper.appendChild(h4);
        // Contenedor de im√°genes adjuntas
        const imgContainer = document.createElement('div');
        imgContainer.id = `spec-${stage}-images`;
        imgContainer.className = 'flex flex-wrap gap-2';
        (stageData.images || []).forEach((imgObj, idx) => {
          const item = document.createElement('div');
          item.className = 'relative';
          const url = getMediaURL(imgObj.blob || imgObj.data || imgObj);
          const imgEl = document.createElement('img');
          imgEl.src = url;
          imgEl.className = 'w-14 h-14 object-cover rounded';
          imgEl.onload = () => { if (isBlobURL(url)) URL.revokeObjectURL(url); };
          const delBtn = document.createElement('button');
          delBtn.className = 'absolute top-0 right-0 bg-red-600 text-white text-[10px] rounded-full w-4 h-4 flex items-center justify-center';
          delBtn.innerHTML = '&times;';
          delBtn.addEventListener('click', async () => {
            // Remove this image from stageData.images
            currentDream.spec[stage].images.splice(idx, 1);
            await update('dreams', currentDream);
            renderSpecModule();
          });
          item.appendChild(imgEl);
          item.appendChild(delBtn);
          imgContainer.appendChild(item);
        });
        wrapper.appendChild(imgContainer);
        // Controles: a√±adir imagen, n√∫mero de variaciones y generar
        const controls = document.createElement('div');
        controls.className = 'flex items-center flex-wrap gap-2 text-xs mt-1';
        const addBtn = document.createElement('button');
        addBtn.className = 'bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-2 rounded';
        addBtn.textContent = 'A√±adir Foto';
        // File input
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.multiple = true;
        fileInput.className = 'hidden';
        fileInput.id = `spec-${stage}-file-input`;
        addBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', e => {
          if (e.target.files && e.target.files.length) {
            handleSpecImageUpload(stage, e.target.files);
          }
        });
        const numInput = document.createElement('input');
        numInput.type = 'number';
        numInput.min = '1';
        numInput.max = '8';
        numInput.value = '1';
        numInput.id = `spec-${stage}-variations`;
        numInput.className = 'w-14 bg-gray-700 text-center rounded';
        const genBtn = document.createElement('button');
        genBtn.className = 'gemini-btn text-gray-900 font-bold py-1 px-3 rounded';
        genBtn.textContent = 'Generar';
        genBtn.addEventListener('click', () => generateSpecStepImages(stage));
        controls.appendChild(addBtn);
        controls.appendChild(fileInput);
        controls.appendChild(numInput);
        controls.appendChild(genBtn);
        wrapper.appendChild(controls);
        // √Årea de notas
        const textarea = document.createElement('textarea');
        textarea.id = `spec-${stage}-notes`;
        textarea.className = 'w-full bg-gray-700 p-2 rounded text-sm';
        textarea.rows = 2;
        textarea.placeholder = `Escribe tus notas para ${titles[stage].toLowerCase()}...`;
        textarea.value = stageData.notes || '';
        wrapper.appendChild(textarea);
        // Bot√≥n para guardar notas
        const saveBtn = document.createElement('button');
        saveBtn.className = 'bg-yellow-400 text-gray-900 font-bold py-1 px-3 rounded text-xs hover:bg-yellow-500';
        saveBtn.textContent = 'Guardar';
        saveBtn.addEventListener('click', () => saveSpecStage(stage));
        wrapper.appendChild(saveBtn);
        container.appendChild(wrapper);
      });
    }

    /**
     * Guarda las notas para una etapa espec√≠fica del m√≥dulo S.P.E.C.  Actualiza
     * el objeto del sue√±o actual y lo persiste en IndexedDB.
     * @param {string} stage - Una de las claves: 'select', 'project', 'expect' o 'collect'
     */
    async function saveSpecStage(stage) {
      if (!currentDream) return;
      const textarea = document.getElementById(`spec-${stage}-notes`);
      if (!textarea) return;
      if (!currentDream.spec) {
        currentDream.spec = {
          select: { notes: '', images: [] },
          project: { notes: '', images: [] },
          expect: { notes: '', images: [] },
          collect: { notes: '', images: [] }
        };
      }
      if (!currentDream.spec[stage]) {
        currentDream.spec[stage] = { notes: '', images: [] };
      }
      currentDream.spec[stage].notes = textarea.value.trim();
      await update('dreams', currentDream);
      showNotification('Notas guardadas.');
    }

    /**
     * Maneja la subida de im√°genes para una etapa espec√≠fica del m√≥dulo S.P.E.C.  Convierte los
     * archivos seleccionados en blobs y los agrega al array de im√°genes de la etapa.  Una vez
     * a√±adidas las im√°genes, actualiza el sue√±o y vuelve a renderizar el m√≥dulo.
     * @param {string} stage - Clave de etapa (select, project, expect, collect)
     * @param {FileList} files - Lista de archivos seleccionados
     */
    async function handleSpecImageUpload(stage, files) {
      if (!currentDream || !files || !files.length) return;
      // Asegurar que la estructura spec existe
      if (!currentDream.spec) {
        currentDream.spec = { select: { notes: '', images: [] }, project: { notes: '', images: [] }, expect: { notes: '', images: [] }, collect: { notes: '', images: [] } };
      }
      if (!currentDream.spec[stage]) {
        currentDream.spec[stage] = { notes: '', images: [] };
      }
      const arr = Array.from(files);
      for (const file of arr) {
        try {
          const buffer = await file.arrayBuffer();
          const blob = new Blob([buffer], { type: file.type });
          currentDream.spec[stage].images.push({ blob });
        } catch (e) {
          console.error('Error al leer imagen para S.P.E.C.:', e);
        }
      }
      await update('dreams', currentDream);
      renderSpecModule();
    }

    /**
     * Genera im√°genes para una etapa del m√≥dulo S.P.E.C. utilizando la API de Gemini.  Se lee
     * el n√∫mero de variaciones solicitado, se construye el prompt final a partir del sue√±o actual
     * y se realizan m√∫ltiples llamadas a la API de generaci√≥n de im√°genes.  Las im√°genes
     * generadas se guardan en la etapa correspondiente.  Si la API falla, se invoca el
     * tutorial externo para guiar al usuario en generadores alternativos.
     * @param {string} stage - Clave de etapa (select, project, expect, collect)
     */
    async function generateSpecStepImages(stage) {
      if (!currentDream) return;
      const numInput = document.getElementById(`spec-${stage}-variations`);
      const count = parseInt(numInput && numInput.value ? numInput.value : '1', 10) || 1;
      // buildFinalPrompt() devuelve una promesa; espera su valor para usar el texto final
      const prompt = typeof buildFinalPrompt === 'function' ? await buildFinalPrompt() : '';
      // Asegurar que la estructura existe
      if (!currentDream.spec) {
        currentDream.spec = { select: { notes: '', images: [] }, project: { notes: '', images: [] }, expect: { notes: '', images: [] }, collect: { notes: '', images: [] } };
      }
      if (!currentDream.spec[stage]) {
        currentDream.spec[stage] = { notes: '', images: [] };
      }
      let generatedCount = 0;
      const variations = Math.min(Math.max(count, 1), 8);
      try {
        for (let i = 0; i < variations; i++) {
          const imageDataUrl = await generateImageWithGemini(prompt);
          const response = await fetch(imageDataUrl);
          const blob = await response.blob();
          currentDream.spec[stage].images.push({ blob });
          generatedCount++;
        }
        await update('dreams', currentDream);
        renderSpecModule();
        showNotification(`Se generaron ${generatedCount} imagen${generatedCount === 1 ? '' : 'es'} para ${stage}.`);
      } catch (error) {
        console.error('Error generando im√°genes S.P.E.C.:', error);
        // Si falla la generaci√≥n, mostrar el tutorial externo
        openExternalMiniTutorial(stage);
      }
    }

    // Variable global para guardar la √∫ltima imagen utilizada en el tutorial externo
    let lastTutorialImageBlob = null;

    /**
     * Selecciona la mejor foto disponible para el tutorial externo: toma la primera imagen
     * adjunta en la etapa, o en su defecto el avatar del perfil activo, si existe.  Si no hay
     * ninguna imagen disponible, devuelve null.
     * @param {string} stage - Clave de etapa
     * @returns {Blob|null}
     */
    function pickBestPhotoForStage(stage) {
      if (currentDream && currentDream.spec && currentDream.spec[stage] && currentDream.spec[stage].images && currentDream.spec[stage].images.length > 0) {
        const imgObj = currentDream.spec[stage].images[0];
        return imgObj.blob || imgObj.data || null;
      }
      // Utilizar avatar del perfil actual si existe
      if (currentProfile && currentProfile.avatarBlob) return currentProfile.avatarBlob;
      return null;
    }

    /**
     * Abre el modal del tutorial externo para indicar c√≥mo generar im√°genes fuera de la app.
     * Se muestra una imagen de referencia y el prompt final para que el usuario lo copie y
     * utilice en generadores externos como Gemini.  Tambi√©n prepara los manejadores de
     * eventos para copiar la imagen y el prompt al portapapeles.
     * @param {string} stage - Clave de etapa
     */
    async function openExternalMiniTutorial(stage) {
      const modal = document.getElementById('external-tutorial-modal');
      if (!modal) return;
      const imgEl = document.getElementById('ext-tutorial-img');
      const promptTextarea = document.getElementById('ext-tutorial-prompt');
      // Seleccionar imagen y guardarla en variable global
      const blob = pickBestPhotoForStage(stage);
      lastTutorialImageBlob = blob;
      if (blob) {
        const url = URL.createObjectURL(blob);
        imgEl.src = url;
        imgEl.onload = () => { URL.revokeObjectURL(url); };
      } else {
        imgEl.src = '';
      }
      // Construir y colocar el prompt final.
      // buildFinalPrompt() es as√≠ncrona, por lo que debemos esperar su resoluci√≥n.
      const prompt = typeof buildFinalPrompt === 'function' ? await buildFinalPrompt() : '';
      promptTextarea.value = prompt;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    /**
     * Cierra el modal del tutorial externo.
     */
    function closeExternalTutorial() {
      const modal = document.getElementById('external-tutorial-modal');
      if (!modal) return;
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    /**
     * Abre el tutorial externo para generaci√≥n de im√°genes basado en el prompt final del Constructor.
     * Copia la primera imagen de los perfiles seleccionados (si existe) y muestra el prompt completo.
     * Esta funci√≥n se usa como fallback cuando la generaci√≥n interna falla o cuando el usuario desea
     * utilizar herramientas externas.  Utiliza el mismo modal que el S.P.E.C.
     * @param {string} prompt El prompt final a mostrar en el tutorial externo
     */
    async function openExternalPromptTutorial(prompt) {
      const modal = document.getElementById('external-tutorial-modal');
      if (!modal) return;
      const imgEl = document.getElementById('ext-tutorial-img');
      const promptTextarea = document.getElementById('ext-tutorial-prompt');

      // Seleccionar la primera imagen de referencia de los personajes marcados
      let selectedBlob = null;
      try {
        const selectedCheckboxes = document.querySelectorAll('#image-character-selection input:checked');
        for (const checkbox of selectedCheckboxes) {
          const profile = await get('profiles', parseInt(checkbox.value));
          if (profile && profile.avatarBlob) {
            selectedBlob = profile.avatarBlob;
            break;
          }
        }
      } catch (err) {
        console.warn('No se pudieron obtener los perfiles seleccionados para el tutorial externo:', err);
      }

      lastTutorialImageBlob = null;
      if (selectedBlob) {
        lastTutorialImageBlob = selectedBlob;
        const url = URL.createObjectURL(selectedBlob);
        imgEl.src = url;
        imgEl.onload = () => { URL.revokeObjectURL(url); };
      } else {
        imgEl.src = '';
      }
      // Colocar el prompt recibido
      promptTextarea.value = prompt;
      // Actualizar enlace a Gemini como recomendado
      const geminiLink = document.getElementById('open-gemini');
      if (geminiLink) geminiLink.href = 'https://gemini.google.com/app';
      // Mostrar modal
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    /**
     * Copia un blob de imagen al portapapeles.  Utiliza la API Clipboard si est√°
     * disponible.  Si falla, muestra una notificaci√≥n de error.
     * @param {Blob} blob - El blob de imagen a copiar
     */
    async function copyBlobToClipboard(blob) {
      if (!blob) {
        showNotification('No hay imagen para copiar.', 'err');
        return;
      }
      try {
        const item = new ClipboardItem({ [blob.type]: blob });
        await navigator.clipboard.write([item]);
        showNotification('Imagen copiada al portapapeles.');
      } catch (err) {
        console.error('No se pudo copiar la imagen:', err);
        showNotification('No se pudo copiar la imagen.', 'err');
      }
    }

    /**
     * Activa una animaci√≥n de destello en el bot√≥n del genio para dar feedback visual
     * de que una operaci√≥n de IA ha concluido.
     */
    function sparkleGenieButton() {
        const genieBtn = document.getElementById('cosmos-wish-btn');
        if (genieBtn) {
            genieBtn.classList.add('genie-sparkle');
            genieBtn.addEventListener('animationend', () => genieBtn.classList.remove('genie-sparkle'), { once: true });
        }
    }

    /**
     * Alterna la visibilidad del panel de ayuda IA.  Agrega o elimina la clase
     * `translate-x-full` para mostrar u ocultar el panel desde el lado derecho.
     */
    function toggleHelpPanel() {
      const panel = document.getElementById('help-ai-panel');
      if (!panel) return;
      // Alternar clase hidden en lugar de translate-x-full para mostrar/ocultar
      panel.classList.toggle('hidden');
    }

    /**
     * Abre la ayuda IA (guIA) con un mensaje predefinido para generar afirmaciones positivas.
     * Se utiliza cuando el usuario pulsa "Continuar" en el mensaje de la l√°mpara m√°gica.
     */
    function openAffirmationFromWish() {
      const modal = document.getElementById('cosmos-wish-modal');
      if (modal) modal.classList.add('hidden');
      // Mostrar el panel de ayuda si est√° oculto
      const helpPanel = document.getElementById('help-ai-panel');
      if (helpPanel && helpPanel.classList.contains('hidden')) {
        toggleHelpPanel();
      }
      // Prefijar el input con la petici√≥n de afirmaciones y enviarla autom√°ticamente
      const helpInput = document.getElementById('help-ai-input');
      if (helpInput) {
        helpInput.value = 'Genera afirmaciones positivas para convertirme en mis deseos. ¬øC√≥mo puedo ser la persona que atrae lo que desea?';
        handleHelpAISend();
      }
    }

    /**
     * Agrega un mensaje al hilo de conversaci√≥n de la ayuda IA.
     * @param {string} role - 'user' o 'assistant'
     * @param {string} text - El texto a mostrar
     */
    function pushHelpMessage(role, text) {
      const thread = document.getElementById('help-ai-thread');
      if (!thread) return;
      const bubble = document.createElement('div');
      bubble.className = role === 'user' ? 'bg-blue-600/70 p-2 rounded text-sm self-end max-w-[90%]' : 'bg-gray-700/70 p-2 rounded text-sm self-start max-w-[90%]';
      bubble.innerHTML = text.replace(/\n/g, '<br>');
      thread.appendChild(bubble);
      thread.scrollTop = thread.scrollHeight;
    }

    /**
     * Env√≠a la consulta del usuario a la IA a trav√©s de la API de Gemini.  Prepara un
     * prompt que act√∫a como sistema, definiendo que la IA es la gu√≠a oficial de la
     * aplicaci√≥n.  Maneja el flujo de mensajes, mostrando el mensaje del usuario y la
     * respuesta del asistente.  En caso de error, informa al usuario.
     */
    async function handleHelpAISend() {
      const inputEl = document.getElementById('help-ai-input');
      if (!inputEl) return;
      const question = inputEl.value.trim();
      if (!question) return;
      pushHelpMessage('user', question);
      inputEl.value = '';
      // Construir prompt de sistema y de usuario
      let systemPrompt = `Eres la Gu√≠a oficial de \"Mila ‚Äì Mapa de Sue√±os\". Conoces todas las pantallas y flujos de la aplicaci√≥n: Mapa de Sue√±os (planetas), Constructor de Sue√±os, S.P.E.C., Diario, Perfil (fotos), Abundancia, Biblioteca, Ciclos y Ajustes. Debes dar instrucciones claras, breves y m√°gicas en espa√±ol, utilizando bullets o pasos numerados cuando sea apropiado. Habla de manera c√°lida y pr√°ctica. Si la tarea implica generar una imagen fuera de la app, sugiere abrir el tutorial externo. Responde en texto plano (sin JSON) con saltos de l√≠nea. Contexto: `;
      const context = {
        vista: VIEW_ORDER[currentViewIndex],
        nombreSue√±o: currentDream ? (currentDream.name || 'sue√±o sin nombre') : null,
        perfiles: profiles.length,
        tieneAvatar: currentProfile && currentProfile.avatarBlob ? true : false
      };
      const fullPrompt = `${systemPrompt}\nUsuario pregunta: ${question}\nContexto adicional: ${JSON.stringify(context)}`;
      try {
        const aiResponse = await callGeminiAPI(fullPrompt);
        const cleaned = cleanAIText(aiResponse);
        pushHelpMessage('assistant', cleaned);
        sparkleGenieButton(); // Feedback de IA
      } catch (e) {
        console.error('Error en ayuda IA:', e);
        pushHelpMessage('assistant', 'Lo siento, no pude procesar tu pregunta en este momento.');
      }
    }

    /**
     * Actualiza la visualizaci√≥n de la racha de gratitud en el diario.  Lee el
     * valor de settings.gamification.streak y muestra un texto apropiado.  Si
     * no hay racha, no se muestra ning√∫n mensaje.
     */
    function updateStreakDisplay() {
      const streakEl = document.getElementById('streak-display');
      if (!streakEl) return;
      const gam = settings.gamification || {};
      const streak = gam.streak || 0;
      if (!streak) {
        streakEl.textContent = '';
      } else if (streak === 1) {
        streakEl.textContent = 'Llevas 1 d√≠a de gratitud consecutivo.';
      } else {
        streakEl.textContent = `Llevas ${streak} d√≠as de gratitud consecutivos.`;
      }
    }
    
    // =================================================================================
    // --- PROFILES & NUMEROLOGY ---
    // =================================================================================
    
    function initProfiles() {
      const select = document.getElementById('profile-select');
      document.getElementById('add-profile-btn').addEventListener('click', handleNewProfile);
      select.addEventListener('change', async (e) => {
        currentProfile = await get('profiles', parseInt(e.target.value));
        renderProfileDetails();
      });
      renderProfileSelect();
    }
    function renderProfileSelect() {
      const select = document.getElementById('profile-select');
      const currentId = currentProfile ? currentProfile.id : null;
      select.innerHTML = '';
      profiles.forEach(p => {
        const option = document.createElement('option');
        option.value = p.id;
        option.textContent = p.nickname;
        select.appendChild(option);
      });
      if (currentId) {
        select.value = currentId;
      } else if (profiles.length > 0) {
        currentProfile = profiles[0];
        select.value = currentProfile.id;
      }
      renderProfileDetails();
    }
    async function renderProfileDetails() {
      if (!currentProfile) {
        document.getElementById('profile-form-container').innerHTML = '<p>Selecciona o crea un perfil.</p>';
        document.getElementById('numerology-tab-content').innerHTML = '';
        renderPlaceholderTabs();
        return;
      }
      renderProfileForm();
      const fullProfileData = await numerologyCalculator.calcularTodo(currentProfile.fullName, currentProfile.nickname, currentProfile.birthDate, currentProfile.birthTime, 'Caracas');
      if (fullProfileData) {
        currentProfile.fullData = fullProfileData;
        renderNumerologyTab(fullProfileData);
        renderHumanDesignTab(fullProfileData.disenoHumano);
      } else {
        document.getElementById('numerology-tab-content').innerHTML = '<p class="p-4 text-yellow-200">No se pudieron calcular los datos. Aseg√∫rate de que la fecha y hora de nacimiento sean v√°lidas.</p>';
        document.getElementById('humandesign-tab-content').innerHTML = '';
      }
      renderCompatibilityTab();
      renderLightMessageTab();
    }
    function handleNewProfile() {
      currentProfile = null;
      renderProfileForm(true);
      document.getElementById('profile-select').value = '';
      document.getElementById('numerology-tab-content').innerHTML = '';
      renderPlaceholderTabs();
    }
    
    function renderProfileForm(isNew = false) {
      const c = document.getElementById('profile-form-container');
      const profile = currentProfile || { fullName: '', nickname: '', birthDate: '', birthTime: '', iaDescription: '', avatarData: {} };
      
      c.innerHTML = `
        <div class="flex border-b border-gray-700 mb-4">
          <button data-profile-tab="basic" class="tab-btn active p-2">B√°sico</button>
          <button data-profile-tab="avatar" class="tab-btn p-2">Descripci√≥n F√≠sica</button>
          <button data-profile-tab="photos" class="tab-btn p-2">Fotos</button>
        </div>

        <div id="profile-basic-tab" class="profile-tab-content">
          <input type="text" id="profile-fullname" class="w-full bg-gray-700 p-2 rounded text-white mb-2" placeholder="Nombre Completo" value="${profile.fullName}">
          <input type="text" id="profile-nickname" class="w-full bg-gray-700 p-2 rounded text-white mb-2" placeholder="Apodo" value="${profile.nickname}">
          <div class="flex gap-2">
            <input type="date" id="profile-birthdate" class="w-1/2 bg-gray-700 p-2 rounded text-white" value="${profile.birthDate}">
            <input type="time" id="profile-birthtime" class="w-1/2 bg-gray-700 p-2 rounded text-white" value="${profile.birthTime}">
          </div>
        </div>

        <div id="profile-avatar-tab" class="profile-tab-content hidden">
          <!-- Avatar preview and upload -->
          <div class="flex items-center gap-4 mb-4">
            <img id="profile-avatar-preview" class="w-20 h-20 rounded-full object-cover border border-gray-600" src="" alt="Avatar">
            <button id="upload-avatar-btn" type="button" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 px-3 rounded">Cambiar Avatar</button>
            <input id="avatar-upload" type="file" accept="image/*" class="hidden">
          </div>

          <div class="flex items-center justify-center gap-4 mb-4">
            <label class="flex items-center gap-2"><input type="radio" name="avatar-mode" value="guided" checked class="form-radio text-yellow-400"> Modo Guiado</label>
            <label class="flex items-center gap-2"><input type="radio" name="avatar-mode" value="free" class="form-radio text-yellow-400"> Modo Libre</label>
          </div>
          <div id="avatar-guided-mode">
            <div class="grid grid-cols-2 gap-4 text-sm">
              ${generateAvatarSelects(profile.avatarData)}
            </div>
          </div>
          <div id="avatar-free-mode" class="hidden">
            <textarea id="profile-ia-description" class="w-full bg-gray-900 p-2 rounded text-white mt-2" rows="8" placeholder="Describe f√≠sicamente al personaje...">${profile.iaDescription || ''}</textarea>
          </div>
        </div>

        <!-- Fotos tab -->
        <div id="profile-photos-tab" class="profile-tab-content hidden">
          <div id="profile-photos" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
          <button id="add-profile-photo" type="button" class="gemini-btn mt-3 w-full text-gray-900 font-bold py-2 px-4 rounded text-sm">A√±adir foto</button>
          <input id="add-profile-photo-input" type="file" accept="image/*" multiple class="hidden">
        </div>

        <button id="save-profile-btn" class="bg-yellow-300 text-gray-900 px-4 py-2 rounded mt-4">${isNew ? 'Crear Perfil' : 'Guardar Cambios'}</button>
      `;

      c.querySelectorAll('[data-profile-tab]').forEach(btn => {
        btn.addEventListener('click', e => {
          c.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
          e.target.classList.add('active');
          c.querySelectorAll('.profile-tab-content').forEach(content => content.classList.add('hidden'));
          document.getElementById(`profile-${e.target.dataset.profileTab}-tab`).classList.remove('hidden');
        });
      });

      c.querySelectorAll('input[name="avatar-mode"]').forEach(radio => {
        radio.addEventListener('change', e => {
          document.getElementById('avatar-guided-mode').classList.toggle('hidden', e.target.value !== 'guided');
          document.getElementById('avatar-free-mode').classList.toggle('hidden', e.target.value !== 'free');
        });
      });
      
      c.querySelectorAll('#avatar-guided-mode select').forEach(select => {
          select.addEventListener('change', updateIaDescriptionFromGuided);
      });

      // Eventos para subir y gestionar fotos y avatar
      const addPhotoBtn = document.getElementById('add-profile-photo');
      const addPhotoInput = document.getElementById('add-profile-photo-input');
      if (addPhotoBtn && addPhotoInput) {
        addPhotoBtn.addEventListener('click', () => addPhotoInput.click());
        addPhotoInput.addEventListener('change', e => {
          if (e.target.files && e.target.files.length) {
            handleProfilePhotoUpload(e.target.files);
          }
        });
      }
      const uploadAvatarBtn = document.getElementById('upload-avatar-btn');
      const avatarUploadInput = document.getElementById('avatar-upload');
      if (uploadAvatarBtn && avatarUploadInput) {
        uploadAvatarBtn.addEventListener('click', () => avatarUploadInput.click());
        avatarUploadInput.addEventListener('change', e => {
          const file = e.target.files && e.target.files[0];
          if (file) handleAvatarUpload(file);
        });
      }

      // Renderizar fotos y avatar actuales
      renderProfilePhotos();
      updateAvatarPreview();

      document.getElementById('save-profile-btn').addEventListener('click', saveCurrentProfile);
    }

    function generateAvatarSelects(data = {}) {
        const options = {
            gender: ['Mujer', 'Hombre'],
            ethnicity: ['Latina', 'Cauc√°sica', 'Afrodescendiente', 'Asi√°tica', 'Mestiza', 'Ind√≠gena', 'Del Medio Oriente'],
            skinTone: ['Muy clara', 'Clara', 'Morena clara', 'Morena', 'Oscura'],
            eyeColor: ['Marrones', 'Miel', 'Verdes', 'Azules', 'Grises', 'Negros'],
            hairLength: ['Largo', 'Por los hombros', 'Corto', 'Rapado', 'Calvo/a'],
            hairType: ['Liso', 'Ondulado', 'Rizado', 'Afro'],
            hairColor: ['Negro', 'Casta√±o oscuro', 'Casta√±o claro', 'Rubio', 'Pelirrojo', 'Gris', 'Blanco', 'Platino', 'De colores'],
            facialHair: ['Ninguno', 'Barba completa', 'Perilla', 'Bigote', 'Barba de tres d√≠as'],
            height: ['Baja', 'Promedio', 'Alta'],
            build: ['Delgada', 'Esbelta', 'Promedio', 'Atl√©tica', 'Robusta'],
            style: ['Casual', 'Elegante', 'Bohemio', 'Urbano', 'Deportivo', 'Old money', 'Minimalista']
        };

        let html = '';
        for (const key in options) {
            const label = key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1');
            html += `
                <div>
                    <label class="block text-xs font-bold mb-1 text-yellow-200">${label}</label>
                    <select name="${key}" class="w-full bg-gray-700 p-2 rounded text-white text-xs">
                        <option value="">Seleccionar...</option>
                        ${options[key].map(opt => `<option value="${opt}" ${data[key] === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                    </select>
                </div>
            `;
        }
        return html;
    }

    function updateIaDescriptionFromGuided() {
        const form = document.getElementById('avatar-guided-mode');
        const selects = form.querySelectorAll('select');
        const data = {};
        selects.forEach(s => { if (s.value) data[s.name] = s.value; });

        if (Object.keys(data).length === 0) {
            document.getElementById('profile-ia-description').value = '';
            return;
        }

        let parts = [];
        if (data.gender) parts.push(`Una ${data.gender.toLowerCase()}`);
        if (data.ethnicity) parts.push(`de etnia ${data.ethnicity.toLowerCase()}`);
        if (data.height) parts.push(`, ${data.height.toLowerCase()}`);
        if (data.build) parts.push(`y de complexi√≥n ${data.build.toLowerCase()}`);

        let skinDesc = data.skinTone ? `Su piel es de tono ${data.skinTone.toLowerCase()}` : '';
        let eyeDesc = data.eyeColor ? `sus ojos son de color ${data.eyeColor.toLowerCase()}` : '';
        let physicalDesc = [skinDesc, eyeDesc].filter(Boolean).join(', ');
        if (physicalDesc) parts.push('. ' + physicalDesc.charAt(0).toUpperCase() + physicalDesc.slice(1));

        let hairParts = [];
        if (data.hairLength) hairParts.push(data.hairLength.toLowerCase());
        if (data.hairType) hairParts.push(data.hairType.toLowerCase());
        if (data.hairColor) hairParts.push(`de color ${data.hairColor.toLowerCase()}`);
        if (hairParts.length > 0) parts.push(`. Tiene el cabello ${hairParts.join(' ')}`);
        
        if (data.facialHair && data.facialHair !== 'Ninguno') parts.push(`y lleva ${data.facialHair.toLowerCase()}`);
        if (data.style) parts.push(`. Su estilo de vestir es ${data.style.toLowerCase()}`);

        let description = parts.join('').replace(/^,/, '').trim().replace(/\s\s+/g, ' ').replace(' .', '.').replace(' ,', ',');
        description += '.';
        document.getElementById('profile-ia-description').value = description.charAt(0).toUpperCase() + description.slice(1);
    }

    // === Perfil: Avatar y Galer√≠a de fotos ===
    /**
     * Actualiza la vista previa del avatar en el formulario de perfil.
     */
    function updateAvatarPreview() {
      const preview = document.getElementById('profile-avatar-preview');
      if (!preview) return;
      if (currentProfile && currentProfile.avatarBlob) {
        const url = getMediaURL(currentProfile.avatarBlob);
        preview.src = url;
        // Liberar URL al cargar para evitar fugas de memoria
        preview.onload = () => { if (isBlobURL(url)) URL.revokeObjectURL(url); };
      } else {
        preview.src = '';
      }
    }

    /**
     * Maneja la subida de la imagen del avatar y la asigna al perfil actual.
     * @param {File} file - El archivo de imagen seleccionado
     */
    async function handleAvatarUpload(file) {
      if (!file) return;
      const arr = await file.arrayBuffer();
      const blob = new Blob([arr], { type: file.type });
      if (!currentProfile) currentProfile = { photos: [] };
      currentProfile.avatarBlob = blob;
      currentProfile.updatedAt = Date.now();
      await update('profiles', { ...currentProfile });
      updateAvatarPreview();
    }

    /**
     * Agrega una o m√°s fotos a la galer√≠a del perfil actual.
     * @param {FileList} fileList - Lista de archivos seleccionados
     */
    async function handleProfilePhotoUpload(fileList) {
      if (!currentProfile) return;
      currentProfile.photos = currentProfile.photos || [];
      for (const file of fileList) {
        const arr = await file.arrayBuffer();
        const blob = new Blob([arr], { type: file.type });
        const asset = { id: crypto.randomUUID(), blob, title: file.name, tags: [], createdAt: Date.now() };
        currentProfile.photos.push(asset);
      }
      currentProfile.updatedAt = Date.now();
      await update('profiles', { ...currentProfile });
      renderProfilePhotos();
    }

    /**
     * Renderiza la galer√≠a de fotos del perfil en la pesta√±a de fotos.
     */
    function renderProfilePhotos() {
      const container = document.getElementById('profile-photos');
      if (!container) return;
      container.innerHTML = '';
      if (!currentProfile || !currentProfile.photos || currentProfile.photos.length === 0) {
        container.innerHTML = '<p class="text-xs text-gray-400 col-span-full">No hay fotos a√±adidas.</p>';
        return;
      }
      currentProfile.photos.forEach(asset => {
        const wrapper = document.createElement('div');
        wrapper.className = 'relative group';
        const url = getMediaURL(asset.blob);
        const img = document.createElement('img');
        img.src = url;
        img.className = 'w-full h-full object-cover rounded';
        img.onload = () => { if (isBlobURL(url)) URL.revokeObjectURL(url); };
        // Eliminar bot√≥n
        const delBtn = document.createElement('button');
        delBtn.className = 'absolute top-1 right-1 bg-red-600 text-white text-xs rounded-full w-5 h-5 hidden group-hover:block';
        delBtn.innerHTML = '&times;';
        delBtn.addEventListener('click', async () => { removeProfilePhoto(asset.id); });
        wrapper.appendChild(img);
        wrapper.appendChild(delBtn);
        container.appendChild(wrapper);
      });
    }

    /**
     * Elimina una foto de la galer√≠a del perfil y actualiza la vista.
     * @param {string} photoId - ID de la foto a eliminar
     */
    async function removeProfilePhoto(photoId) {
      if (!currentProfile || !currentProfile.photos) return;
      currentProfile.photos = currentProfile.photos.filter(p => p.id !== photoId);
      currentProfile.updatedAt = Date.now();
      await update('profiles', { ...currentProfile });
      renderProfilePhotos();
    }

    /**
     * Renderiza la lista de personajes disponibles para el Constructor de Sue√±os con miniaturas.
     * Cada personaje muestra su avatar (si existe) y un checkbox para seleccionarlo.
     */
    function renderCharacterSelection() {
      const characterSelectionEl = document.getElementById('image-character-selection');
      if (!characterSelectionEl) return;
      characterSelectionEl.innerHTML = '';
      profiles.forEach(p => {
        const label = document.createElement('label');
        label.className = 'flex items-center gap-2 bg-gray-700 p-2 rounded text-sm cursor-pointer';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'form-checkbox h-4 w-4 text-yellow-500 bg-gray-800 border-gray-600 rounded focus:ring-yellow-600';
        checkbox.name = 'character';
        checkbox.value = p.id;
        checkbox.addEventListener('change', buildFinalPrompt);
        label.appendChild(checkbox);
        if (p.avatarBlob) {
          const img = document.createElement('img');
          const url = getMediaURL(p.avatarBlob);
          img.src = url;
          img.className = 'w-6 h-6 rounded-full object-cover';
          img.onload = () => { if (isBlobURL(url)) URL.revokeObjectURL(url); };
          label.appendChild(img);
        }
        const span = document.createElement('span');
        span.textContent = p.nickname;
        label.appendChild(span);
        characterSelectionEl.appendChild(label);
      });
    }

    async function saveCurrentProfile() {
      const avatarData = {};
      document.querySelectorAll('#avatar-guided-mode select').forEach(s => {
          if(s.value) avatarData[s.name] = s.value;
      });

      const profileData = {
        fullName: document.getElementById('profile-fullname').value,
        nickname: document.getElementById('profile-nickname').value,
        birthDate: document.getElementById('profile-birthdate').value,
        birthTime: document.getElementById('profile-birthtime').value,
        iaDescription: document.getElementById('profile-ia-description').value,
        avatarData: avatarData,
        // Preservar avatar y fotos existentes
        avatarBlob: currentProfile && currentProfile.avatarBlob ? currentProfile.avatarBlob : undefined,
        photos: currentProfile && currentProfile.photos ? currentProfile.photos : []
      };
      if (currentProfile && currentProfile.id) {
        profileData.numerologyAnalysis = currentProfile.numerologyAnalysis;
        profileData.humanDesignAnalysis = currentProfile.humanDesignAnalysis;
        await update('profiles', { ...profileData, id: currentProfile.id });
        const i = profiles.findIndex(p => p.id === currentProfile.id);
        profiles[i] = { ...profileData, id: currentProfile.id };
        showNotification("Perfil actualizado.");
      } else {
        const newId = await add('profiles', profileData);
        profileData.id = newId;
        profiles.push(profileData);
        currentProfile = profileData;
        showNotification("Perfil creado.");
      }
      renderProfileSelect();
    }

    function renderNumerologyTab(data) {
      const contentEl = document.getElementById('numerology-tab-content');
      if (currentProfile.numerologyAnalysis) {
          contentEl.innerHTML = `
            <div class="p-4 bg-gray-800/50 rounded-lg text-yellow-100">
              <h4 class="font-cinzel text-yellow-200 mb-2">An√°lisis de Luz Guardado</h4>
              <div class="text-sm space-y-2">${currentProfile.numerologyAnalysis}</div>
              <button class="bg-red-500 text-white font-bold py-1 px-3 rounded-lg text-xs mt-4" onclick="deleteNumerologyAnalysis()">Eliminar y Generar Nuevo</button>
            </div>`;
          return;
      }
      contentEl.innerHTML = `
        <div class="p-4 bg-gray-800/50 rounded-lg text-yellow-100 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <h4 class="font-cinzel text-yellow-200">N√∫meros Fundamentales</h4>
            <ul class="mt-2 space-y-1 text-sm">
              <li><strong>Sendero de Vida:</strong> ${data.senderoVida}</li>
              <li><strong>Expresi√≥n:</strong> ${data.expresion}</li>
              <li><strong>Alma:</strong> ${data.alma}</li>
              <li><strong>Personalidad:</strong> ${data.personalidad}</li>
              <li><strong>D√≠a de Nacimiento:</strong> ${data.diaNacimiento.valor}</li>
            </ul>
          </div>
          <div>
            <h4 class="font-cinzel text-yellow-200">Ciclos Actuales</h4>
            <ul class="mt-2 space-y-1 text-sm">
              <li><strong>A√±o Personal:</strong> ${data.ciclos.anoPersonal}</li>
              <li><strong>Mes Personal:</strong> ${data.ciclos.mesPersonal}</li>
              <li><strong>D√≠a Personal:</strong> ${data.ciclos.diaPersonal}</li>
            </ul>
          </div>
          <div class="md:col-span-2">
            <h4 class="font-cinzel text-yellow-200">Energ√≠as K√°rmicas</h4>
            <ul class="mt-2 space-y-1 text-sm">
              <li><strong>Deudas K√°rmicas:</strong> ${data.deudasKarmicas.length ? data.deudasKarmicas.join(', ') : 'Ninguna'}</li>
              <li><strong>Lecciones K√°rmicas:</strong> ${data.leccionesKarmicas.length ? data.leccionesKarmicas.join(', ') : 'Ninguna'}</li>
            </ul>
          </div>
          <div class="md:col-span-2 text-center">
            <button class="gemini-btn text-gray-900 font-bold py-2 px-4 rounded-lg text-sm mt-4" onclick="generateNumerologyAnalysis()">‚ú® Generar An√°lisis de Luz</button>
          </div>
          <div id="numerology-analysis-result" class="md:col-span-2 mt-2 text-sm p-2 bg-gray-900/50 rounded hidden"></div>
        </div>`;
    }
    function renderHumanDesignTab(data) {
      const contentEl = document.getElementById('humandesign-tab-content');
       if (currentProfile.humanDesignAnalysis) {
          contentEl.innerHTML = `
            <div class="p-4 bg-gray-800/50 rounded-lg text-yellow-100">
              <h4 class="font-cinzel text-yellow-200 mb-2">Carta de Dise√±o Humano Guardada</h4>
              <div class="text-sm space-y-2">${currentProfile.humanDesignAnalysis}</div>
              <button class="bg-red-500 text-white font-bold py-1 px-3 rounded-lg text-xs mt-4" onclick="deleteHumanDesignAnalysis()">Eliminar y Generar Nueva</button>
            </div>`;
          return;
      }
      contentEl.innerHTML = `
        <div class="p-4 bg-gray-800/50 rounded-lg text-yellow-100">
          <h4 class="font-cinzel text-yellow-200">Tu Dise√±o Energ√©tico</h4>
          <ul class="mt-2 space-y-1 text-sm">
            <li><strong>Tipo:</strong> ${data.tipo}</li>
            <li><strong>Autoridad:</strong> ${data.autoridad}</li>
            <li><strong>Definici√≥n:</strong> ${data.definicion}</li>
          </ul>
          <div class="text-center">
            <button class="gemini-btn text-gray-900 font-bold py-2 px-4 rounded-lg text-sm mt-4" onclick="generateHumanDesignAnalysis()">‚ú® Generar Carta de Dise√±o Humano</button>
          </div>
          <div id="humandesign-analysis-result" class="mt-4 text-sm p-2 bg-gray-900/50 rounded hidden"></div>
        </div>`;
    }
    function renderCompatibilityTab() {
      const el = document.getElementById('compatibility-tab-content');
      el.innerHTML = `
        <h4 class="font-cinzel text-yellow-200 mb-2">An√°lisis de Sinergia</h4>
        <div class="flex gap-4 items-center">
          <span class="font-bold">${currentProfile.nickname}</span>
          <span>&</span>
          <select id="compatibility-profile-select" class="w-full bg-gray-700 p-2 rounded text-white">
            ${profiles.filter(p => p.id !== currentProfile.id).map(p => `<option value="${p.id}">${p.nickname}</option>`).join('')}
          </select>
        </div>
        <div class="text-center">
          <button class="gemini-btn text-gray-900 font-bold py-2 px-4 rounded-lg text-sm mt-4" onclick="generateCompatibilityAnalysis()">‚ú® Analizar Sinergia</button>
        </div>
        <div id="compatibility-analysis-result" class="mt-4 text-sm p-2 bg-gray-900/50 rounded hidden"></div>`;
    }
    
    async function renderLightMessageTab() {
      const el = document.getElementById('message-tab-content');
      el.innerHTML = `
        <h4 class="font-cinzel text-yellow-200 mb-2">Conversaci√≥n con tu Yo Superior</h4>
        <div id="chat-container" class="h-96 flex flex-col bg-gray-900/50 rounded-lg p-2">
            <div id="chat-messages" class="flex-grow overflow-y-auto space-y-4 p-2"></div>
            <form id="chat-form" class="flex gap-2 p-2 border-t border-gray-700">
                <input type="text" id="chat-input" class="w-full bg-gray-700 p-2 rounded text-white" placeholder="Escribe tu mensaje..." autocomplete="off">
                <button type="submit" class="gemini-btn text-gray-900 font-bold py-2 px-4 rounded-lg">Enviar</button>
            </form>
        </div>
      `;
      
      await loadConversation();
      document.getElementById('chat-form').addEventListener('submit', handleSendMessageToYoSuperior);
    }
    
    async function loadConversation() {
        if (!currentProfile) return;
        const messagesEl = document.getElementById('chat-messages');
        messagesEl.innerHTML = '';
        currentConversation = await getByIndex('conversations', 'profileId', currentProfile.id);
        
        currentConversation.forEach(msg => {
            const bubble = document.createElement('div');
            bubble.textContent = msg.text;
            bubble.className = `p-3 rounded-lg max-w-xs ${msg.sender === 'user' ? 'chat-bubble-user self-end' : 'chat-bubble-ai self-start'}`;
            messagesEl.appendChild(bubble);
        });
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function handleSendMessageToYoSuperior(e) {
        e.preventDefault();
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if (!text || !currentProfile) return;

        const userMessage = { profileId: currentProfile.id, sender: 'user', text, timestamp: Date.now() };
        await add('conversations', userMessage);
        currentConversation.push(userMessage);
        
        const messagesEl = document.getElementById('chat-messages');
        const userBubble = document.createElement('div');
        userBubble.textContent = text;
        userBubble.className = 'p-3 rounded-lg max-w-xs chat-bubble-user self-end';
        messagesEl.appendChild(userBubble);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        input.value = '';

        const thinkingBubble = document.createElement('div');
        thinkingBubble.innerHTML = '<span class="animate-pulse">...</span>';
        thinkingBubble.className = 'p-3 rounded-lg max-w-xs chat-bubble-ai self-start';
        messagesEl.appendChild(thinkingBubble);
        messagesEl.scrollTop = messagesEl.scrollHeight;

        const promptHistory = currentConversation.map(m => `${m.sender === 'user' ? 'Usuario' : 'Yo Superior'}: ${m.text}`).join('\n');
        const fullPrompt = `Eres el Yo Superior de ${currentProfile.nickname}, una conciencia sabia, amorosa y elevada. Tu prop√≥sito es guiar, no dar √≥rdenes. Habla con calma y perspectiva. Responde al √∫ltimo mensaje del usuario, considerando la siguiente historia de la conversaci√≥n:\n\n${promptHistory}\n\nYo Superior:`;

        try {
            const aiText = await callGeminiAPI(fullPrompt);
            const cleanedText = cleanAIText(aiText);
            const aiMessage = { profileId: currentProfile.id, sender: 'ai', text: cleanedText, timestamp: Date.now() };
            await add('conversations', aiMessage);
            currentConversation.push(aiMessage);
            
            thinkingBubble.textContent = cleanedText;
        } catch (error) {
            console.error(error);
            thinkingBubble.textContent = 'Hubo una interferencia en el canal. Intenta de nuevo.';
        }
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }


    function renderPlaceholderTabs() {
      document.getElementById('humandesign-tab-content').innerHTML    = '';
      document.getElementById('compatibility-tab-content').innerHTML  = '';
      document.getElementById('message-tab-content').innerHTML        = '';
    }
    
    // =================================================================================
    // --- OTHER FEATURES (JOURNAL, LIBRARY, CYCLES, ETC.) ---
    // =================================================================================

    function initJournal() {
      document.getElementById('save-journal-entry').addEventListener('click', saveJournalEntry);
      document.getElementById('interpret-dream-btn').addEventListener('click', interpretDream);
      renderJournalEntries();
      updateStreakDisplay();
    }
    function renderJournalEntries() {
      const listEl = document.getElementById('journal-list');
      listEl.innerHTML = '';
      journalEntries.sort((a, b) => b.date - a.date).forEach(entry => {
        const li = document.createElement('li');
        li.className = "p-2 bg-gray-800/50 rounded";
        li.innerHTML = `<p class="text-sm text-gray-400">${new Date(entry.date).toLocaleDateString()}</p><p>${entry.text}</p>`;
        listEl.appendChild(li);
      });
    }
    async function saveJournalEntry() {
      const textarea = document.getElementById('journal-entry');
      if (!textarea.value.trim()) return;
      const newEntry = { text: textarea.value, date: Date.now() };
      const id = await add('journalEntries', newEntry);
      newEntry.id = id;
      journalEntries.push(newEntry);
      textarea.value = '';
      // Actualizar racha de gratitud y gamificaci√≥n
      const today = new Date();
      const yyyyMMdd = today.toISOString().substring(0, 10);
      const yesterday = new Date(Date.now() - 86400000).toISOString().substring(0, 10);
      if (!settings.gamification) {
        settings.gamification = { streak: 0, lastGratitudeDate: null, achievements: [] };
      }
      // Incrementar racha si la entrada anterior fue ayer
      if (settings.gamification.lastGratitudeDate === yesterday) {
        settings.gamification.streak = (settings.gamification.streak || 0) + 1;
      } else if (settings.gamification.lastGratitudeDate === yyyyMMdd) {
        // misma fecha: no incrementar la racha, pero mantener valor
      } else {
        settings.gamification.streak = 1;
      }
      settings.gamification.lastGratitudeDate = yyyyMMdd;
      await update('settings', settings);
      renderJournalEntries();
      updateStreakDisplay();
      showNotification("Entrada guardada.");
    }

    function initLibrary() {
      document.getElementById('add-book-btn').addEventListener('click', () => document.getElementById('add-book-input').click());
      document.getElementById('add-book-input').addEventListener('change', handleAddBook);
      document.getElementById('book-search-btn').addEventListener('click', searchForBooks);
      renderBookList();
    }

    async function searchForBooks() {
        const input = document.getElementById('book-search-input');
        const resultsEl = document.getElementById('book-search-results');
        const query = input.value.trim();
        if (!query) {
            showNotification('Escribe el t√≠tulo de un libro para buscar.', 'err');
            return;
        }

        resultsEl.innerHTML = '<div class="flex justify-center items-center"><span class="loader"></span><span class="ml-2">Buscando en la red...</span></div>';

        try {
            const searchResults = await google_web_search({ query: `"${query}" filetype:pdf free download` });
            
            if (searchResults.results && searchResults.results.length > 0) {
                resultsEl.innerHTML = searchResults.results.slice(0, 5).map(res => `
                    <div class="p-3 bg-gray-800/50 rounded-lg">
                        <a href="${res.url}" target="_blank" class="text-yellow-300 hover:underline font-bold">${res.title}</a>
                        <p class="text-xs text-gray-400 mt-1">${res.url}</p>
                        <p class="text-sm mt-2">${res.description}</p>
                    </div>
                `).join('');
            } else {
                resultsEl.innerHTML = '<p class="text-center text-gray-500">No se encontraron resultados. Intenta con otro t√≠tulo.</p>';
            }
        } catch (error) {
            console.error("Error en la b√∫squeda de libros:", error);
            resultsEl.innerHTML = '<p class="text-center text-red-400">Ocurri√≥ un error al buscar. Por favor, intenta de nuevo.</p>';
        }
    }

    function renderBookList() {
      const listEl = document.getElementById('book-list');
      listEl.innerHTML = '';
      books.forEach(book => {
        const li = document.createElement('li');
        li.className = "flex justify-between items-center p-2 hover:bg-gray-700 rounded group";
        li.innerHTML = `
          <div>
            <span class="cursor-pointer font-bold">${book.title}</span>
            <div class="flex items-center gap-2 mt-1">
                <button class="text-xs text-purple-300 hover:underline" onclick="summarizeBook('${book.id}')">Resumir con IA</button>
            </div>
          </div>
          <div>
            <button class="text-yellow-300 opacity-50 group-hover:opacity-100 transition-opacity mr-2" onclick="viewBook(books.find(b => b.id === ${book.id}))">Leer</button>
            <button class="text-red-400 opacity-50 group-hover:opacity-100 transition-opacity" onclick="deleteBook(${book.id})">&times;</button>
          </div>
        `;
        listEl.appendChild(li);
      });
    }

    async function summarizeBook(bookId) {
        const book = books.find(b => b.id === parseInt(bookId));
        if (!book) return;

        const textToSummarize = prompt(`Resumen para "${book.title}".\n\nPara obtener el mejor resultado, pega aqu√≠ un cap√≠tulo o una secci√≥n clave del libro. La IA analizar√° el texto que proporciones.`);

        if (!textToSummarize || textToSummarize.trim().length < 100) {
            showNotification('Se necesita un texto suficientemente largo para hacer un buen resumen.', 'info');
            return;
        }

        showNotification('Generando resumen con IA...');

        try {
            const prompt = `Eres un experto en literatura y s√≠ntesis. Resume el siguiente texto de manera clara y concisa, extrayendo las ideas principales y el mensaje central. Texto: """${textToSummarize}"""`;
            const summary = await callGeminiAPI(prompt);
            
            // Mostrar el resumen en un modal
            const modal = document.getElementById('confirm-modal'); // Reutilizando un modal existente
            document.getElementById('confirm-message').innerHTML = `<h3 class="font-playfair text-xl text-yellow-200 mb-2">Resumen de ${book.title}</h3><div class="text-left text-base overflow-y-auto max-h-80">${summary.replace(/\n/g, '<br>')}</div>`;
            document.getElementById('confirm-ok').textContent = 'Cerrar';
            document.getElementById('confirm-cancel').classList.add('hidden');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            const closeAndCleanup = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.getElementById('confirm-cancel').classList.remove('hidden');
                document.getElementById('confirm-ok').textContent = 'Confirmar';
                document.getElementById('confirm-ok').removeEventListener('click', closeAndCleanup);
            };
            document.getElementById('confirm-ok').addEventListener('click', closeAndCleanup, { once: true });

        } catch (error) {
            console.error("Error al generar resumen:", error);
            showNotification('No se pudo generar el resumen.', 'err');
        }
    }
    async function handleAddBook(event) {
      const file = event.target.files[0];
      if (!file) return;
      const title = prompt("T√≠tulo del libro:", file.name.replace(/\.pdf$/i, ''));
      if (!title) return;
      const reader = new FileReader();
      reader.onload = async (e) => {
        const bookBlob = new Blob([e.target.result], { type: 'application/pdf' });
        const newBook = { title, data: bookBlob };
        const id = await add('books', newBook);
        newBook.id = id;
        books.push(newBook);
        renderBookList();
      };
      reader.readAsArrayBuffer(file);
    }
    function viewBook(book) {
      const modal = document.getElementById('book-viewer-modal');
      const url = URL.createObjectURL(book.data);
      modal.innerHTML = `<iframe src="${url}" class="w-full h-full"></iframe><button id="close-book-viewer" class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-2">&times;</button>`;
      modal.classList.remove('hidden');
      document.getElementById('close-book-viewer').addEventListener('click', () => {
        modal.classList.add('hidden');
        URL.revokeObjectURL(url); // Clean up the object URL
      });
    }
    async function deleteBook(id) {
        if (await confirmDialog('¬øEliminar este libro de la biblioteca?')) {
            await remove('books', id);
            books = books.filter(b => b.id !== id);
            renderBookList();
            showNotification('Libro eliminado.');
        }
    }

    function initSettings() {
      const toggle = document.getElementById('subliminal-toggle');
      const editor = document.getElementById('subliminal-messages-editor');
      toggle.checked = settings.subliminalEnabled ?? true;
      editor.value = (settings.subliminalMessages ?? ["Estoy en calma y en paz.", "Atraigo abundancia y prosperidad.", "Conf√≠o en mi intuici√≥n."]).join('\n');
      document.getElementById('save-subliminal-btn').addEventListener('click', saveSubliminalSettings);
      document.getElementById('export-data-btn').addEventListener('click', exportData);
      document.getElementById('import-data-btn').addEventListener('click', () => document.getElementById('import-file-input').click());
      document.getElementById('import-file-input').addEventListener('change', importData);
      document.getElementById('restore-backup-btn').addEventListener('click', restoreFromBackup);

      const durationSlider = document.getElementById('slideshow-duration');
      const durationLabel = document.getElementById('slideshow-duration-label');
      durationSlider.value = settings.slideshowDuration || 5;
      durationLabel.textContent = `${durationSlider.value}s`;
      durationSlider.addEventListener('input', (e) => {
        durationLabel.textContent = `${e.target.value}s`;
        settings.slideshowDuration = parseInt(e.target.value, 10);
        update('settings', settings);
      });

      document.getElementById('add-audio-btn').addEventListener('click', () => document.getElementById('add-audio-input').click());
      document.getElementById('add-audio-input').addEventListener('change', handleAddAudio);
      renderAudioList();
    }
    async function saveSubliminalSettings() {
      settings.subliminalEnabled = document.getElementById('subliminal-toggle').checked;
      settings.subliminalMessages = document.getElementById('subliminal-messages-editor').value.split('\n').filter(Boolean);
      await update('settings', settings);
      initSubliminalMessages();
      showNotification("Ajustes guardados.");
    }
    function renderAudioList() {
      const ul = document.getElementById('audio-list');
      ul.innerHTML = '';
      audioFiles.forEach((a, idx) => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between bg-gray-800/40 p-2 rounded';
        li.innerHTML = `
          <span class="truncate">${a.name}</span>
          <div class="flex items-center gap-2">
            <button class="text-yellow-300 hover:text-white text-xs px-2 py-1 bg-gray-700 rounded" data-play="${idx}">‚ñ∂Ô∏è</button>
            <button class="text-red-300 hover:text-white text-xs px-2 py-1 bg-gray-700 rounded" data-del="${a.id}">üóëÔ∏è</button>
          </div>`;
        ul.appendChild(li);
      });
      ul.querySelectorAll('[data-play]').forEach(btn => btn.addEventListener('click', e => {
        currentSongIndex = parseInt(e.currentTarget.dataset.play, 10);
        playSong(audioFiles[currentSongIndex], true);
      }));
      ul.querySelectorAll('[data-del]').forEach(btn => btn.addEventListener('click', async e => {
        const id = parseInt(e.currentTarget.dataset.del, 10);
        if (await confirmDialog('¬øEliminar esta canci√≥n?')) {
            await remove('audio', id);
            audioFiles = audioFiles.filter(a => a.id !== id);
            renderAudioList();
            showNotification('Canci√≥n eliminada.');
        }
      }));
    }
    async function handleAddAudio(e) {
      const file = e.target.files[0];
      if (!file) return;
      const name = prompt('Nombre para la canci√≥n:', file.name.replace(/\.[^.]+$/, '')) || file.name;
      const reader = new FileReader();
      reader.onload = async (ev) => {
        const audioBlob = new Blob([ev.target.result], { type: file.type });
        const item = { name, data: audioBlob };
        const id = await add('audio', item);
        item.id = id;
        audioFiles.push(item);
        renderAudioList();
        showNotification('Canci√≥n a√±adida.');
      };
      reader.readAsArrayBuffer(file);
      e.target.value = '';
    }

    async function exportData() {
      showNotification('Preparando exportaci√≥n...');
      const allData = {};
      for(const storeName of STORES) {
        allData[storeName] = await getAll(storeName);
      }
      const snapshot = {
        meta: { exportedAt: new Date().toISOString(), dbName: DB_NAME, version: DB_VERSION },
        ...allData
      };
      const content = JSON.stringify(snapshot, (key, value) => {
          if (value instanceof Blob) {
              return { _isBlob: true, type: value.type, size: value.size };
          }
          return value;
      }, 2);
      const filename = `mila-universo-${new Date().toISOString().replace(/[:.]/g, '-')}.milaverse`;
      downloadBlob(content, filename, 'application/json');
      showNotification('Universo exportado.');
    }
    async function importData(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (!await confirmDialog('Importar un universo reemplazar√° todos los datos actuales. ¬øContinuar?')) {
          e.target.value = '';
          return;
      }
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (!data || !data.meta) throw new Error('Archivo inv√°lido');

        showNotification('Importando... Esto puede tardar.');
        await Promise.all(STORES.map(store => clearStore(store)));

        for(const storeName of STORES) {
            if(Array.isArray(data[storeName])) {
                for (const it of data[storeName]) {
                    await add(storeName, it);
                }
            }
        }
        
        showNotification('Universo importado ‚úîÔ∏è Recargando...');
        setTimeout(() => window.location.reload(), 1500);

      } catch (err) {
        console.error('Error importando:', err);
        showNotification('No se pudo importar el archivo.');
      } finally {
        e.target.value = '';
      }
    }
    function downloadBlob(content, filename, type = 'application/json') {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    // =================================================================================
    // --- GEMINI AI INTEGRATION ---
    // =================================================================================
    
    // Helper para convertir data URL a Blob
    const dataURLtoBlob = (dataURL)=>{
      const [meta, data] = dataURL.split(',');
      const mime = meta.match(/data:(.*?);/)[1] || 'application/octet-stream';
      const bin = atob(data); const arr = new Uint8Array(bin.length);
      for (let i=0;i<bin.length;i++) arr[i] = bin.charCodeAt(i);
      return new Blob([arr], {type: mime});
    };

    /**
     * Convierte un Blob a una cadena base64 (sin prefijo de data URL).
     * Esto se utiliza para enviar im√°genes de perfiles como referencia a la API de Gemini.
     * @param {Blob} blob El archivo de imagen a convertir
     * @returns {Promise<string>} Una promesa que resuelve en la cadena base64 sin el prefijo
     */
    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const result = reader.result;
          // reader.result es algo como "data:image/png;base64,iVBORw0K..."
          const base64 = result.split(',')[1] || '';
          resolve(base64);
        };
        reader.onerror = (err) => reject(err);
        reader.readAsDataURL(blob);
      });
    }

    async function callGeminiAPI(prompt, expectJson = false) {
      const apiUrl = `/api/gemini`; // Cambiado para funcionar en Glitch
      const payload = { prompt, expectJson };
      
      const response = await fetch(apiUrl, { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify(payload)
      });

      if (!response.ok) {
        const errorBody = await response.text();
        console.error("API Error Response:", errorBody);
        throw new Error(`API Error: ${response.statusText}`);
      }

      const result = await response.json();
      // El servidor de Glitch ahora devuelve el texto directamente o el JSON parseado
      return expectJson ? result : result.text;
    }

    async function generateImageWithGemini(prompt) {
      // NOTA: La generaci√≥n de im√°genes con la API gratuita de Gemini es compleja.
      // El servidor de Glitch simular√° la respuesta con una imagen de placeholder.
      // Para una generaci√≥n real, se necesitar√≠a una API de pago o un flujo m√°s complejo.
      // Por ahora, esto permite que la app no se rompa.
      // La funcionalidad de "Editar con IA" tambi√©n usar√° este placeholder.

      const response = await fetch('/api/gemini/generate-image', { // Cambiado para funcionar en Glitch
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });

        if (!response.ok) {
          const err = await response.json();
          console.error("Error de Gemini Image API:", err);
          throw new Error(err.error || 'La API de Gemini Image devolvi√≥ un error.');
        }

        const data = await response.json();
        if (data.imageDataUrl) {
          return data.imageDataUrl;
        } else {
          throw new Error('La respuesta de la API no conten√≠a una URL de imagen.');
        }
    }

    async function editImageWithGemini(sourceImageBlob, textPrompt) {
        // Simulaci√≥n: devolvemos una imagen de placeholder como en la generaci√≥n.
        const placeholderUrl = `https://via.placeholder.com/512x512.png?text=Edici√≥n:+${encodeURIComponent(textPrompt.substring(0, 30))}...`;
        const fetchRes = await fetch(placeholderUrl);
        const blob = await fetchRes.blob();
        return blob;
    }


    async function generateNumerologyAnalysis() {
      if (!currentProfile || !currentProfile.fullData) return;
      const resultContainer = document.getElementById('numerology-analysis-result');
      resultContainer.classList.remove('hidden');
      resultContainer.innerHTML = '<span class="loader"></span> Canalizando sabidur√≠a...';
      const data = currentProfile.fullData;
      const prompt = `Act√∫a como un numer√≥logo espiritual y sabio. Proporciona un an√°lisis profundo y positivo para una persona llamada ${currentProfile.nickname}. Sus n√∫meros son: Sendero de Vida ${data.senderoVida}, Expresi√≥n ${data.expresion}, Alma ${data.alma}, y Personalidad ${data.personalidad}. Explica la sinergia entre estos n√∫meros, sus dones principales y un consejo para alinear su energ√≠a. Formatea la respuesta con saltos de l√≠nea para que sea legible.`;
      try { 
          const analysis = await callGeminiAPI(prompt); 
          const formattedAnalysis = cleanAIText(analysis).replace(/\n/g, '<br>');
          resultContainer.innerHTML = `
              <div class="text-sm space-y-2">${formattedAnalysis}</div>
              <button class="bg-green-500 text-white font-bold py-1 px-3 rounded-lg text-xs mt-4" onclick="saveNumerologyAnalysis()">Guardar An√°lisis</button>
          `;
          sparkleGenieButton();
      } 
      catch { resultContainer.innerHTML = 'No se pudo canalizar el mensaje. Int√©ntalo de nuevo.'; }
    }
    
    async function saveNumerologyAnalysis() {
        const analysisText = document.querySelector('#numerology-analysis-result > div').innerHTML;
        currentProfile.numerologyAnalysis = analysisText;
        await update('profiles', currentProfile);
        showNotification('An√°lisis de Luz guardado.');
        renderProfileDetails();
    }

    async function deleteNumerologyAnalysis() {
        if (await confirmDialog('¬øEst√°s segura de que quieres eliminar este an√°lisis?')) {
            delete currentProfile.numerologyAnalysis;
            await update('profiles', currentProfile);
            showNotification('An√°lisis eliminado.');
            renderProfileDetails();
        }
    }

    async function generateHumanDesignAnalysis() {
      if (!currentProfile || !currentProfile.fullData) return;
      const resultContainer = document.getElementById('humandesign-analysis-result');
      resultContainer.classList.remove('hidden');
      resultContainer.innerHTML = '<span class="loader"></span> Interpretando el dise√±o energ√©tico...';
      const data = currentProfile.fullData.disenoHumano;
      const prompt = `Act√∫a como un gu√≠a espiritual experto en Dise√±o Humano. Para una persona llamada ${currentProfile.nickname}, explica de forma clara y motivadora qu√© significa ser un ${data.tipo} con autoridad ${data.autoridad}. Ofr√©cele un consejo pr√°ctico sobre c√≥mo honrar su estrategia y tomar decisiones alineadas con su ser.`;
      try { 
          const analysis = await callGeminiAPI(prompt); 
          const formattedAnalysis = cleanAIText(analysis).replace(/\n/g, '<br>');
          resultContainer.innerHTML = `
            <div class="text-sm space-y-2">${formattedAnalysis}</div>
            <button class="bg-green-500 text-white font-bold py-1 px-3 rounded-lg text-xs mt-4" onclick="saveHumanDesignAnalysis()">Guardar Carta</button>
          `;
          sparkleGenieButton();
      } 
      catch { resultContainer.innerHTML = 'No se pudo interpretar el dise√±o. Int√©ntalo de nuevo.'; }
    }

    async function saveHumanDesignAnalysis() {
        const analysisText = document.querySelector('#humandesign-analysis-result > div').innerHTML;
        currentProfile.humanDesignAnalysis = analysisText;
        await update('profiles', currentProfile);
        showNotification('Carta de Dise√±o Humano guardada.');
        renderProfileDetails();
    }

    async function deleteHumanDesignAnalysis() {
        if (await confirmDialog('¬øEst√°s segura de que quieres eliminar esta carta?')) {
            delete currentProfile.humanDesignAnalysis;
            await update('profiles', currentProfile);
            showNotification('Carta eliminada.');
            renderProfileDetails();
        }
    }

    async function generateCompatibilityAnalysis() {
      const secondProfileId = parseInt(document.getElementById('compatibility-profile-select').value);
      const secondProfile = await get('profiles', secondProfileId);
      if (!currentProfile || !secondProfile) return;
      const resultContainer = document.getElementById('compatibility-analysis-result');
      resultContainer.classList.remove('hidden');
      resultContainer.innerHTML = '<span class="loader"></span> Analizando la sinergia...';

      const data1 = currentProfile.fullData;
      const data2 = await numerologyCalculator.calcularTodo(secondProfile.fullName, secondProfile.nickname, secondProfile.birthDate, secondProfile.birthTime, 'Caracas');
      const prompt = `Act√∫a como un consejero de relaciones espiritual y numer√≥logo. Analiza la sinergia entre ${currentProfile.nickname} y ${secondProfile.nickname}.
- ${currentProfile.nickname} tiene Sendero de Vida ${data1.senderoVida} y Expresi√≥n ${data1.expresion}.
- ${secondProfile.nickname} tiene Sendero de Vida ${data2.senderoVida} y Expresi√≥n ${data2.expresion}.
Describe los puntos fuertes de su conexi√≥n, las √°reas de crecimiento potencial y un consejo para armonizar sus energ√≠as.`;
      try { const analysis = await callGeminiAPI(prompt); resultContainer.innerHTML = cleanAIText(analysis).replace(/\n/g, '<br>'); sparkleGenieButton(); } 
      catch { resultContainer.innerHTML = 'No se pudo analizar la sinergia. Int√©ntalo de nuevo.'; }
    }
    
    async function generateDreamStepsWithGemini() {
      if (!currentDream) return;
      const btn = document.getElementById('gemini-steps-btn');
      btn.disabled = true; btn.innerHTML = '<span class="loader"></span>';
      const prompt = `Act√∫a como un coach de manifestaci√≥n experto. Para el sue√±o "${currentDream.name}", genera una lista JSON de 5 pasos accionables. Cada paso debe ser claro, conciso, inspirador y pr√°ctico. Responde √∫nicamente con un objeto JSON que contenga un array llamado 'steps', donde cada elemento es un objeto con una propiedad 'text'.`;
      try {
        const result = await callGeminiAPI(prompt, true);
        if (result.steps && result.steps.length > 0) {
          const newSteps = result.steps.map(step => ({ text: step.text, completed: false }));
          currentDream.steps = [...(currentDream.steps || []), ...newSteps];
          await update('dreams', currentDream);
          renderSteps();
          showNotification("¬°Pasos m√°gicos a√±adidos!");
          sparkleGenieButton();
        }
      } catch (error) {
        console.error("Error con Gemini:", error);
        showNotification("No se pudo generar la inspiraci√≥n.");
      } finally {
        btn.disabled = false; btn.textContent = "‚ú® Inspiraci√≥n M√°gica";
      }
    }
    
    function renderImagePortalForDream() {
      // --- Reset and Setup --- 
      const characterSelectionEl = document.getElementById('image-character-selection');
      const clothingSelectionEl  = document.getElementById('clothing-style-selection');
      const artStyleSelectionEl  = document.getElementById('art-style-selection');
      const colorSelectionEl     = document.getElementById('color-selection');
      const emotionSelectionEl   = document.getElementById('emotion-selection');
      const sceneDescriptionEl   = document.getElementById('dream-scene-description');
      const finalPromptEl        = document.getElementById('final-prompt-for-ia');

      // Reset fields
      sceneDescriptionEl.value = '';
      finalPromptEl.value = '';

      // --- Render & Setup Buttons --- 
      // Render character selection with avatar thumbnails
      renderCharacterSelection();
      
      const setupButtonSelection = (container, isMultiSelect = false) => {
        const buttons = container.querySelectorAll('button');
        buttons.forEach(button => {
          button.classList.remove('bg-yellow-600'); // Reset selection
          button.onclick = () => {
            if (!isMultiSelect) {
              buttons.forEach(btn => btn.classList.remove('bg-yellow-600'));
            }
            button.classList.toggle('bg-yellow-600');
            buildFinalPrompt(); // Re-build prompt on any selection change
          };
        });
      };

      setupButtonSelection(clothingSelectionEl);
      setupButtonSelection(artStyleSelectionEl);
      // Configurar selecci√≥n para paleta de colores y emoci√≥n
      setupButtonSelection(colorSelectionEl);
      setupButtonSelection(emotionSelectionEl);
      // Re-build prompt on text input (character checkboxes already call buildFinalPrompt in renderCharacterSelection)
      sceneDescriptionEl.oninput = buildFinalPrompt;

      // Main action buttons
      document.getElementById('refine-description-btn').onclick = refineDescriptionWithAI;
      document.getElementById('translate-prompt-btn').onclick = translateFinalPromptToSpanish;
      document.getElementById('generate-image-btn').onclick = generateImageFromPrompt;
      document.getElementById('generate-from-variation-btn').onclick = generateImageFromPrompt; // <-- FIX: Connect button
      document.getElementById('download-gallery-zip-btn').onclick = downloadGalleryAsZip;

      // Media buttons
      document.getElementById('select-media-btn').onclick = () => document.getElementById('upload-media-input').click();
      document.getElementById('paste-media-btn').onclick = pasteImageFromClipboard;
      document.getElementById('upload-media-input').onchange = handleMediaUpload;
      
      renderDreamMediaGallery();
      buildFinalPrompt(); // Initial prompt build
    }

    async function refineDescriptionWithAI() {
        const sceneEl = document.getElementById('dream-scene-description');
        const refineBtn = document.getElementById('refine-description-btn');
        if (!sceneEl.value.trim()) {
            showNotification("Primero escribe una idea base en la descripci√≥n.", "err");
            return;
        }

        refineBtn.disabled = true;
        refineBtn.innerHTML = '<span class="loader"></span> Generando Variaciones...';

        try {
            await generatePromptVariations();
            sparkleGenieButton();
        } catch (error) {
            console.error("Error generating prompt variations:", error);
            showNotification("No se pudieron generar las variaciones de prompt.", "err");
        } finally {
            refineBtn.disabled = false;
            refineBtn.innerHTML = "‚ú® Refinar Descripci√≥n con IA";
        }
    }

    async function generatePromptVariations() {
        const sceneDescription = document.getElementById('dream-scene-description').value.trim();
        const container  = document.getElementById('prompt-variations-container');
        const grid       = document.getElementById('prompt-variations-grid');

        // Reconstruir el prompt final para asegurar que se incluyan todas las selecciones
        await buildFinalPrompt();
        const finalPrompt = document.getElementById('final-prompt-for-ia').value.trim();

        // Recopilar descripciones de personajes seleccionados
        const selectedCharCheckboxes = document.querySelectorAll('#image-character-selection input:checked');
        let characterDescriptions = [];
        for (const checkbox of selectedCharCheckboxes) {
            const profile = await get('profiles', parseInt(checkbox.value));
            if (profile && profile.iaDescription) {
                characterDescriptions.push(profile.iaDescription);
            }
        }

        // Prompt para solicitar variaciones a la API de Gemini
        const prompt = `Eres un experto en ingenier√≠a de prompts para IA generadora de im√°genes. Basado en la siguiente idea y personajes, genera 6 prompts creativos y diferentes en espa√±ol. Devuelve un objeto JSON con una clave "variations" que sea un array de 6 strings. Idea base: "${sceneDescription}". Personajes: "${characterDescriptions.join(', ')}"`;

        let variationsObj;
        try {
            variationsObj = await callGeminiAPI(prompt, true);
        } catch (err) {
            console.warn('Fallo en la generaci√≥n con Gemini, usando variaciones locales:', err);
            // Variaciones de respaldo locales basadas en el prompt final y la selecci√≥n de emoci√≥n
            const emotionBtn = document.querySelector('#emotion-selection .bg-yellow-600');
            const emotionName = emotionBtn ? emotionBtn.dataset.emotion.toLowerCase() : 'inspiraci√≥n';
            const localVariations = [
                finalPrompt,
                `${finalPrompt}, cinem√°tico, alta definici√≥n, iluminaci√≥n dram√°tica`,
                `${finalPrompt}, estilo art√≠stico, pintura surrealista`,
                `${finalPrompt}, evocando sentimientos de ${emotionName}`,
                `${finalPrompt}, collage de fotos, m√∫ltiples marcos combinados`,
                `${finalPrompt}, representaci√≥n simb√≥lica, simbolismo espiritual`
            ];
            variationsObj = { variations: localVariations };
            // Mostrar un aviso de que se us√≥ el fallback
            showNotification('Se generaron variaciones de forma local.', 'info');
        }

        grid.innerHTML = '';
        variationsObj.variations.forEach(variation => {
            const btn = document.createElement('button');
            btn.className = 'text-xs bg-gray-700 p-2 rounded hover:bg-yellow-700/50';
            btn.textContent = variation;
            btn.onclick = () => {
                // 1. Resaltar la intenci√≥n seleccionada
                grid.querySelectorAll('button').forEach(b => b.classList.remove('bg-yellow-600'));
                btn.classList.add('bg-yellow-600');
                
                // 2. Copiar el texto de esa intenci√≥n al √°rea de "Prompt Final"
                document.getElementById('final-prompt-for-ia').value = variation;
                
                // 3. Hacer visible el bot√≥n "Generar Imagen con Intenci√≥n Seleccionada"
                document.getElementById('generate-from-variation-btn').classList.remove('hidden');
            };
            grid.appendChild(btn);
        });

        container.classList.remove('hidden');
        document.getElementById('final-prompt-container').classList.add('hidden');
    }

    async function buildFinalPrompt() {
        const finalPromptEl = document.getElementById('final-prompt-for-ia');
        const sceneDescription = document.getElementById('dream-scene-description').value.trim();
        
        const selectedCharCheckboxes = document.querySelectorAll('#image-character-selection input:checked');
        const selectedClothingBtn = document.querySelector('#clothing-style-selection .bg-yellow-600');
        const selectedArtStyleBtn = document.querySelector('#art-style-selection .bg-yellow-600');

        let promptParts = [];

        // 1. Scene Description (most important)
        if (sceneDescription) {
            promptParts.push(sceneDescription);
        }

        // 2. Character Descriptions (critical)
        for (const checkbox of selectedCharCheckboxes) {
            const profile = await get('profiles', parseInt(checkbox.value));
            if (profile && profile.iaDescription) {
                promptParts.push(profile.iaDescription);
            }
        }

        // 3. Clothing Style
        if (selectedClothingBtn) {
            promptParts.push(`wearing ${selectedClothingBtn.dataset.style.toLowerCase()} style clothing`);
        }

        // 4. Art Style
        if (selectedArtStyleBtn) {
            promptParts.push(selectedArtStyleBtn.dataset.style);
        }

        // 5. Color Palette
        const selectedColorBtn  = document.querySelector('#color-selection .bg-yellow-600');
        if (selectedColorBtn) {
            // A√±ade una descripci√≥n de tonos o paleta de colores
            const colorName = selectedColorBtn.dataset.color.toLowerCase();
            promptParts.push(`tonos ${colorName}`);
        }

        // 6. Emotion / Mood
        const selectedEmotionBtn = document.querySelector('#emotion-selection .bg-yellow-600');
        if (selectedEmotionBtn) {
            const emotionName = selectedEmotionBtn.dataset.emotion.toLowerCase();
            promptParts.push(`evoking a sense of ${emotionName}`);
        }

        // Join all parts into a single, comma-separated block
        finalPromptEl.value = promptParts.join(', ');
    }

    async function translateFinalPromptToSpanish() {
        const finalPrompt = document.getElementById('final-prompt-for-ia').value;
        if (!finalPrompt) {
            showNotification("No hay prompt para traducir.", "err");
            return;
        }
        showNotification("Traduciendo para tu revisi√≥n...");
        try {
            const prompt = `Translate the following English text to Spanish: "${finalPrompt}"`;
            const spanishText = await callGeminiAPI(prompt);
            
            // Use the new text viewer modal
            const modal = document.getElementById('text-viewer-modal');
            document.getElementById('text-viewer-title').textContent = "Traducci√≥n del Prompt";
            document.getElementById('text-viewer-content').innerHTML = cleanAIText(spanishText).replace(/\n/g, '<br>');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            document.getElementById('close-text-viewer-modal').onclick = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            };
            sparkleGenieButton();

        } catch (error) {
            showNotification("No se pudo traducir.", "err");
        }
    }

    async function generateImageFromPrompt() {
        const finalPrompt = document.getElementById('final-prompt-for-ia').value;
        const generateBtn = document.getElementById('generate-image-btn');
        const generateVariationBtn = document.getElementById('generate-from-variation-btn');

        if (!finalPrompt) {
            showNotification("El prompt final est√° vac√≠o.", "err");
            return;
        }

        generateBtn.disabled = true;
        generateVariationBtn.disabled = true;
        generateBtn.innerHTML = '<span class="loader"></span> Generando...';
        generateVariationBtn.innerHTML = '<span class="loader"></span> Generando...';
        showNotification("Generando imagen con Gemini... Esto puede tardar un momento.");

        try {
            // Recopilar im√°genes de referencia de los personajes seleccionados
            const selectedCharCheckboxes = document.querySelectorAll('#image-character-selection input:checked');
            const refImages = [];
            for (const checkbox of selectedCharCheckboxes) {
                const profile = await get('profiles', parseInt(checkbox.value));
                if (profile && profile.avatarBlob instanceof Blob) {
                    try {
                        const base64 = await blobToBase64(profile.avatarBlob);
                        refImages.push(base64);
                    } catch (err) {
                        console.warn('No se pudo convertir una imagen de perfil a base64:', err);
                    }
                }
            }

            // Llamar a la API de generaci√≥n de im√°genes con prompt e im√°genes de referencia
            let imageDataUrl;
            
                const response = await fetch('http://localhost:3000/api/gemini/generate-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: finalPrompt, refImages })
                });
                if (!response.ok) {
                    throw new Error('La API de Gemini Image devolvi√≥ un error');
                }
                const data = await response.json();
                imageDataUrl = data.imageDataUrl;
                if (!imageDataUrl) {
                    throw new Error('La respuesta de la API no conten√≠a una URL de imagen.');
                }
            
            const fetchRes = await fetch(imageDataUrl);
            const blob = await fetchRes.blob();

            currentDream.images = [...(currentDream.images || []), { type: 'image/png', data: blob }];
            await update('dreams', currentDream);

            renderDreamMediaGallery();
            showNotification("¬°Imagen m√°gica a√±adida a tu galer√≠a!", "ok");
            sparkleGenieButton();

        } catch (error) {
            console.error("Image generation error:", error);
            showNotification("No se pudo crear la imagen. Puedes copiar el prompt y la imagen de referencia.", "err");
            // Fallback: Abrir tutorial externo con el prompt y la primera imagen de referencia (si existe)
            openExternalPromptTutorial(finalPrompt);
        } finally {
            generateBtn.disabled = false;
            generateVariationBtn.disabled = false;
            generateBtn.innerHTML = '‚ú® Generar Imagen';
            generateVariationBtn.innerHTML = '‚ú® Generar Imagen con Intenci√≥n Seleccionada';
        }
    }

    async function downloadGalleryAsZip() {
        if (!currentDream || !currentDream.images || currentDream.images.length === 0) {
            showNotification("No hay im√°genes en la galer√≠a para descargar.", "err");
            return;
        }

        showNotification("Preparando archivo .zip...");
        const zip = new JSZip();
        const imgFolder = zip.folder(currentDream.name.replace(/\s+/g, '_'));

        for (let i = 0; i < currentDream.images.length; i++) {
            const mediaItem = currentDream.images[i];
            const fileExtension = mediaItem.type.split('/')[1] || 'file';
            imgFolder.file(`vision_${i + 1}.${fileExtension}`, mediaItem.data);
        }

        zip.generateAsync({ type: "blob" }).then(content => {
            const filename = `MilaUniverso_${currentDream.name.replace(/\s+/g, '_')}.zip`;
            downloadBlob(content, filename, 'application/zip');
            showNotification("¬°Tu .zip est√° listo!");
        });
    }

    function renderDreamMediaGallery() {
        const galleryEl = document.getElementById('dream-media-gallery');
        galleryEl.innerHTML = '';
        (currentDream.images || []).forEach((mediaItem, index) => {
            const mediaContainer = document.createElement('div');
            mediaContainer.className = 'relative w-full h-32 bg-gray-700 rounded-lg overflow-hidden cursor-pointer';
            
            const url = getMediaURL(mediaItem.data);

            if (mediaItem.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = url;
                img.className = 'w-full h-full object-cover rounded-lg';
                img.onload = () => { if (isBlobURL(url)) URL.revokeObjectURL(url); }; // Clean up
                mediaContainer.appendChild(img);
            } else if (mediaItem.type.startsWith('video/')) {
                const video = document.createElement('video');
                video.src = url;
                video.className = 'w-full h-full object-cover rounded-lg';
                video.muted = true; video.loop = true;
                mediaContainer.onmouseenter = () => video.play();
                mediaContainer.onmouseleave = () => video.pause();
                mediaContainer.oncanplay = () => { if (isBlobURL(url)) URL.revokeObjectURL(url); }; // Clean up
                mediaContainer.appendChild(video);
            }

            mediaContainer.onclick = () => showMediaViewer(currentDream.images, index);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-80 hover:opacity-100';
            deleteBtn.innerHTML = '&times;';
            deleteBtn.onclick = async (e) => {
                e.stopPropagation();
                if (await confirmDialog('¬øEliminar este elemento?')) {
                    currentDream.images.splice(index, 1);
                    await update('dreams', currentDream);
                    renderDreamMediaGallery();
                    showNotification('Elemento eliminado.');
                }
            };
            mediaContainer.appendChild(deleteBtn);
            galleryEl.appendChild(mediaContainer);
        });
    }

        function showImageGenerationFallback(prompt) {
        const modal = document.getElementById('fallback-modal');
        const promptTextarea = document.getElementById('fallback-prompt');
        promptTextarea.value = prompt;
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        document.getElementById('close-fallback-modal').onclick = () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };
    }

    

    async function handleMediaUpload(event) {
        const files = event.target.files;
        if (!files.length) return;

        for (const file of files) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const blob = new Blob([e.target.result], { type: file.type });
                currentDream.images = [...(currentDream.images || []), { type: file.type, data: blob }];
                await update('dreams', currentDream);
                renderDreamMediaGallery();
            };
            reader.readAsArrayBuffer(file);
        }
        showNotification(`${files.length} archivo(s) a√±adido(s) a la galer√≠a!`);
        event.target.value = '';
    }
    
    // =================================================================================
    // --- MEDIA VIEWER LOGIC (CON EDICI√ìN IA) ---
    // =================================================================================
    let viewerState = {
        media: [],
        originalMedia: [],
        currentIndex: 0,
        isLooping: false,
        isShuffled: false,
        slideshowTimeout: null,
        touchStartX: 0,
        touchEndX: 0,
        currentObjectURL: null,
    };

    function initMediaViewer() {
        const modal = document.getElementById('media-viewer-modal');
        const contentArea = document.getElementById('viewer-content-area');
        
        document.getElementById('close-media-viewer-btn').addEventListener('click', closeMediaViewer);
        document.getElementById('viewer-next-btn').addEventListener('click', () => changeMedia(1));
        document.getElementById('viewer-prev-btn').addEventListener('click', () => changeMedia(-1));
        document.getElementById('viewer-loop-btn').addEventListener('click', toggleViewerLoop);
        document.getElementById('viewer-shuffle-btn').addEventListener('click', toggleViewerShuffle);
        document.getElementById('viewer-fullscreen-btn').addEventListener('click', toggleViewerFullscreen);
        document.getElementById('viewer-img').addEventListener('click', toggleZoom);
        document.getElementById('viewer-edit-btn').addEventListener('click', handleViewerEdit);

        
        contentArea.addEventListener('touchstart', e => { viewerState.touchStartX = e.changedTouches[0].screenX; }, { passive: true });
        contentArea.addEventListener('touchend', e => {
            viewerState.touchEndX = e.changedTouches[0].screenX;
            handleSwipeGesture();
        }, { passive: true });
    }

    function showMediaViewer(mediaList, startIndex = 0) {
        if (!mediaList || mediaList.length === 0) return;
        
        viewerState.media = [...mediaList];
        viewerState.originalMedia = [...mediaList];
        viewerState.currentIndex = startIndex;
        viewerState.isShuffled = false;
        
        document.getElementById('media-viewer-modal').classList.remove('hidden');
        document.getElementById('media-viewer-modal').classList.add('flex');
        
        updateViewerButtons();
        renderCurrentMedia();
    }

    function closeMediaViewer() {
        clearTimeout(viewerState.slideshowTimeout);
        document.getElementById('media-viewer-modal').classList.add('hidden');
        document.getElementById('media-viewer-modal').classList.remove('flex');
        
        const videoEl = document.getElementById('viewer-video');
        videoEl.pause();
        videoEl.src = '';
        
        if (viewerState.currentObjectURL) {
            URL.revokeObjectURL(viewerState.currentObjectURL);
            viewerState.currentObjectURL = null;
        }

        if (document.fullscreenElement) document.exitFullscreen();
    }

    function renderCurrentMedia() {
        clearTimeout(viewerState.slideshowTimeout);
        if (viewerState.currentObjectURL) {
            URL.revokeObjectURL(viewerState.currentObjectURL);
            viewerState.currentObjectURL = null;
        }

        const mediaItem = viewerState.media[viewerState.currentIndex];
        const imgEl = document.getElementById('viewer-img');
        const videoEl = document.getElementById('viewer-video');
        const editControls = document.getElementById('viewer-edit-controls');
        
        imgEl.style.opacity = 0;
        videoEl.style.opacity = 0;

        setTimeout(() => {
            imgEl.classList.add('hidden');
            videoEl.classList.add('hidden');
            editControls.classList.add('hidden');
            videoEl.pause();

            const url = getMediaURL(mediaItem.data);
            viewerState.currentObjectURL = isBlobURL(url) ? url : null;

            if (mediaItem.type.startsWith('image/')) {
                imgEl.src = url;
                imgEl.classList.remove('hidden');
                editControls.classList.remove('hidden');
                requestAnimationFrame(() => imgEl.style.opacity = 1);

                if (viewerState.isLooping) {
                    const duration = (settings.slideshowDuration || 5) * 1000;
                    viewerState.slideshowTimeout = setTimeout(() => changeMedia(1), duration);
                }
            } else if (mediaItem.type.startsWith('video/')) {
                videoEl.src = url;
                videoEl.classList.remove('hidden');
                videoEl.play().catch(e => console.error("Video autoplay failed:", e));
                requestAnimationFrame(() => videoEl.style.opacity = 1);

                if (viewerState.isLooping) {
                    videoEl.onended = () => changeMedia(1);
                } else {
                    videoEl.onended = null;
                }
            }
        }, 300);
    }

    async function handleViewerEdit() {
        const btn = document.getElementById('viewer-edit-btn');
        const promptInput = document.getElementById('viewer-edit-prompt');
        const prompt = promptInput.value.trim();
        if (!prompt) {
            showNotification("Escribe c√≥mo quieres editar la imagen.", "err");
            return;
        }

        const originalBtnText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="loader"></span>';

        try {
            const currentMediaItem = viewerState.media[viewerState.currentIndex];
            const sourceBlob = currentMediaItem.data;
            
            const newBlob = await editImageWithGemini(sourceBlob, prompt);

            // Actualizar el item en la base de datos
            currentMediaItem.data = newBlob;
            currentMediaItem.type = newBlob.type;
            await update('dreams', currentDream);

            // Refrescar la vista
            renderCurrentMedia();
            renderDreamMediaGallery(); // Actualizar la miniatura en la galer√≠a
            sparkleGenieButton();
            showNotification("¬°Imagen editada con IA! ‚ú®");
            promptInput.value = "";

        } catch (error) {
            console.error("Error editando imagen:", error);
            showNotification("No se pudo editar la imagen.", "err");
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalBtnText;
        }
    }

    function changeMedia(direction) {
        const newIndex = viewerState.currentIndex + direction;
        if (newIndex >= viewerState.media.length) {
            viewerState.currentIndex = 0;
        } else if (newIndex < 0) {
            viewerState.currentIndex = viewerState.media.length - 1;
        } else {
            viewerState.currentIndex = newIndex;
        }
        renderCurrentMedia();
    }

    function toggleViewerLoop() {
        viewerState.isLooping = !viewerState.isLooping;
        updateViewerButtons();
        if (viewerState.isLooping) {
            renderCurrentMedia();
        } else {
            clearTimeout(viewerState.slideshowTimeout);
        }
    }
    
    function toggleViewerShuffle() {
        viewerState.isShuffled = !viewerState.isShuffled;
        if (viewerState.isShuffled) {
            let shuffled = [...viewerState.originalMedia];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            const currentItem = viewerState.media[viewerState.currentIndex];
            const newFirstIndex = shuffled.findIndex(item => (item.data instanceof Blob ? item.data.size === currentItem.data.size : item.data === currentItem.data));
            if (newFirstIndex > 0) {
                [shuffled[0], shuffled[newFirstIndex]] = [shuffled[newFirstIndex], shuffled[0]];
            }
            viewerState.media = shuffled;
            viewerState.currentIndex = 0;
        } else {
            const currentItem = viewerState.media[viewerState.currentIndex];
            viewerState.media = [...viewerState.originalMedia];
            viewerState.currentIndex = viewerState.media.findIndex(item => (item.data instanceof Blob ? item.data.size === currentItem.data.size : item.data === currentItem.data));
        }
        updateViewerButtons();
        renderCurrentMedia();
    }

    function updateViewerButtons() {
        document.getElementById('viewer-loop-btn').classList.toggle('viewer-btn-active', viewerState.isLooping);
        document.getElementById('viewer-shuffle-btn').classList.toggle('viewer-btn-active', viewerState.isShuffled);
        document.getElementById('viewer-particles').classList.toggle('hidden', !viewerState.isLooping);
    }

    function toggleZoom(e) {
        e.currentTarget.parentElement.classList.toggle('zoomed');
    }

    function toggleViewerFullscreen() {
        const modal = document.getElementById('media-viewer-modal');
        if (!document.fullscreenElement) {
            modal.requestFullscreen().catch(err => {
                alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
            });
        } else {
            document.exitFullscreen();
        }
    }

    function handleSwipeGesture() {
        if (viewerState.touchEndX < viewerState.touchStartX - 50) {
            changeMedia(1);
        }
        if (viewerState.touchEndX > viewerState.touchStartX + 50) {
            changeMedia(-1);
        }
    }

    // =================================================================================
    // --- UTILITIES & HELPERS ---
    // =================================================================================
    
    function getMediaURL(data) {
        if (data instanceof Blob) {
            return URL.createObjectURL(data);
        }
        return data;
    }

    function isBlobURL(url) {
        return url.startsWith('blob:');
    }

    function cleanAIText(text) {
        if (!text) return '';
        return text
            .replace(/(\*\*|__)(.*?)\1/g, '$2')
            .replace(/(\*|_)(.*?)\1/g, '$2')
            .replace(/`{1,3}(.*?)`{1,3}/g, '$1')
            .replace(/---/g, '')
            .replace(/#/g, '')
            .replace(/^\s*[\*+-]\s/gm, '‚Ä¢ ')
            .trim();
    }

    function confirmDialog(message) {
      return new Promise(resolve => {
        const modal = document.getElementById('confirm-modal');
        document.getElementById('confirm-message').textContent = message;
        modal.classList.remove('hidden'); modal.classList.add('flex');
        const clean = (v) => () => { modal.classList.add('hidden'); modal.classList.remove('flex'); resolve(v); off(); };
        const off = () => {
          ok.removeEventListener('click', yes);
          cancel.removeEventListener('click', no);
        };
        const ok = document.getElementById('confirm-ok');
        const cancel = document.getElementById('confirm-cancel');
        const yes = clean(true), no = clean(false);
        ok.addEventListener('click', yes); cancel.addEventListener('click', no);
      });
    }

    function makeDraggable(element, id) {
      let longPressTimer;
      let isDragging = false;
      
      element.style.touchAction = 'none';

      const onPointerDown = (e) => {
        if (e.button !== 0 && e.pointerType === 'mouse') return;
        
        element.oncontextmenu = (e) => e.preventDefault();

        const startX = e.clientX;
        const startY = e.clientY;
        isDragging = false;

        longPressTimer = setTimeout(() => {
          if (!isDragging) {
            showContextMenu(e.clientX, e.clientY, id);
          }
        }, 500);
        
        const cosmosEl = document.getElementById('cosmos');
        const rect = cosmosEl.getBoundingClientRect();
        let offsetX = e.clientX - element.getBoundingClientRect().left;
        let offsetY = e.clientY - element.getBoundingClientRect().top;

        const onPointerMove = (e) => {
          const distance = Math.hypot(e.clientX - startX, e.clientY - startY);
          if (distance > 10 || isDragging) {
            isDragging = true;
            clearTimeout(longPressTimer);
            element.style.animationName = 'none';
            
            let x = e.clientX - rect.left - offsetX;
            let y = e.clientY - rect.top - offsetY;
            
            x = Math.max(0, Math.min(x, rect.width - element.offsetWidth));
            y = Math.max(0, Math.min(y, rect.height - element.offsetHeight));
            
            element.style.left = `${(x / rect.width) * 100}%`;
            element.style.top  = `${(y / rect.height) * 100}%`;
          }
        };

        const onPointerUp = async (e) => {
          clearTimeout(longPressTimer);
          document.removeEventListener('pointermove', onPointerMove);
          document.removeEventListener('pointerup', onPointerUp);
          
          if (isDragging) {
            element.style.animationName = 'float-animation';
            const dream = dreams.find(d => d.id === id);
            if (dream) { 
              dream.position = { 
                x: parseFloat(element.style.left), 
                y: parseFloat(element.style.top) 
              }; 
              await update('dreams', dream); 
            }
          } else {
            handleDreamClick(id);
          }
          element.oncontextmenu = null;
        };

        document.addEventListener('pointermove', onPointerMove);
        document.addEventListener('pointerup', onPointerUp);
      };

      element.addEventListener('pointerdown', onPointerDown);
    }
    
    function makePlayerDraggable(element) {
      let isDragging = false;
      let offsetX, offsetY;

      const onPointerDown = (e) => {
        if (e.target.closest('button, input[type="range"], #progress-bar-container')) {
          return;
        }
        
        isDragging = true;
        const rect = element.getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;
        
        element.style.cursor = 'grabbing';
        document.addEventListener('pointermove', onPointerMove);
        document.addEventListener('pointerup', onPointerUp);
      };

      const onPointerMove = (e) => {
        if (!isDragging) return;
        
        let x = e.clientX - offsetX;
        let y = e.clientY - offsetY;

        x = Math.max(0, Math.min(x, window.innerWidth - element.offsetWidth));
        y = Math.max(0, Math.min(y, window.innerHeight - element.offsetHeight));

        element.style.left = `${x}px`;
        element.style.top = `${y}px`;
        element.style.bottom = 'auto';
        element.style.right = 'auto';
      };

      const onPointerUp = () => {
        isDragging = false;
        element.style.cursor = 'grab';
        document.removeEventListener('pointermove', onPointerMove);
        document.removeEventListener('pointerup', onPointerUp);
      };

      element.addEventListener('pointerdown', onPointerDown);
      element.style.cursor = 'grab';
    }
    
    // --- Subliminales
    let subliminalInterval;
    function initSubliminalMessages() {
      if (subliminalInterval) clearInterval(subliminalInterval);
      if (settings.subliminalEnabled && settings.subliminalMessages?.length > 0) {
        subliminalInterval = setInterval(() => {
          const container = document.getElementById('subliminal-container');
          const message = settings.subliminalMessages[Math.floor(Math.random() * settings.subliminalMessages.length)];
          const positions = [{ top: '5%', left: '5%' }, { top: '5%', right: '5%' }, { bottom: '25%', left: '5%' }, { bottom: '25%', right: '5%' }];
          const pos = positions[Math.floor(Math.random() * positions.length)];
          container.style.top = pos.top || ''; container.style.left = pos.left || '';
          container.style.bottom = pos.bottom || ''; container.style.right = pos.right || '';
          container.textContent = message;
          container.classList.add('subliminal-show');
          container.addEventListener('animationend', () => container.classList.remove('subliminal-show'), { once: true });
        }, 15000);
      }
    }

    // --- Audio
    function initAudioPlayer() {
      audioPlayer   = document.getElementById('global-audio-player');
      currentSongEl = document.getElementById('current-song');
      loopBtn       = document.getElementById('loop-btn');
      volumeSlider  = document.getElementById('volume-slider');
      const playPauseBtn = document.getElementById('play-pause-btn');
      const playIcon = document.getElementById('play-icon');
      const pauseIcon = document.getElementById('pause-icon');
      const progressBarContainer = document.getElementById('progress-bar-container');
      const progressBar = document.getElementById('progress-bar');

      document.getElementById('next-btn').addEventListener('click', () => playNext(true));
      document.getElementById('prev-btn').addEventListener('click', () => playPrev(true));
      loopBtn.addEventListener('click', toggleLoop);
      audioPlayer.addEventListener('ended', onSongEnded);
      volumeSlider.addEventListener('input', (e) => (audioPlayer.volume = e.target.value));
      
      playPauseBtn.addEventListener('click', () => {
        if (audioPlayer.paused) {
          audioPlayer.play().catch(()=>{});
        } else {
          audioPlayer.pause();
        }
      });

      audioPlayer.addEventListener('play', () => {
        playIcon.classList.add('hidden');
        pauseIcon.classList.remove('hidden');
      });

      audioPlayer.addEventListener('pause', () => {
        playIcon.classList.remove('hidden');
        pauseIcon.classList.add('hidden');
      });

      audioPlayer.addEventListener('timeupdate', () => {
        const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
        progressBar.style.width = `${progress}%`;
      });

      progressBarContainer.addEventListener('click', (e) => {
        const rect = progressBarContainer.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const width = progressBarContainer.clientWidth;
        const duration = audioPlayer.duration;
        audioPlayer.currentTime = (clickX / width) * duration;
      });

      const song = audioFiles[currentSongIndex];
      if (song) {
        playSong(song);
      }

      if (window.__shouldAutoplayOnInit) {
        audioPlayer.play().catch(() => {});
      } else {
        const unlock = () => {
          if (audioPlayer && audioPlayer.paused) audioPlayer.play().catch(()=>{});
          window.removeEventListener('pointerdown', unlock);
        };
        window.addEventListener('pointerdown', unlock, { once: true });
      }
      makePlayerDraggable(document.getElementById('player-footer'));
    }
    async function unlockAudioAndMedia() {
      try {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (AC) {
          const ctx = window.__audioCtx || new AC();
          window.__audioCtx = ctx;
          if (ctx.state !== 'running') await ctx.resume();
        }
      } catch {}
      if (audioPlayer) {
        try { await audioPlayer.play(); } catch {}
      }
    }
    function playSong(song, shouldAutoplay = false) {
      if (!song) return;
      const url = getMediaURL(song.data);
      audioPlayer.src = url;
      audioPlayer.oncanplay = () => { if(isBlobURL(url)) URL.revokeObjectURL(url); };
      currentSongEl.textContent = song.name;
      if (shouldAutoplay) audioPlayer.play().catch(()=>{});
    }
    function toggleLoop() { isLooping = !isLooping; audioPlayer.loop = isLooping; loopBtn.classList.toggle('text-yellow-500', isLooping); }
    function playNext(autoplay = false) { if (!audioFiles.length) return; currentSongIndex = (currentSongIndex + 1) % audioFiles.length; playSong(audioFiles[currentSongIndex], autoplay); }
    function playPrev(autoplay = false) { if (!audioFiles.length) return; currentSongIndex = (currentSongIndex - 1 + audioFiles.length) % audioFiles.length; playSong(audioFiles[currentSongIndex], autoplay); }
    function onSongEnded() { if (!isLooping) playNext(true); }
    
    // --- Vision Board
    let vbSelectedItem = null;
    function openVisionBoardEditor() {
        const editor = document.getElementById('vision-board-editor');
        editor.classList.remove('hidden'); editor.classList.add('flex');
        
        const palette = document.getElementById('vb-image-palette');
        palette.innerHTML = '';
        (currentDream.images || []).filter(item => item.type.startsWith('image/')).forEach(imgItem => {
            const thumb = document.createElement('img');
            const url = getMediaURL(imgItem.data);
            thumb.src = url;
            thumb.className = 'w-full h-auto rounded-md mb-2 cursor-pointer hover:opacity-80';
            thumb.draggable = true;
            
            // Almacenar el √≠ndice del item de datos original para referencia
            const originalIndex = currentDream.images.indexOf(imgItem);
            thumb.dataset.originalIndex = originalIndex;

            thumb.ondragstart = (e) => {
                e.dataTransfer.setData('application/json', JSON.stringify({ originalIndex }));
            };
            thumb.onload = () => { if (isBlobURL(url)) URL.revokeObjectURL(url); };
            palette.appendChild(thumb);
        });

        document.getElementById('vb-close-btn').onclick = () => { editor.classList.add('hidden'); editor.classList.remove('flex'); };
        
        const canvas = document.getElementById('vision-board-canvas');
        canvas.ondragover = (e) => e.preventDefault();
        canvas.ondrop = (e) => {
            e.preventDefault();
            const { originalIndex } = JSON.parse(e.dataTransfer.getData('application/json'));
            if (originalIndex !== undefined) {
                const rect = canvas.getBoundingClientRect();
                const scale = 1 / 0.5; // El canvas est√° escalado al 50%
                const x = (e.clientX - rect.left) * scale;
                const y = (e.clientY - rect.top) * scale;
                addVisionBoardItem({ type: 'image', originalIndex, x, y, width: 300, height: 200 });
            }
        };

        document.getElementById('vb-add-text-btn').onclick = () => addVisionBoardItem({ type: 'text', text: 'Escribe aqu√≠...', x: 50, y: 50, width: 150, height: 50, color: '#FFFFFF' });
        
        document.getElementById('vb-download-btn').onclick = () => {
            html2canvas(document.getElementById('vision-board-canvas')).then(canvas => {
                const link = document.createElement('a');
                link.download = `${currentDream.name.replace(/\s+/g, '_')}_MapaDeSue√±os.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        };
        
        canvas.innerHTML = '';
        (currentDream.visionBoardData || []).forEach(itemData => addVisionBoardItem(itemData, false));
    }

    function addVisionBoardItem(data, isNew = true) {
        const canvas = document.getElementById('vision-board-canvas');
        const item = document.createElement('div');
        item.className = 'vision-board-item';
        item.style.left = `${data.x}px`; item.style.top = `${data.y}px`;
        item.style.width = `${data.width}px`; item.style.height = `${data.height}px`;

        if (data.type === 'image') {
            const img = document.createElement('img');
            const originalImageItem = currentDream.images[data.originalIndex];
            if (!originalImageItem) return; // No a√±adir si la imagen original no existe

            const url = getMediaURL(originalImageItem.data);
            img.src = url;
            img.dataset.originalIndex = data.originalIndex;
            img.onload = () => { if (isBlobURL(url)) URL.revokeObjectURL(url); };
            item.appendChild(img);
        } else if (data.type === 'text') {
            const textEl = document.createElement('div'); textEl.contentEditable = true;
            textEl.className = 'vision-board-text'; textEl.textContent = data.text;
            textEl.style.color = data.color; item.appendChild(textEl);
        }
        
        const handle = document.createElement('div'); handle.className = 'resize-handle'; item.appendChild(handle);
        makeItemInteractive(item);
        canvas.appendChild(item);
    }

    function makeItemInteractive(element) {
        const onSelect = () => {
            document.querySelectorAll('.vision-board-item').forEach(el => el.classList.remove('vb-selected'));
            element.classList.add('vb-selected');
            vbSelectedItem = element;
            document.getElementById('vb-context-toolbar').style.display = 'flex';
        };

        element.addEventListener('mousedown', (e) => {
            onSelect();
            if (e.target.classList.contains('resize-handle') || e.target.isContentEditable) return;
            let offsetX = e.clientX - element.offsetLeft; let offsetY = e.clientY - element.offsetTop;
            const onMouseMove = (moveEvent) => {
                element.style.left = `${moveEvent.clientX - offsetX}px`; element.style.top = `${moveEvent.clientY - offsetY}px`;
            };
            const onMouseUp = () => { document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp); };
            document.addEventListener('mousemove', onMouseMove); document.addEventListener('mouseup', onMouseUp);
        });

        const handle = element.querySelector('.resize-handle');
        handle.onmousedown = (e) => {
            e.stopPropagation();
            onSelect();
            const startX = e.clientX; const startY = e.clientY;
            const startWidth = element.offsetWidth; const startHeight = element.offsetHeight;
            const onMouseMove = (moveEvent) => {
                element.style.width = `${startWidth + moveEvent.clientX - startX}px`; element.style.height = `${startHeight + moveEvent.clientY - startY}px`;
            };
            const onMouseUp = () => { document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp); };
            document.addEventListener('mousemove', onMouseMove); document.addEventListener('mouseup', onMouseUp);
        };
    }

    document.getElementById('vb-edit-btn').addEventListener('click', async () => {
        if (!vbSelectedItem) return;
        const imgEl = vbSelectedItem.querySelector('img');
        if (!imgEl) {
            showNotification("Solo se pueden editar im√°genes.", "err");
            return;
        }

        const promptInput = document.getElementById('vb-edit-prompt');
        const prompt = promptInput.value.trim();
        if (!prompt) {
            showNotification("Escribe un prompt para editar la imagen.", "err");
            return;
        }

        const btn = document.getElementById('vb-edit-btn');
        const originalBtnText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="loader"></span>';

        try {
            const originalIndex = parseInt(imgEl.dataset.originalIndex, 10);
            const sourceBlob = currentDream.images[originalIndex].data;
            
            const newBlob = await editImageWithStability(sourceBlob, prompt);

            // A√±adir la nueva imagen a la galer√≠a del sue√±o y obtener su nuevo √≠ndice
            const newImageItem = { type: newBlob.type, data: newBlob };
            currentDream.images.push(newImageItem);
            await update('dreams', currentDream);
            const newIndex = currentDream.images.length - 1;

            // Actualizar la imagen en el lienzo
            const newUrl = URL.createObjectURL(newBlob);
            imgEl.src = newUrl;
            imgEl.dataset.originalIndex = newIndex; // Apuntar al nuevo √≠ndice
            
            showNotification("Imagen editada en el lienzo. ‚ú®");
            promptInput.value = "";
            openVisionBoardEditor(); // Refrescar la paleta

        } catch (error) {
            console.error("Error editando en vision board:", error);
            showNotification("No se pudo editar la imagen.", "err");
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalBtnText;
        }
    });
    
    
    function showCelebration() {
      const celebrationEl = document.getElementById('celebration-modal');
      celebrationEl.classList.remove('hidden'); celebrationEl.innerHTML = '';
      for (let i = 0; i < 100; i++) {
        const confetti = document.createElement('div');
        confetti.style.position = 'absolute';
        confetti.style.width = `${Math.random() * 10 + 5}px`;
        confetti.style.height = `${Math.random() * 10 + 5}px`;
        confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
        confetti.style.left = `${Math.random() * 100}%`;
        confetti.style.top = '-20px';
        confetti.style.animation = `fall ${Math.random() * 2 + 3}s linear ${Math.random() * 2}s infinite`;
        celebrationEl.appendChild(confetti);
      }
      const style = document.createElement('style');
      if (!document.getElementById('fall-animation-style')) {
        style.id = 'fall-animation-style';
        style.innerHTML = `@keyframes fall { to { transform: translateY(100vh) rotate(720deg); opacity: 0; } }`;
        document.head.appendChild(style);
      }
      setTimeout(() => { celebrationEl.classList.add('hidden'); celebrationEl.innerHTML = ''; }, 5000);
    }

    // --- Interpretaci√≥n de sue√±os
    async function interpretDream() {
      const input = document.getElementById('dream-journal-entry');
      const out = document.getElementById('dream-interpretation-result');
      const text = (input.value || '').trim();
      out.classList.remove('hidden');

      if (!text) { out.innerHTML = '<p class="text-yellow-200">Primero escribe tu sue√±o ‚úçÔ∏è</p>'; return; }
      out.innerHTML = '<span class="loader"></span> Interpretando s√≠mbolos...';

      const prompt = `Eres un analista on√≠rico claro y positivo. Interpreta el siguiente sue√±o identificando s√≠mbolos, temas, un significado y acciones sugeridas. Devuelve SOLO un JSON v√°lido con las claves: "symbols" (array de strings), "themes" (array de strings), "meaning" (string), "actions" (array de strings). Sue√±o: """${text}"""`;
      try { const ai = await callGeminiAPI(prompt, true); renderDreamInterpretation(ai, out); sparkleGenieButton(); }
      catch (e) {
        console.warn('IA no disponible, usando interpretaci√≥n local:', e);
        out.innerHTML = 'Hubo un error al contactar al asistente. Intenta de nuevo.';
      }
    }
    function renderDreamInterpretation(data, out) {
      out.innerHTML = `
        <div class="space-y-3">
          <div><h4 class="font-cinzel text-yellow-200 mb-1">S√≠mbolos</h4><div class="flex flex-wrap gap-2">${(data.symbols || []).map(s => `<span class="px-2 py-1 bg-gray-700 rounded text-xs">${escapeHTML(s)}</span>`).join('')}</div></div>
          <div><h4 class="font-cinzel text-yellow-200 mb-1">Temas</h4><div class="flex flex-wrap gap-2">${(data.themes || []).map(t => `<span class="px-2 py-1 bg-gray-700/70 rounded text-xs">${escapeHTML(t)}</span>`).join('')}</div></div>
          <div><h4 class="font-cinzel text-yellow-200 mb-1">Significado</h4><p class="text-yellow-100 leading-relaxed">${escapeHTML(data.meaning)}</p></div>
          <div><h4 class="font-cinzel text-yellow-200 mb-1">Acciones</h4><ul class="list-disc list-inside space-y-1">${(data.actions || []).map(a => `<li>${escapeHTML(a)}</li>`).join('')}</ul></div>
        </div>`;
    }
    function escapeHTML(s) { return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

    // --- Extras: Ciclos y Abundancia
    function initCycles() {
      const out = document.getElementById('cycle-healing-result');
      const txt = document.getElementById('cycle-description');
      document.getElementById('hooponopono-btn').addEventListener('click', async () => {
        out.classList.remove('hidden'); out.innerHTML = '<span class="loader"></span> Invocando el santuario...';
        const prompt = `Act√∫a como gu√≠a amoroso de Ho'oponopono. Redacta 4 pasos breves para transmutar el siguiente ciclo con gratitud, perd√≥n y amor. Cierra con una afirmaci√≥n. Texto: """${txt.value}"""`;
        try { const res = await callGeminiAPI(prompt); out.innerHTML = cleanAIText(res).replace(/\n/g,'<br>'); sparkleGenieButton(); } 
        catch { out.innerHTML = '1) Lo siento. 2) Perd√≥name. 3) Te amo. 4) Gracias.<br><em>Declaro que suelto este ciclo con amor.</em>'; }
      });
      document.getElementById('quantum-btn').addEventListener('click', async () => {
        out.classList.remove('hidden'); out.innerHTML = '<span class="loader"></span> Abriendo visualizaci√≥n...';
        const prompt = `Eres un coach de visualizaci√≥n creativa. En 6-8 l√≠neas, gu√≠a una visualizaci√≥n cu√°ntica breve para transformar: """${txt.value}""" Enf√≥cate en sensaciones y respiraci√≥n.`;
        try { const res = await callGeminiAPI(prompt); out.innerHTML = cleanAIText(res).replace(/\n/g,'<br>'); sparkleGenieButton(); } 
        catch { out.innerHTML = 'Cierra los ojos, respira profundo 4 veces, imagina la situaci√≥n resuelta con paz y gratitud en tu pecho. Sost√©n la imagen por 30 segundos. Abre los ojos y sonr√≠e.'; }
      });
    }

    function initAbundance() {
      // Billetera
      document.getElementById('request-abundance-btn').addEventListener('click', () => handleAbundanceRequest('billetera'));
      renderAbundanceTransactions();
      updateWalletBalance();

      // Cheque C√≥smico
      document.getElementById('cheque-date').textContent = new Date().toLocaleDateString('es-ES');
      const chequeAmountInput = document.getElementById('cheque-amount');
      // FIX: Removed problematic real-time formatting listener.
      chequeAmountInput.addEventListener('input', () => {
        const amount = chequeAmountInput.value.replace(/[^0-9]/g, '');
        document.getElementById('cheque-amount-text').textContent = amount ? numeroALetras(amount) : '';
      });
      document.getElementById('submit-cosmic-check').addEventListener('click', () => handleAbundanceRequest('cheque'));

      // Galer√≠a
      document.getElementById('generate-abundance-image-btn').addEventListener('click', generateAbundanceImage);
      renderAbundanceGallery();
    }

    async function handleAbundanceRequest() {
        const amountEl = document.getElementById('abundance-amount');
        const purposeEl = document.getElementById('abundance-purpose');
        const btn = document.getElementById('request-abundance-btn');
        const originalBtnText = btn.textContent;

        const amount = parseFloat(amountEl.value);
        const purpose = purposeEl.value.trim();

        if (isNaN(amount) || amount <= 0 || !purpose) {
            showNotification('Por favor, ingresa un monto y prop√≥sito v√°lidos.');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="loader"></span> Enviando...';

        try {
            const prompt = `Act√∫a como el Banco del Universo. Un usuario llamado Mila est√° solicitando ${amount.toLocaleString('es-ES')} Monedas de Luz (LC) para "${purpose}". Redacta una confirmaci√≥n de transacci√≥n creativa y alentadora en formato de "correo de confirmaci√≥n". Incluye afirmaciones positivas relacionadas con su prop√≥sito. El tono debe ser m√°gico, abundante y de apoyo. Finaliza con un 'estado' de la transacci√≥n. Responde √∫nicamente con un objeto JSON que contenga las claves "message" (el texto de la confirmaci√≥n en formato string con saltos de l√≠nea \\n) y "status" (el estado, que siempre debe ser 'EN CAMINO').`;
            
            const response = await callGeminiAPI(prompt, true);
            
            const newTransaction = {
                amount: amount,
                purpose: purpose,
                message: response.message,
                status: 'EN CAMINO', // We use the status from the AI or default to it
                date: Date.now()
            };

            const newId = await add('abundanceTransactions', newTransaction);
            newTransaction.id = newId;
            abundanceTransactions.push(newTransaction);

            renderAbundanceTransactions();
            updateWalletBalance();
            showNotification('¬°Pedido c√≥smico enviado!');
            sparkleGenieButton();
            amountEl.value = '';
            purposeEl.value = '';
            
            // Simulate the Universe "processing" the request
            const randomDelay = Math.random() * (25000 - 10000) + 10000; // 10-25 seconds
            setTimeout(async () => {
                const txToUpdate = abundanceTransactions.find(t => t.id === newId);
                if (txToUpdate) {
                    txToUpdate.status = 'ACREDITADO';
                    await update('abundanceTransactions', txToUpdate);
                    showNotification(`¬°Fondos para "${txToUpdate.purpose}" han sido acreditados!`);
                    renderAbundanceTransactions();
                    updateWalletBalance();
                }
            }, randomDelay);

        } catch (error) {
            console.error("Error al solicitar abundancia:", error);
            showNotification('Hubo una interferencia en el canal c√≥smico. Int√©ntalo de nuevo.');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalBtnText;
        }
    }

    async function handleAbundanceRequest(source) {
        let amount, purpose, btn, originalBtnText;

        if (source === 'billetera') {
            amount = parseFloat(document.getElementById('abundance-amount').value);
            purpose = document.getElementById('abundance-purpose').value.trim();
            btn = document.getElementById('request-abundance-btn');
        } else { // cheque
            amount = parseFloat(document.getElementById('cheque-amount').value.replace(/[^0-9]/g, ''));
            purpose = document.getElementById('cheque-memo').value.trim();
            const signature = document.getElementById('cheque-signature').value.trim();
            btn = document.getElementById('submit-cosmic-check');
            if (!signature) {
                showNotification('El cheque debe estar firmado para sellar tu intenci√≥n.', 'err');
                return;
            }
            if (!purpose) purpose = "Mi m√°s alto bien y el de todos los involucrados";
        }
        
        originalBtnText = btn.innerHTML;

        if (isNaN(amount) || amount <= 0 || !purpose) {
            showNotification('Por favor, completa la informaci√≥n con una intenci√≥n y monto v√°lidos.', 'err');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="loader"></span> Enviando...';

        try {
            const prompt = `Act√∫a como el Banco del Universo. Un usuario llamado Mila est√° solicitando ${amount.toLocaleString('es-ES')} Monedas de Luz (LC) para \"${purpose}\". Redacta una confirmaci√≥n de transacci√≥n creativa y alentadora en formato de \"correo de confirmaci√≥n\". Incluye afirmaciones positivas relacionadas con su prop√≥sito. El tono debe ser m√°gico, abundante y de apoyo. Finaliza con un 'estado' de la transacci√≥n. Responde √∫nicamente con un objeto JSON que contenga las claves "message" (el texto de la confirmaci√≥n en formato string con saltos de l√≠nea \n) y "status" (el estado, que siempre debe ser 'EN CAMINO').`;
            const response = await callGeminiAPI(prompt, true);
            
            const newTransaction = { amount, purpose, message: response.message, status: 'EN CAMINO', date: Date.now() };
            const newId = await add('abundanceTransactions', newTransaction);
            newTransaction.id = newId;
            abundanceTransactions.push(newTransaction);

            renderAbundanceTransactions();
            updateWalletBalance();
            showNotification('¬°Pedido c√≥smico enviado!');
            sparkleGenieButton();
            
            if (source === 'billetera') {
                document.getElementById('abundance-amount').value = '';
                document.getElementById('abundance-purpose').value = '';
            } else {
                document.getElementById('cheque-amount').value = '';
                document.getElementById('cheque-memo').value = '';
                document.getElementById('cheque-signature').value = '';
                document.getElementById('cheque-amount-text').textContent = '';
            }
            
            const randomDelay = Math.random() * (25000 - 10000) + 10000;
            setTimeout(async () => {
                const txToUpdate = abundanceTransactions.find(t => t.id === newId);
                if (txToUpdate) {
                    txToUpdate.status = 'ACREDITADO';
                    await update('abundanceTransactions', txToUpdate);
                    showNotification(`¬°Fondos para \"${txToUpdate.purpose}\" han sido acreditados!`);
                    renderAbundanceTransactions();
                    updateWalletBalance();
                }
            }, randomDelay);

        } catch (error) {
            console.error("Error al solicitar abundancia:", error);
            showNotification('Hubo una interferencia en el canal c√≥smico. Int√©ntalo de nuevo.', 'err');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalBtnText;
        }
    }

    async function generateAbundanceImage() {
        const btn = document.getElementById('generate-abundance-image-btn');
        const promptInput = document.getElementById('abundance-gallery-prompt');
        const prompt = promptInput.value.trim();

        if (!prompt) {
            showNotification("Describe la visi√≥n de abundancia que quieres crear.", "err");
            return;
        }

        const originalBtnText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="loader"></span> Creando...';

        try {
            const finalPrompt = `Abundance, prosperity, wealth. ${prompt}. Cinematic, high detail, epic, masterpiece.`;
            const imageBase64 = await generateImageWithGemini(finalPrompt);
            const fetchRes = await fetch(imageBase64);
            const blob = await fetchRes.blob();

            const newImage = { type: 'image/png', data: blob, dreamId: 'abundance_gallery' }; // Special ID
            await add('dreams', newImage); // Re-using dreams store for simplicity

            renderAbundanceGallery();
            showNotification("¬°Visi√≥n de abundancia creada!");
            sparkleGenieButton();
            promptInput.value = '';

        } catch (error) {
            console.error("Error generando imagen de abundancia:", error);
            showNotification("No se pudo crear la visi√≥n. Int√©ntalo de nuevo.", "err");
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalBtnText;
        }
    }

    async function renderAbundanceGallery() {
        const galleryEl = document.getElementById('abundance-gallery-grid');
        const abundanceImages = await getAll('dreams').then(d => d.filter(item => item.dreamId === 'abundance_gallery'));
        
        galleryEl.innerHTML = '';
        if (abundanceImages.length === 0) {
            galleryEl.innerHTML = '<p class="text-center text-gray-500 col-span-full">Tu galer√≠a de visi√≥n est√° esperando tus creaciones.</p>';
            return;
        }

        abundanceImages.forEach((mediaItem) => {
            const mediaContainer = document.createElement('div');
            mediaContainer.className = 'relative w-full h-32 bg-gray-700 rounded-lg overflow-hidden cursor-pointer';
            const url = getMediaURL(mediaItem.data);
            const img = document.createElement('img');
            img.src = url;
            img.className = 'w-full h-full object-cover';
            img.onload = () => { if (isBlobURL(url)) URL.revokeObjectURL(url); };
            mediaContainer.appendChild(img);
            galleryEl.appendChild(mediaContainer);
        });
    }

    const numeroALetras = (function() {
        function Unidades(num){
            switch(num) {
                case 1: return 'UN'; case 2: return 'DOS'; case 3: return 'TRES'; case 4: return 'CUATRO'; case 5: return 'CINCO';
                case 6: return 'SEIS'; case 7: return 'SIETE'; case 8: return 'OCHO'; case 9: return 'NUEVE';
            }
            return '';
        }
        function Decenas(num){
            let decena = Math.floor(num/10); let unidad = num - (decena * 10);
            switch(decena) {
                case 1:
                    switch(unidad) {
                        case 0: return 'DIEZ'; case 1: return 'ONCE'; case 2: return 'DOCE'; case 3: return 'TRECE';
                        case 4: return 'CATORCE'; case 5: return 'QUINCE'; default: return 'DIECI' + Unidades(unidad);
                    }
                case 2: return unidad === 0 ? 'VEINTE' : 'VEINTI' + Unidades(unidad);
                case 3: return DecenasY('TREINTA', unidad); case 4: return DecenasY('CUARENTA', unidad);
                case 5: return DecenasY('CINCUENTA', unidad); case 6: return DecenasY('SESENTA', unidad);
                case 7: return DecenasY('SETENTA', unidad); case 8: return DecenasY('OCHENTA', unidad);
                case 9: return DecenasY('NOVENTA', unidad);
                case 0: return Unidades(unidad);
            }
        }
        function DecenasY(strSin, numUnidades) { return strSin + (numUnidades > 0 ? ' Y ' + Unidades(numUnidades) : ''); }
        function Centenas(num) {
            let centenas = Math.floor(num / 100); let decenas = num - (centenas * 100);
            switch(centenas) {
                case 1: if (decenas > 0) return 'CIENTO ' + Decenas(decenas); return 'CIEN';
                case 2: return 'DOSCIENTOS ' + Decenas(decenas); case 3: return 'TRESCIENTOS ' + Decenas(decenas);
                case 4: return 'CUATROCIENTOS ' + Decenas(decenas); case 5: return 'QUINIENTOS ' + Decenas(decenas);
                case 6: return 'SEISCIENTOS ' + Decenas(decenas); case 7: return 'SETECIENTOS ' + Decenas(decenas);
                case 8: return 'OCHOCIENTOS ' + Decenas(decenas); case 9: return 'NOVECIENTOS ' + Decenas(decenas);
            }
            return Decenas(decenas);
        }
        function Seccion(num, divisor, strSingular, strPlural) {
            let cientos = Math.floor(num / divisor); let resto = num - (cientos * divisor);
            let letras = '';
            if (cientos > 0)
                if (cientos > 1) letras = Centenas(cientos) + ' ' + strPlural;
                else letras = strSingular;
            if (resto > 0) letras += '';
            return letras;
        }
        function Miles(num) {
            let divisor = 1000; let cientos = Math.floor(num / divisor); let resto = num - (cientos * divisor);
            let strMiles = Seccion(num, divisor, 'UN MIL', 'MIL');
            let strCentenas = Centenas(resto);
            if(strMiles == '') return strCentenas;
            return strMiles + ' ' + strCentenas;
        }
        function Millones(num) {
            let divisor = 1000000; let cientos = Math.floor(num / divisor); let resto = num - (cientos * divisor);
            let strMillones = Seccion(num, divisor, 'UN MILLON DE', 'MILLONES DE');
            let strMiles = Miles(resto);
            if(strMillones == '') return strMiles;
            return strMillones + ' ' + strMiles;
        }
        return function NumeroALetras(num, currency) {
            currency = currency || {};
            let data = { numero: num, enteros: Math.floor(num), centavos: (((Math.round(num * 100)) - (Math.floor(num) * 100))),
                letrasCentavos: '',
                letrasMonedaPlural: currency.plural || '', letrasMonedaSingular: currency.singular || '',
                letrasMonedaCentavoPlural: currency.centPlural || '', letrasMonedaCentavoSingular: currency.centSingular || ''
            };
            if (data.centavos > 0) data.letrasCentavos = 'CON ' + Millones(data.centavos) + ' ' + (data.centavos == 1 ? data.letrasMonedaCentavoSingular : data.letrasMonedaCentavoPlural);
            if(data.enteros == 0) return 'CERO ' + data.letrasMonedaPlural + ' ' + data.letrasCentavos;
            if (data.enteros == 1) return Millones(data.enteros) + ' ' + data.letrasMonedaSingular + ' ' + data.letrasCentavos;
            else return Millones(data.enteros) + ' ' + data.letrasMonedaPlural + ' ' + data.letrasCentavos;
        };
    })();

    function renderAbundanceTransactions() {
        const historyEl = document.getElementById('transaction-history');
        historyEl.innerHTML = '';
        if (abundanceTransactions.length === 0) {
            historyEl.innerHTML = `<p class="text-center text-gray-400">No hay transacciones a√∫n.</p>`;
            return;
        }
        abundanceTransactions.sort((a, b) => b.date - a.date).forEach(tx => {
            const item = document.createElement('div');
            item.className = 'transaction-item p-3';
            const statusClass = tx.status === 'ACREDITADO' ? 'status-acreditado' : 'status-en-camino';
            const statusText = tx.status === 'ACREDITADO' ? 'Acreditado' : 'En Camino';
            
            item.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-bold text-white">${tx.purpose}</p>
                        <p class="text-xs text-gray-400">${new Date(tx.date).toLocaleString()}</p>
                    </div>
                    <div class="text-right flex-shrink-0 ml-4">
                        <p class="font-bold text-lg text-green-400">+${tx.amount.toLocaleString('es-ES')} LC</p>
                        <p class="text-xs ${statusClass}">${statusText}</p>
                    </div>
                </div>
                ${tx.message ? `<div class="transaction-message text-sm mt-3 p-3 rounded-md">${tx.message.replace(/\n/g, '<br>')}</div>` : ''}
            `;
            historyEl.appendChild(item);
        });
    }

    function updateWalletBalance() {
        const balanceEl = document.getElementById('wallet-balance');
        const total = abundanceTransactions
            .filter(tx => tx.status === 'ACREDITADO')
            .reduce((sum, tx) => sum + tx.amount, 0);
        
        const startValue = parseFloat(balanceEl.textContent.replace(/[^0-9,-]+/g,"").replace(',','.')) || 0;
        const endValue = total;
        const duration = 1000;
        let startTime = null;

        function animate(currentTime) {
            if (!startTime) startTime = currentTime;
            const progress = Math.min((currentTime - startTime) / duration, 1);
            const value = startValue + (endValue - startValue) * progress;
            balanceEl.textContent = `${value.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} LC`;
            if (progress < 1) {
                requestAnimationFrame(animate);
            }
        }
        requestAnimationFrame(animate);
    }

    // --- Context menu para planetas
    function showContextMenu(x, y, dreamId) {
      const menu = document.getElementById('context-menu');
      menu.style.left = `${x}px`; menu.style.top = `${y}px`;
      menu.classList.remove('hidden'); menu.classList.add('flex');

      const hide = () => { menu.classList.add('hidden'); document.removeEventListener('click', onDocClick); };
      const onDocClick = (e) => { if (!menu.contains(e.target)) hide(); };
      setTimeout(() => document.addEventListener('click', onDocClick), 0);

      menu.querySelector('[data-action="edit"]').onclick = () => {
        hide();
        const d = dreams.find(d => d.id === dreamId);
        if (d) showDreamModal(d);
      };
      menu.querySelector('[data-action="delete"]').onclick = async () => {
        hide();
        if (await confirmDialog('¬øEliminar este sue√±o del cosmos?')) {
          await remove('dreams', dreamId);
          dreams = dreams.filter(d => d.id !== dreamId);
          renderCosmos();
          showNotification('Sue√±o eliminado.');
        }
      };
    }
    
    // Auto-Backup Logic
    function initAutoBackup() {
        updateLastBackupInfo();
        setInterval(autoBackup, 5 * 60 * 1000); // Every 5 minutes
    }
    async function autoBackup() {
        console.log('Performing auto-backup...');
        const allData = {};
        for(const storeName of STORES) {
            allData[storeName] = await getAll(storeName);
        }
        const snapshot = {
            meta: { exportedAt: new Date().toISOString(), dbName: DB_NAME, version: DB_VERSION },
            ...allData
        };
        const content = JSON.stringify(snapshot, (key, value) => {
            if (value instanceof Blob) return { _isBlob: true, type: value.type, size: value.size };
            return value;
        });
        localStorage.setItem('mila-universo-autobackup', content);
        updateLastBackupInfo();
        showNotification('Copia de seguridad autom√°tica guardada.');
    }
    function updateLastBackupInfo() {
        const backupData = localStorage.getItem('mila-universo-autobackup');
        const infoEl = document.getElementById('last-backup-info');
        if (backupData) {
            try {
                const parsed = JSON.parse(backupData);
                const date = new Date(parsed.meta.exportedAt);
                infoEl.textContent = `√öltimo auto-backup: ${date.toLocaleString()}`;
            } catch {
                infoEl.textContent = '√öltimo auto-backup: Corrupto';
            }
        } else {
            infoEl.textContent = '√öltimo auto-backup: Nunca';
        }
    }
    async function restoreFromBackup() {
        const backupData = localStorage.getItem('mila-universo-autobackup');
        if (!backupData) {
            showNotification('No se encontr√≥ ninguna copia de seguridad.');
            return;
        }
        if (!await confirmDialog('Restaurar desde el √∫ltimo backup reemplazar√° todos los datos actuales. ¬øContinuar?')) {
            return;
        }
        try {
            const data = JSON.parse(backupData);
            if (!data || !data.meta) throw new Error('Archivo de backup inv√°lido');

            showNotification('Restaurando... Esto puede tardar.');
            await Promise.all(STORES.map(store => clearStore(store)));

            for(const storeName of STORES) {
                if(Array.isArray(data[storeName])) {
                    for (const it of data[storeName]) {
                        await add(storeName, it);
                    }
                }
            }
            showNotification('Universo restaurado ‚úîÔ∏è Recargando...');
            setTimeout(() => window.location.reload(), 1500);
        } catch (err) {
            console.error('Error restaurando:', err);
            showNotification('No se pudo restaurar desde el backup.');
        }
    }


    async function pasteImageFromClipboard() {
        try {
            if (!navigator.clipboard || !navigator.clipboard.read) {
                showNotification('Tu navegador no soporta pegar desde el portapapeles.', 'err');
                return;
            }
            const clipboardItems = await navigator.clipboard.read();
            let foundImage = false;
            for (const item of clipboardItems) {
                const imageType = item.types.find(type => type.startsWith('image/'));
                if (imageType) {
                    const blob = await item.getType(imageType);
                    currentDream.images = [...(currentDream.images || []), { type: blob.type, data: blob }];
                    await update('dreams', currentDream);
                    renderDreamMediaGallery();
                    showNotification('¬°Imagen pegada desde el portapapeles!');
                    foundImage = true;
                    break; 
                }
            }
            if (!foundImage) {
                showNotification('No se encontr√≥ ninguna imagen en el portapapeles.', 'err');
            }
        } catch (error) {
            console.error('Error al pegar desde el portapapeles:', error);
            if (error.name === 'NotAllowedError') {
                showNotification('Se necesita permiso para acceder al portapapeles.', 'err');
            } else {
                showNotification(`Error: ${error.message}`, 'err');
            }
        }
    }

    // --- Numerolog√≠a
    const numerologyCalculator = (() => {
      const tablaNumerologica = { 'A': 1, 'J': 1, 'S': 1, 'B': 2, 'K': 2, 'T': 2, 'C': 3, 'L': 3, 'U': 3, 'D': 4, 'M': 4, 'V': 4, 'E': 5, 'N': 5, 'W': 5, '√ë': 5, 'F': 6, 'O': 6, 'X': 6, 'G': 7, 'P': 7, 'Y': 7, 'H': 8, 'Q': 8, 'Z': 8, 'I': 9, 'R': 9 };
      const vocales = "AEIOU";
      const KARMIC_DEBTS = [13, 14, 16, 19];

      function reducirNumero(numero, esContextoFinal = false) {
        if (typeof numero !== 'number' || isNaN(numero)) return NaN;
        if (esContextoFinal && [11, 22, 33].includes(numero)) return numero;
        let numStr = String(Math.abs(Math.trunc(numero)));
        while (numStr.length > 1) {
          let suma = numStr.split('').reduce((acc, digit) => acc + parseInt(digit), 0);
          if (esContextoFinal && [11, 22, 33].includes(suma)) return suma;
          numero = suma;
          numStr = String(numero);
        }
        return numero;
      }
      function reducirSiempre(numero) {
        if (typeof numero !== 'number' || isNaN(numero)) return NaN;
        let numStr = String(Math.abs(Math.trunc(numero)));
        while (numStr.length > 1) {
          numero = numStr.split('').reduce((acc, digit) => acc + parseInt(digit), 0);
          numStr = String(numero);
        }
        return numero;
      }
      function getValorLetra(letra) {
        if (typeof letra !== 'string' || letra.length !== 1) return 0;
        let lN = letra.toUpperCase().normalize("NFD").replace(/[ÃÄ-ÕØ]/g, "");
        return tablaNumerologica[lN] || 0;
      }
      function calcularDiaNacimiento(fechaObj) {
        const d = fechaObj.getDate();
        let vR = d;
        if (![11, 22].includes(d)) vR = reducirNumero(d, false);
        return { valor: vR, original: d };
      }
      function calcularSenderoVida(fechaObj) {
        const d = fechaObj.getDate();
        const m = fechaObj.getMonth() + 1;
        const a = fechaObj.getFullYear();
        const dR = reducirNumero(d, false);
        const mR = reducirNumero(m, false);
        const aR = reducirNumero(a, false);
        let sT = dR + mR + aR;
        let vF = reducirNumero(sT, true);
        return { valor: vF, original: sT };
      }
      function calcularAnoPersonal(fechaNacimientoObj) {
        const hoy = new Date();
        const anoActual = hoy.getFullYear();
        const diaNac = fechaNacimientoObj.getDate();
        const mesNac = fechaNacimientoObj.getMonth() + 1;
        const sumaDiaMes = reducirNumero(diaNac, false) + reducirNumero(mesNac, false);
        const anoVibracion = reducirNumero(anoActual, false);
        return reducirNumero(sumaDiaMes + anoVibracion, true);
      }
      function calcularMesPersonal(anoPersonal, mesActual) {
        return reducirNumero(anoPersonal + mesActual, true);
      }
      function calcularDiaPersonal(mesPersonal, diaActual) {
        return reducirNumero(mesPersonal + diaActual, true);
      }
      async function calcularDisenoHumano(fecha, hora, lugar) {
        const day = new Date(fecha).getDate();
        const types = ['Generador', 'Generador Manifestante', 'Proyector', 'Manifestador', 'Reflector'];
        const authorities = ['Emocional', 'Sacral', 'del Bazo', 'del Ego', 'Auto-proyectada'];
        return { 
            tipo: types[day % types.length], 
            autoridad: authorities[day % authorities.length], 
            definicion: 'Definici√≥n Dividida' 
        };
      }
      function calcularExpresion(nombre) {
        let sT = nombre.split('').reduce((acc, l) => acc + getValorLetra(l), 0);
        let vF = reducirNumero(sT, true);
        return { valor: vF, original: sT };
      }
      function calcularAlma(nombre) {
        let sT = 0;
        nombre.toUpperCase().split('').forEach(l => {
          let lN = l.normalize("NFD").replace(/[ÃÄ-ÕØ]/g, "");
          if (vocales.includes(lN)) sT += getValorLetra(l);
        });
        let vF = reducirNumero(sT, true);
        return { valor: vF, original: sT };
      }
      function calcularPersonalidad(nombre) {
        let sT = 0;
        nombre.toUpperCase().split('').forEach(l => {
          let lN = l.normalize("NFD").replace(/[ÃÄ-ÕØ]/g, "");
          if (!vocales.includes(lN) && tablaNumerologica[l.toUpperCase()]) sT += getValorLetra(l);
        });
        let vF = reducirNumero(sT, true);
        return { valor: vF, original: sT };
      }
      function calcularDeudasKarmicas(o) {
        const d = new Set();
        if (KARMIC_DEBTS.includes(o.senderoVidaPre)) d.add(o.senderoVidaPre);
        if (KARMIC_DEBTS.includes(o.expresionPre)) d.add(o.expresionPre);
        if (KARMIC_DEBTS.includes(o.almaPre)) d.add(o.almaPre);
        if (KARMIC_DEBTS.includes(o.personalidadPre)) d.add(o.personalidadPre);
        if (KARMIC_DEBTS.includes(o.diaNacimientoOriginal)) d.add(o.diaNacimientoOriginal);
        return Array.from(d).sort((a, b) => a - b);
      }
      function calcularLeccionesKarmicas(nombre) {
        const l = [];
        const nP = new Set();
        nombre.split('').forEach(l => {
          const v = getValorLetra(l);
          if (v > 0) nP.add(reducirSiempre(v));
        });
        for (let i = 1; i <= 9; i++) if (!nP.has(i)) l.push(i);
        return l;
      }
      async function calcularTodo(nombre, alias, fecha, hora, lugar) {
        if (!nombre || !fecha || !hora) return null;
        const [ano, mes, dia] = fecha.split('-').map(Number);
        const [horas, minutos] = hora.split(':').map(Number);
        const f = new Date(ano, mes - 1, dia, horas, minutos);
        if (isNaN(f.getTime())) return null;

        const dN = calcularDiaNacimiento(f);
        const sV = calcularSenderoVida(f);
        const ex = calcularExpresion(nombre);
        const al = calcularAlma(nombre);
        const pe = calcularPersonalidad(nombre);

        const originales = { senderoVidaPre: sV.original, expresionPre: ex.original, almaPre: al.original, personalidadPre: pe.original, diaNacimientoOriginal: dN.original };
        const de = calcularDeudasKarmicas(originales);
        const le = calcularLeccionesKarmicas(nombre);

        const hoy = new Date();
        const anoPersonal = calcularAnoPersonal(f);
        const mesPersonal = calcularMesPersonal(anoPersonal, hoy.getMonth() + 1);
        const diaPersonal = calcularDiaPersonal(mesPersonal, hoy.getDate());

        const disenoHumano = await calcularDisenoHumano(fecha, hora, lugar);

        return {
          senderoVida: sV.valor,
          diaNacimiento: dN,
          expresion: ex.valor,
          alma: al.valor,
          personalidad: pe.valor,
          deudasKarmicas: de,
          leccionesKarmicas: le,
          ciclos: { anoPersonal, mesPersonal, diaPersonal },
          disenoHumano
        };
      }
      return { calcularTodo };
    })();
  </script>
</body>
</html>
